<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="æ­¤ä¸ºç¬”è€…ç¼–è¯‘åŸç†å®éªŒæ‰€åšï¼Œä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚\nç¯å¢ƒï¼šubuntu 22.04\nç›¸å…³é…ç½®: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB\nä¸Šè¿°ç¯å¢ƒä¸è½¯ä»¶é…ç½®è¿™é‡Œä¸åšè¿‡å¤šä»‹ç»\nå®Œæ•´é¡¹ç›®ï¼šZhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.\nä»£ç è§£é‡Šéƒ½åœ¨æ³¨é‡Šä¸­ï¼Œå°±ä¸è´¹ç¯‡å¹…äº†ã€‚\n">
<title>æ‰‹åŠ¨æ­å»ºç¼–è¯‘å™¨  åŸºäºé¾™èŠ¯æ±‡ç¼–ä¸LIGHTIRä¸­é—´ä»£ç </title>

<link rel='canonical' href='http://localhost:1313/p/compiler/'>

<link rel="stylesheet" href="/scss/style.min.79778804a771dc130d7089f1049b111129b334d4d5d3505894a60cd3735cf7b6.css"><meta property='og:title' content="æ‰‹åŠ¨æ­å»ºç¼–è¯‘å™¨  åŸºäºé¾™èŠ¯æ±‡ç¼–ä¸LIGHTIRä¸­é—´ä»£ç ">
<meta property='og:description' content="æ­¤ä¸ºç¬”è€…ç¼–è¯‘åŸç†å®éªŒæ‰€åšï¼Œä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚\nç¯å¢ƒï¼šubuntu 22.04\nç›¸å…³é…ç½®: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB\nä¸Šè¿°ç¯å¢ƒä¸è½¯ä»¶é…ç½®è¿™é‡Œä¸åšè¿‡å¤šä»‹ç»\nå®Œæ•´é¡¹ç›®ï¼šZhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.\nä»£ç è§£é‡Šéƒ½åœ¨æ³¨é‡Šä¸­ï¼Œå°±ä¸è´¹ç¯‡å¹…äº†ã€‚\n">
<meta property='og:url' content='http://localhost:1313/p/compiler/'>
<meta property='og:site_name' content='é™Œè¾å’–å•¡é¦†'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-01-24T17:50:13&#43;08:00'/><meta property='article:modified_time' content='2025-01-24T17:50:13&#43;08:00'/><meta property='og:image' content='http://localhost:1313/post/005.png' />
<meta name="twitter:title" content="æ‰‹åŠ¨æ­å»ºç¼–è¯‘å™¨  åŸºäºé¾™èŠ¯æ±‡ç¼–ä¸LIGHTIRä¸­é—´ä»£ç ">
<meta name="twitter:description" content="æ­¤ä¸ºç¬”è€…ç¼–è¯‘åŸç†å®éªŒæ‰€åšï¼Œä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚\nç¯å¢ƒï¼šubuntu 22.04\nç›¸å…³é…ç½®: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB\nä¸Šè¿°ç¯å¢ƒä¸è½¯ä»¶é…ç½®è¿™é‡Œä¸åšè¿‡å¤šä»‹ç»\nå®Œæ•´é¡¹ç›®ï¼šZhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.\nä»£ç è§£é‡Šéƒ½åœ¨æ³¨é‡Šä¸­ï¼Œå°±ä¸è´¹ç¯‡å¹…äº†ã€‚\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/post/005.png' /><link rel="alternate" type="application/json" href="http://localhost:1313/p/compiler/index.json">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/222_hu15625150182145111778.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">é™Œè¾å’–å•¡é¦†</a></h1>
            <h2 class="site-description">è§‚æˆ‘æ—§å¾€ï¼ŒåŒæˆ‘ä»°æ˜¥</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/Zhuyh1139'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://space.bilibili.com/527591205'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1735383931276" class="icon" viewBox="0 0 1638 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5443" stroke="currentColor" xmlns:xlink="http://www.w3.org/1999/xlink" width="319.921875" height="200"><path d="M1226.1376 379.392c4.1472 0.768 36.7104-6.656 38.0928-4.1472 2.048 3.1232 16.5888 109.1584 12.8 109.824a2040.32 2040.32 0 0 0-30.8224 7.0656c-2.048-14.4384-19.712-103.5776-20.0704-112.6912z m51.9168-10.1376l14.1824 114.0736c7.2704-0.3584 36.7104-2.4576 39.4752-2.816a13869.568 13869.568 0 0 0-11.4176-111.2576 106.9056 106.9056 0 0 0-42.24 0z m-28.0064 158.3104s64-16.4864 87.1936-8.448c11.776 43.2128 33.28 285.3888 35.328 295.2192-14.5408 1.7408-62.3104 5.9392-66.0992 7.0144-3.1232-18.2784-56.4224-282.2144-56.4224-293.7856z m237.1072-145.3056c3.7888 1.024 37.7344-3.5328 38.0928-1.024 0.6656 8.3968 4.096 110.1824 0.3584 110.5408l-30.8224 2.7648c-0.7168-14.0288-8.3456-102.8096-7.6288-112.2816z m52.2752-2.816l2.7648 112.64c7.2704 0 36.352 1.792 39.424 1.4336-0.6656-43.1616 0-111.2576 0-111.2576a188.672 188.672 0 0 0-42.1888-2.816z m-44.6464 151.296s65.4336-8.8064 87.552 1.7408c4.864 50.5344 4.1472 286.0544 4.864 295.8848-14.848 0-62.3104 0.7168-66.0992 1.3824-0.7168-18.2272-27.392-287.4368-26.3168-299.008zM1342.8224 241.152c37.7344 195.1232 66.4576 528.5888 67.4816 549.9904 0 0 29.7472 0.7168 63.3344 2.816-19.712-210.2272-43.9296-546.1504-43.6224-557.056-8.2944-9.4208-87.1936 4.2496-87.1936 4.2496z m-83.0976 461.568c-7.2704-54.784-200.448-116.8896-309.1456-96.8704 0 0-13.5168-120.7808-18.688-237.6192a2458.7264 2458.7264 0 0 1 0.3584-214.1184c-7.2704-5.2736-85.504 32.6144-127.744 48.4352 0 0 50.5344 216.8832 87.2448 666.88 0 0 58.4704 6.2976 158.8736-13.312 100.352-19.6608 219.136-81.1008 209.1008-153.3952z m-236.0832 98.6112l-16.9472-123.904c4.096-2.0992 108.3392 37.2224 119.3984 44.2368-1.7408 7.68-102.4512 79.6672-102.4512 79.6672zM421.632 379.4432c4.1472 0.7168 36.7104-6.656 38.0928-4.1984 2.048 3.1232 16.5888 109.1584 12.8 109.824-3.7888 0.7168-30.8224 7.0656-30.8224 7.0656-2.048-14.4384-19.712-103.5776-20.0704-112.6912z m51.9168-10.1888l14.1824 114.0736c7.2704-0.3584 36.7104-2.4576 39.4752-2.816-4.5056-43.1616-11.4176-111.2576-11.4176-111.2576a106.9568 106.9568 0 0 0-42.24 0z m-28.0064 158.3104s64-16.4864 87.2448-8.448c11.776 43.2128 33.2288 285.3888 35.328 295.2192-14.592 1.7408-62.3616 5.9392-66.1504 7.0144-3.1232-18.2784-56.4224-282.2144-56.4224-293.7856z m237.1072-145.3056c3.7888 1.024 37.7344-3.5328 38.0928-1.024 0.6656 8.3968 4.096 110.1824 0.3584 110.5408l-30.8224 2.7648c-0.7168-14.0288-7.9872-102.8096-7.6288-112.2816z m52.2752-2.816l2.7648 112.64c7.2704 0 36.352 1.792 39.424 1.4336-0.6656-43.1616 0-111.2576 0-111.2576a211.9168 211.9168 0 0 0-42.1888-2.816z m-44.6464 151.296s65.4336-8.8064 87.552 1.7408c4.864 50.5344 4.1984 286.0544 4.864 295.8848-14.848 0-62.3104 0.7168-66.0992 1.3824-0.3584-18.2272-27.392-287.4368-26.3168-299.008zM538.3168 241.152c37.7344 195.1232 66.4576 528.5888 67.4816 549.9904 0 0 29.7984 0.7168 63.3344 2.816-19.712-210.2272-43.9296-546.1504-43.6224-557.3632-8.2944-9.1648-87.1936 4.5568-87.1936 4.5568zM455.168 702.72c-7.2704-54.784-200.448-116.8896-309.1456-96.8704 0 0-13.4656-120.7808-18.688-237.6192a2459.7504 2459.7504 0 0 1 0.3584-214.1184c-7.2704-4.9152-85.504 32.6144-127.744 48.4352 0 0 50.5344 216.8832 87.2448 666.88 0 0 58.4704 6.2976 158.8736-13.312 100.352-19.6608 219.136-81.1008 209.1008-153.3952zM219.136 801.28l-16.9472-123.904c4.096-2.0992 108.3392 37.2224 119.3984 44.2368-1.7408 7.68-102.4512 79.6672-102.4512 79.6672z" fill="currentColor" p-id="5444"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://blog.csdn.net/2301_77127818?spm=1010.2135.3001.5421'
                        target="_blank"
                        title="CSDN"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1735810899052" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5554" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M672.299893 374.246613c-30.004361-6.185886-61.073984-9.064446-91.749634-9.685593-41.186028-0.835018-41.774429 0.635473-46.343491 40.450271-5.634324 49.097208-10.223852 98.314143-15.640212 151.144372 31.054273 0.64673 60.628846 2.199085 90.162486 1.626034 32.461319-0.629333 63.944358-6.411013 90.443895-27.424606 29.843702-23.666002 39.58967-55.474452 34.120099-91.764983C728.039381 403.724994 705.951317 381.184629 672.299893 374.246613zM657.900951 500.909407c-23.899316 18.074657-51.306526 20.665669-82.688257 16.613376 3.77907-38.039361 7.468089-75.166957 11.500938-115.768677 18.166755 1.276063 34.453696 1.294482 50.341548 3.818979 20.170388 3.204995 36.021401 13.485129 40.776705 34.985816C683.099866 464.37533 678.124552 485.615073 657.900951 500.909407zM503.672334 369.780905c-1.798972 13.027711-3.473101 25.15082-5.205559 37.702694-25.127284-2.170432-49.036833-5.149277-73.019037-5.934153-12.665461-0.414439-25.856901 1.651616-38.011732 5.276167-5.569856 1.660826-9.213849 9.779737-13.731746 14.969946 4.811586 4.14132 8.978489 10.243295 14.548344 12.07092 20.290115 6.65763 41.37534 10.943236 61.541635 17.912975 21.155832 7.312546 42.117237 17.118889 43.12417 43.801599 1.025353 27.151383-17.099447 42.173518-39.515992 51.339272-49.971112 20.434401-101.250008 18.301831-152.551418 5.27412-2.898003-0.735757-6.615675-6.172583-6.522554-9.320273 0.313132-10.570753 2.179642-21.095457 3.244904-29.927613 30.601972 2.39556 60.002582 5.354961 89.476871 6.611581 9.122775 0.388856 19.11229-2.468215 27.425629-6.486738 5.1503-2.489704 10.989285-10.093892 10.780531-15.165398-0.184195-4.474918-7.630794-10.624988-13.091156-12.520151-13.767562-4.780887-28.474518-6.819313-42.334177-11.387351-13.833053-4.558829-27.958772-9.378601-40.431851-16.687054-29.591969-17.339924-31.312146-47.346331-4.841262-69.316715 20.354584-16.893762 44.992727-22.240537 70.433142-25.527396C426.702312 358.37104 479.267505 361.432773 503.672334 369.780905zM959.473381 445.082938c-2.599198 35.797297-7.000438 71.464635-10.664897 107.833961-19.322068 0-37.140898 0-57.091276 0 3.668553-34.127262 6.729262-67.476811 10.968819-100.67491 4.237511-33.18275-7.367805-47.762817-40.654932-48.962132-40.755216-1.468444-40.883129-1.482771-45.26595 38.807864-3.950985 36.326347-7.580652 72.687486-11.507078 110.530372-19.435655 0-37.172621 0-55.32812 0 5.699816-58.20361 11.107989-115.27749 17.277502-172.269505 0.410346-3.78828 6.15007-9.250688 10.17985-10.045797 38.780235-7.6574 77.796854-12.57848 117.373221-6.016017C941.27081 371.999432 962.885084 398.084531 959.473381 445.082938zM251.989151 359.040283c11.636015 0.905626 23.165606 3.169179 35.938514 4.976338-1.662873 15.230889-3.163039 28.963659-4.333702 39.687908-30.569226 0-58.112536-1.639337-85.379553 0.411369-34.80469 2.616594-56.879452 20.388353-63.36926 46.690392-8.036024 32.567743 5.16258 57.6807 38.144762 63.129806 25.119097 4.149507 51.359738 1.601474 77.102029 1.802042 4.854565 0.037862 9.718339-1.010003 13.933337-1.483794 1.093914 1.38044 1.75804 1.827625 1.74883 2.260483-0.845251 41.947368-0.855484 43.796482-42.837644 43.626613-31.178093-0.125867-63.113433-2.62171-93.28971-9.93221-33.339316-8.077979-58.892295-29.67588-64.336284-66.284659-5.77554-38.832424 10.547217-69.608358 41.553395-91.998297C150.319587 360.548636 200.264093 355.014596 251.989151 359.040283z" p-id="5555"></path><path d="M137.883347 595.666538l-1.199315 1.499144c6.715959 8.794293 15.628956 15.409968 26.742061 19.847024-1.239224 1.759063-2.298346 3.357468-3.177366 4.797259-10.553357-5.196349-19.407002-12.172227-26.561959-20.925588-6.116301 7.91425-15.150048 15.150048-27.101241 21.705348-0.799202-1.358951-1.798972-2.858094-2.998287-4.497431 12.351306-6.196119 21.684882-13.670348 28.000728-22.424732L137.883347 595.667561zM106.34505 646.871757l24.762987 0 0-10.432607-19.426445 0 0-4.376681 19.426445 0 0-9.233292-17.207917 0 0-4.376681 39.45357 0 0 4.376681-17.268292 0 0 9.233292 19.48682 0 0 4.376681-19.48682 0 0 10.432607 24.703635 0 0 4.437056-54.44296 0L106.346073 646.871757zM195.804525 642.434701c2.698458-0.279363 5.536087-0.60989 8.513908-0.989537l0-18.138102-7.374968 0 0-4.317329 7.374968 0 0-14.090926-8.154727 0 0-4.317329 20.506033 0 0 4.317329-7.974625 0 0 14.090926 6.955412 0 0 4.317329-6.955412 0 0 17.568121c2.39863-0.339738 4.876054-0.699941 7.435343-1.079588-0.160659 1.599428-0.25992 3.137457-0.299829 4.617158-7.475252 0.959861-13.950733 1.858324-19.426445 2.698458L195.804525 642.434701zM216.430284 638.536928c5.216815-3.177366 10.673084-6.715959 16.368806-10.612709L232.79909 610.476849l-15.349593 0 0-4.317329 15.349593 0 0-10.673084 4.556783 0 0 10.673084 17.028838 0 0 4.317329-17.028838 0 0 5.336542c0.99977 3.27765 2.168386 6.315846 3.507894 9.113565 3.457752-3.357468 6.345522-6.456039 8.664334-9.293667l3.897773 3.298116c-3.298116 3.258207-6.804986 6.5553-10.522658 9.893324 3.477194 6.016017 7.804756 10.673084 12.981662 13.970176-0.239454 0.360204-0.760317 0.979304-1.558495 1.858324-0.880043 0.918929-1.499144 1.639337-1.858324 2.158153-6.5553-4.736884-11.592013-11.552104-15.110139-20.445658l0 19.367093c0 4.756327-2.478448 7.135514-7.435343 7.135514-1.959631 0-4.057409-0.020466-6.29538-0.060375-0.239454-1.518586-0.559748-3.157923-0.959861-4.916986 2.357697 0.279363 4.497431 0.419556 6.41613 0.419556 2.477424 0 3.717671-1.218758 3.717671-3.657296l0-11.422144c-4.137227 2.87856-8.593725 6.085602-13.370519 9.623171L216.430284 638.536928zM217.749326 616.891955l3.657296-2.218528c2.598174 3.397377 5.175883 7.154957 7.735172 11.272741l-3.837398 2.638083C222.545562 623.907743 220.028229 620.009969 217.749326 616.891955zM240.593614 599.024006l2.638083-2.998287c2.837628 1.87879 5.435803 3.816932 7.794523 5.816472l-2.87856 3.298116C245.789962 602.941222 243.271606 600.902796 240.593614 599.024006zM288.621467 646.152373c1.958608-0.199545 3.917216-0.409322 5.875824-0.629333l0-22.814612-6.595208 0 0-3.597945 59.419298 0 0 3.597945-31.298843 0 0 19.996426c1.918699-0.279363 3.837398-0.569982 5.756097-0.86981-0.040932 0.719384-0.020466 1.998517 0.060375 3.837398-1.87879 0.25992-3.817955 0.530073-5.816472 0.809435l0 7.645121-4.076852 0 0-7.045463c-6.875594 0.979304-14.290471 2.088568-22.24463 3.327792L288.621467 646.152373zM296.955272 597.405135l41.491996 0 0 19.247366-4.197602 0 0-1.379417L301.152874 615.273085l0 1.379417-4.197602 0L296.955272 597.405135zM298.574143 627.504664l13.370519 0 0-4.797259L298.574143 622.707404 298.574143 627.504664zM298.574143 635.779118l13.370519 0 0-4.797259L298.574143 630.981858 298.574143 635.779118zM311.945685 643.304512l0-4.047176L298.574143 639.257336l0 5.785773C303.091016 644.502803 307.548538 643.923612 311.945685 643.304512zM334.25069 600.883353 301.152874 600.883353l0 3.837398 33.097816 0L334.25069 600.883353zM301.152874 611.79589l33.097816 0 0-3.837398L301.152874 607.958492 301.152874 611.79589zM319.020824 630.442576l0-3.477194 23.804149 0 0 3.477194c-2.038426 4.89652-4.717442 9.153474-8.035 12.770861 3.417843 2.49789 7.65433 4.397147 12.71151 5.695722-1.039679 1.518586-1.939165 2.918469-2.698458 4.197602-5.15644-1.698688-9.503445-3.997034-13.041014-6.895037-3.437286 3.078105-7.445576 5.596462-12.021801 7.55507-0.679475-1.199315-1.599428-2.457981-2.75781-3.777023 4.53734-1.738597 8.443299-3.957125 11.721973-6.655584-3.338025-3.577478-5.716188-7.874341-7.135514-12.891611L319.020824 630.442576zM338.267167 630.442576l-12.651135 0c1.258667 3.937682 3.28686 7.305383 6.085602 10.103102C334.479911 637.628232 336.667739 634.260531 338.267167 630.442576zM379.939265 649.149637c16.488533-7.335059 25.382087-18.34788 26.681686-33.037441l-25.603121 0 0-4.676509 25.812899 0c0.100284-5.376451 0.149403-10.79281 0.149403-16.249079l5.216815 0c0 5.376451-0.050142 10.79281-0.149403 16.249079l26.591635 0 0 4.676509-26.681686 0c2.837628 15.968693 12.151761 26.501584 27.941376 31.598672-2.038426 1.958608-3.558036 3.577478-4.556783 4.856611-13.011338-5.236258-21.515013-14.560624-25.51307-27.971052-3.118014 12.131295-11.841699 21.85475-26.172079 29.170366C382.857734 652.688229 381.618511 651.149177 379.939265 649.149637zM476.234425 607.77839l23.084765 0 0-13.07069 5.15644 0 0 13.07069 23.324218 0 0 27.341718-4.916986 0 0-3.237741-18.407232 0 0 22.305005-5.15644 0 0-22.305005-18.167778 0 0 3.237741-4.916986 0L476.234425 607.77839zM481.150388 627.445312l18.167778 0 0-15.229866-18.167778 0L481.150388 627.445312zM522.882861 612.215446l-18.407232 0 0 15.229866 18.407232 0L522.882861 612.215446zM565.153594 605.199659l28.780487 0c-2.018983-3.837398-3.597945-6.635117-4.736884-8.394181l4.617158-2.158153c1.119497 1.719154 2.797719 4.516874 5.036713 8.394181l-4.317329 2.158153 28.180829 0 0 4.437056-11.062963 0c-2.13871 11.411911-6.735401 20.585851-13.791098 27.52182 5.316076 3.877307 13.760398 7.355525 25.332968 10.432607-1.838881 2.078335-3.237741 3.816932-4.197602 5.216815-11.272741-3.897773-19.596314-7.974625-24.972764-12.231579-5.395894 4.197602-14.020318 8.43409-25.872251 12.71151-1.039679-1.39886-2.238994-2.958378-3.597945-4.676509 11.432377-3.437286 20.036335-7.265474 25.812899-11.482519-7.29515-7.794523-11.93175-16.95823-13.910824-27.491121l-11.302417 0L565.152571 605.199659zM606.525863 609.636714l-25.272593 0c1.798972 9.832949 6.095835 17.958 12.891611 24.373107C600.639806 627.974361 604.7668 619.850333 606.525863 609.636714zM671.851685 604.50995l-4.466732 0 0 36.305881 4.466732 0 0 5.066389-14.930037 0 0-5.066389 4.466732 0 0-36.305881-4.466732 0 0-5.066389 14.930037 0L671.851685 604.50995zM738.196719 604.780103l-13.401218 0 0 41.102117-6.02625 0 0-41.102117-13.340843 0 0-5.336542 32.767288 0L738.195695 604.780103zM771.71409 611.496062l0-4.317329 19.48682 0 0 4.437056c-1.939165 3.877307-4.237511 7.544837-6.895037 11.002588l0 30.908964-4.676509 0 0-25.482371c-2.198062 2.318812-4.577249 4.516874-7.135514 6.595208-0.360204-1.438769-0.918929-3.097548-1.679245-4.976338 6.15621-4.956895 11.252275-11.012821 15.289218-18.167778L771.71409 611.496062zM777.649266 597.105307l4.197602-2.098801c1.478677 2.358721 3.038196 5.096065 4.676509 8.214079l-4.437056 2.278903C780.527826 602.261747 779.049149 599.464027 777.649266 597.105307zM785.024234 625.946168l3.118014-2.578732c2.438539 2.717901 4.657067 5.296633 6.655584 7.735172l-3.717671 2.937912C789.161461 631.28271 787.143501 628.584252 785.024234 625.946168zM791.20091 646.991484l16.848737 0 0-29.380144-14.270005 0 0-4.676509 14.270005 0 0-17.568121 4.797259 0 0 17.568121 15.229866 0 0 4.676509-15.229866 0 0 29.380144 17.028838 0 0 4.676509-38.673811 0L791.201933 646.991484zM867.8885 599.143733l51.565423 0 0 4.676509-46.468334 0 0 41.851177 47.428196 0 0 4.556783-52.524261 0L867.889523 599.143733zM877.601722 610.416474l3.357468-3.177366c4.996804 4.116761 10.222829 8.634658 15.679098 13.550621 4.177136-4.516874 8.184403-9.43386 12.021801-14.749936l4.376681 2.937912c-4.197602 5.436826-8.454556 10.472516-12.770861 15.110139 4.976338 4.53734 10.132778 9.393951 15.46932 14.569834l-4.137227 4.197602c-4.837168-5.056156-9.813506-10.05296-14.930037-14.989389-5.776563 5.856381-11.652388 11.012821-17.628496 15.46932-0.959861-1.239224-2.238994-2.537799-3.837398-3.897773 6.275937-4.27742 12.241812-9.263991 17.897625-14.959713C888.084471 619.739816 882.918821 615.053074 877.601722 610.416474z" fill="currentColor" p-id="5556"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>é¦–é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#mem2reg">MEM2REG</a></li>
    <li><a href="#å¾ªç¯ä¸å˜é‡å¤–æ">å¾ªç¯ä¸å˜é‡å¤–æ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/compiler/">
                
                    <img src="/post/005.png" loading="lazy" alt="Featured image of post æ‰‹åŠ¨æ­å»ºç¼–è¯‘å™¨  åŸºäºé¾™èŠ¯æ±‡ç¼–ä¸LIGHTIRä¸­é—´ä»£ç " />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" >
                ç¼–è¯‘åŸç†
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/compiler/">æ‰‹åŠ¨æ­å»ºç¼–è¯‘å™¨  åŸºäºé¾™èŠ¯æ±‡ç¼–ä¸LIGHTIRä¸­é—´ä»£ç </a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 24, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 41 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>æ­¤ä¸ºç¬”è€…ç¼–è¯‘åŸç†å®éªŒæ‰€åšï¼Œä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚</p>
<blockquote>
<p>ç¯å¢ƒï¼šubuntu 22.04</p>
<p>ç›¸å…³é…ç½®: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB</p>
<p>ä¸Šè¿°ç¯å¢ƒä¸è½¯ä»¶é…ç½®è¿™é‡Œä¸åšè¿‡å¤šä»‹ç»</p>
</blockquote>
<p>å®Œæ•´é¡¹ç›®ï¼š<a class="link" href="https://github.com/Zhuyh1139/Compiler"  target="_blank" rel="noopener"
    >Zhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.</a></p>
<p>ä»£ç è§£é‡Šéƒ½åœ¨æ³¨é‡Šä¸­ï¼Œå°±ä¸è´¹ç¯‡å¹…äº†ã€‚</p>
<h1 id="è¯æ³•åˆ†æå™¨">è¯æ³•åˆ†æå™¨
</h1><p>å³ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„å½¢å¼å°†Cminusfè¿›è¡Œåˆ†è¯æ“ä½œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">%</span><span class="n">option</span> <span class="n">noyywrap</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*****************å£°æ˜å’Œé€‰é¡¹è®¾ç½®  begin*****************/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;syntax_tree.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;syntax_analyzer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">lines</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pos_start</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pos_end</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">pass_node</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">     <span class="n">yylval</span><span class="p">.</span><span class="n">node</span> <span class="o">=</span> <span class="nf">new_syntax_tree_node</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*****************å£°æ˜å’Œé€‰é¡¹è®¾ç½®  end*****************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">x</span> <span class="n">COMMENT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span><span class="line"><span class="cl"> <span class="cm">/* to do for students */</span>
</span></span><span class="line"><span class="cl"> <span class="cm">/* two cases for you, pass_node will send flex&#39;s token to bison */</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">+</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">ADD</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="cm">/****è¯·åœ¨æ­¤è¡¥å…¨æ‰€æœ‰flexçš„æ¨¡å¼ä¸åŠ¨ä½œ  end******/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">-</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">SUB</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">*</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">MUL</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">/</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">DIV</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&lt;</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&lt;=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LTE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&gt;</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">GT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&gt;=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">GTE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">EQ</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">!=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">NEQ</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">ASSIN</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">SEMICOLON</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">,</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">COMMA</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">(</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LPARENTHESE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">)</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RPARENTHESE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">[</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LBRACKET</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">]</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RBRACKET</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">{</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LBRACE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">}</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RBRACE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">ELSE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">IF</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">INT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span>   <span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">FLOAT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RETURN</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">VOID</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">WHILE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">IDENTIFIER</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">INTEGER</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="err">\</span><span class="p">.[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">*|</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="err">\</span><span class="p">.[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span> <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">FLOATPOINT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="n">n</span> 	<span class="p">{</span><span class="n">lines</span><span class="o">++</span><span class="p">;</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="err">\</span><span class="n">t</span><span class="p">]</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;/*&#34;</span>             <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="n">COMMENT</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">COMMENT</span><span class="o">&gt;</span><span class="s">&#34;*/&#34;</span>    <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="n">INITIAL</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">COMMENT</span><span class="o">&gt;</span><span class="p">.</span>  <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_start</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">COMMENT</span><span class="o">&gt;</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">lines</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span> <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span><span class="o">++</span><span class="p">;</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä½œç”¨ä¸ºï¼š</p>
<p>æ–‡æœ¬è¾“å…¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Token</span>         <span class="n">Text</span>      <span class="n">Line</span>    <span class="nf">Column</span> <span class="p">(</span><span class="n">Start</span><span class="p">,</span><span class="n">End</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">282</span>           <span class="kt">void</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">284</span>           <span class="n">main</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">272</span>              <span class="p">(</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">282</span>           <span class="kt">void</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">273</span>              <span class="p">)</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">276</span>              <span class="p">{</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">281</span>         <span class="k">return</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">270</span>              <span class="p">;</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">277</span>              <span class="p">}</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="è¯­æ³•åˆ†æå™¨">è¯­æ³•åˆ†æå™¨
</h1><p>Cminusfçš„è¯­æ³•å’ŒCçš„è¯­æ³•å¤§è‡´ç›¸åŒï¼š</p>
<ol>
<li>programâ†’declaration-listprogramâ†’declaration-list</li>
<li>declaration-listâ†’declaration-list declaration âˆ£ declarationdeclaration-listâ†’declaration-list declaration âˆ£ declaration</li>
<li>declarationâ†’var-declaration âˆ£ fun-declarationdeclarationâ†’var-declaration âˆ£ fun-declaration</li>
<li>var-declaration â†’type-specifier IDâ€¾ ;â€¾ âˆ£ type-specifier IDâ€¾ [â€¾ INTEGERâ€¾ ]â€¾ ;â€¾var-declaration â†’type-specifier <strong>ID</strong> <strong>;</strong> âˆ£ type-specifier <strong>ID</strong> <strong>[</strong> <strong>INTEGER</strong> <strong>]</strong> <strong>;</strong></li>
<li>type-specifierâ†’intâ€¾ âˆ£ floatâ€¾ âˆ£ voidâ€¾type-specifierâ†’<strong>int</strong> âˆ£ <strong>float</strong> âˆ£ <strong>void</strong></li>
<li>fun-declarationâ†’type-specifier IDâ€¾ (â€¾ params )â€¾ compound-stmtfun-declarationâ†’type-specifier <strong>ID</strong> <strong>(</strong> params <strong>)</strong> compound-stmt</li>
<li>paramsâ†’param-list âˆ£ voidâ€¾paramsâ†’param-list âˆ£ <strong>void</strong></li>
<li>param-listâ†’param-list ,â€¾ param âˆ£ paramparam-listâ†’param-list <strong>,</strong> param âˆ£ param</li>
<li>paramâ†’type-specifier IDâ€¾ âˆ£ type-specifier IDâ€¾ [â€¾ ]â€¾paramâ†’type-specifier <strong>ID</strong> âˆ£ type-specifier <strong>ID</strong> <strong>[</strong> <strong>]</strong></li>
<li>compound-stmtâ†’{â€¾ local-declarations statement-list }â€¾compound-stmtâ†’<strong>{</strong> local-declarations statement-list <strong>}</strong></li>
<li>local-declarationsâ†’local-declarations var-declaration âˆ£ emptylocal-declarationsâ†’local-declarations var-declaration âˆ£ empty</li>
<li>statement-listâ†’statement-list statement âˆ£ emptystatement-listâ†’statement-list statement âˆ£ empty</li>
<li>statementâ†’ expression-stmtâˆ£ compound-stmtâˆ£ selection-stmtâˆ£ iteration-stmtâˆ£ return-stmtstatementâ†’ expression-stmtâˆ£ compound-stmtâˆ£ selection-stmtâˆ£ iteration-stmtâˆ£ return-stmt</li>
<li>expression-stmtâ†’expression ;â€¾ âˆ£ ;â€¾expression-stmtâ†’expression <strong>;</strong> âˆ£ <strong>;</strong></li>
<li>selection-stmtâ†’ ifâ€¾ (â€¾ expression )â€¾ statementâˆ£ ifâ€¾ (â€¾ expression )â€¾ statement elseâ€¾ statementselection-stmtâ†’ <strong>if</strong> <strong>(</strong> expression <strong>)</strong> statementâˆ£ <strong>if</strong> <strong>(</strong> expression <strong>)</strong> statement <strong>else</strong> statement</li>
<li>iteration-stmtâ†’whileâ€¾ (â€¾ expression )â€¾ statementiteration-stmtâ†’<strong>while</strong> <strong>(</strong> expression <strong>)</strong> statement</li>
<li>return-stmtâ†’returnâ€¾ ;â€¾ âˆ£ returnâ€¾ expression ;â€¾return-stmtâ†’<strong>return</strong> <strong>;</strong> âˆ£ <strong>return</strong> expression <strong>;</strong></li>
<li>expressionâ†’var =â€¾ expression âˆ£ simple-expressionexpressionâ†’var <strong>=</strong> expression âˆ£ simple-expression</li>
<li>varâ†’IDâ€¾ âˆ£ IDâ€¾ [â€¾ expression]â€¾varâ†’<strong>ID</strong> âˆ£ <strong>ID</strong> <strong>[</strong> expression**]**</li>
<li>simple-expressionâ†’additive-expression relop additive-expression âˆ£ additive-expressionsimple-expressionâ†’additive-expression relop additive-expression âˆ£ additive-expression</li>
<li>relop â†’&lt;=â€¾ âˆ£ &lt;â€¾ âˆ£ &gt;â€¾ âˆ£ &gt;=â€¾ âˆ£ ==â€¾ âˆ£ !=â€¾relop â†’<strong>&lt;=</strong> âˆ£ <strong>&lt;</strong> âˆ£ <strong>&gt;</strong> âˆ£ <strong>&gt;=</strong> âˆ£ <strong>==</strong> âˆ£ <strong>!=</strong></li>
<li>additive-expressionâ†’additive-expression addop term âˆ£ termadditive-expressionâ†’additive-expression addop term âˆ£ term</li>
<li>addopâ†’+â€¾ âˆ£ -â€¾addopâ†’<strong>+</strong> âˆ£ <strong>-</strong></li>
<li>termâ†’term mulop factor âˆ£ factortermâ†’term mulop factor âˆ£ factor</li>
<li>mulopâ†’*â€¾ âˆ£ /â€¾mulopâ†’***** âˆ£ <strong>/</strong></li>
<li>factorâ†’(â€¾ expression )â€¾ âˆ£ var âˆ£ call âˆ£ integer âˆ£ floatfactorâ†’<strong>(</strong> expression <strong>)</strong> âˆ£ var âˆ£ call âˆ£ integer âˆ£ float</li>
<li>integerâ†’INTEGERâ€¾integerâ†’<strong>INTEGER</strong></li>
<li>floatâ†’FLOATPOINTâ€¾floatâ†’<strong>FLOATPOINT</strong></li>
<li>callâ†’IDâ€¾ (â€¾ args)â€¾callâ†’<strong>ID</strong> <strong>(</strong> args**)**</li>
<li>argsâ†’arg-list âˆ£ emptyargsâ†’arg-list âˆ£ empty</li>
<li>arg-listâ†’arg-list ,â€¾ expression âˆ£ expressionarg-listâ†’arg-list <strong>,</strong> expression âˆ£ expression</li>
</ol>
<p>è¯­æ³•åˆ†æå™¨å¯å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p>
<p>è¾“å…¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºè¯­æ³•æ ‘ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&gt;--+ program
</span></span><span class="line"><span class="cl">|  &gt;--+ declaration-list
</span></span><span class="line"><span class="cl">|  |  &gt;--+ declaration
</span></span><span class="line"><span class="cl">|  |  |  &gt;--+ fun-declaration
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--+ type-specifier
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* int
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--* main
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--* (
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--+ params
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* void
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--* )
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--+ compound-stmt
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* {
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--+ local-declarations
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  &gt;--* epsilon
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--+ statement-list
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  &gt;--+ statement-list
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  &gt;--* epsilon
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  &gt;--+ statement
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  &gt;--+ return-stmt
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  &gt;--* return
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  &gt;--+ expression
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  &gt;--+ simple-expression
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  &gt;--+ additive-expression
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  &gt;--+ term
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  |  &gt;--+ factor
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  |  |  &gt;--+ integer
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  |  |  |  &gt;--* 0
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  &gt;--* ;
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* }
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">%</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;syntax_tree.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// external functions from lex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">int</span> <span class="nf">yylex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">yyparse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">yyrestart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">FILE</span> <span class="o">*</span> <span class="n">yyin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// external variables from lexical_analyzer module
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="n">pos_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="n">pos_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Global syntax tree
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree</span> <span class="o">*</span><span class="n">gt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Error reporting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">yyerror</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Helper functions written for you with love
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree_node</span> <span class="o">*</span><span class="nf">node</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">node_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">children_num</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* TODO: Complete this definition. */</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">struct</span> <span class="n">_syntax_tree_node</span> <span class="o">*</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	 <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* TODO: Your tokens here. */</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ERROR</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ADD</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">SUB</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">MUL</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">DIV</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LTE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">GT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">GTE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">EQ</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">NEQ</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ASSIN</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">SEMICOLON</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">COMMA</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LPARENTHESE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RPARENTHESE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LBRACKET</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RBRACKET</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LBRACE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RBRACE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ELSE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">IF</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">INT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RETURN</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">VOID</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">WHILE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">IDENTIFIER</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">INTEGER</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">FLOAT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">FLOATPOINT</span>	<span class="c1">// è¿™ä¸ªæ˜¯ float ç±»å‹çš„ token
</span></span></span><span class="line"><span class="cl"><span class="c1">//%token &lt;node&gt; EOL
</span></span></span><span class="line"><span class="cl"><span class="c1">//%token &lt;node&gt; BLANK
</span></span></span><span class="line"><span class="cl"><span class="c1">//%token &lt;node&gt; COMMENT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">%</span><span class="n">type</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">program</span> <span class="n">declaration</span><span class="o">-</span><span class="n">list</span> <span class="n">declaration</span> <span class="n">var</span><span class="o">-</span><span class="n">declaration</span> <span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">fun</span><span class="o">-</span><span class="n">declaration</span> <span class="n">params</span> <span class="n">param</span><span class="o">-</span><span class="n">list</span> <span class="n">param</span> <span class="n">compound</span><span class="o">-</span><span class="n">stmt</span> <span class="n">local</span><span class="o">-</span><span class="n">declarations</span> <span class="n">statement</span><span class="o">-</span><span class="n">list</span> <span class="n">statement</span> <span class="n">expression</span><span class="o">-</span><span class="n">stmt</span> <span class="n">selection</span><span class="o">-</span><span class="n">stmt</span> <span class="n">iteration</span><span class="o">-</span><span class="n">stmt</span> <span class="k">return</span><span class="o">-</span><span class="n">stmt</span> <span class="n">expression</span> <span class="n">var</span> <span class="n">simple</span><span class="o">-</span><span class="n">expression</span> <span class="n">relop</span> <span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="n">addop</span> <span class="n">term</span> <span class="n">mulop</span> <span class="n">factor</span> <span class="n">integer</span> <span class="kt">float</span> <span class="n">call</span> <span class="n">args</span> <span class="n">arg</span><span class="o">-</span><span class="n">list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* compulsory starting symbol */</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">start</span> <span class="n">program</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* TODO: Your rules here. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">program</span> <span class="p">:</span> 	<span class="n">declaration</span><span class="o">-</span><span class="n">list</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;program&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="err">$$</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">declaration</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">declaration</span><span class="o">-</span><span class="n">list</span> <span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration-list&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="o">|</span>	<span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration-list&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">declaration</span> <span class="p">:</span> 	<span class="n">var</span><span class="o">-</span><span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">fun</span><span class="o">-</span><span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">var</span><span class="o">-</span><span class="nl">declaration</span> <span class="p">:</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var-declaration&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">                <span class="o">|</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">LBRACKET</span> <span class="n">INTEGER</span> <span class="n">RBRACKET</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var-declaration&#34;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">6</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">                <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span><span class="o">-</span><span class="nl">specifier</span> 	<span class="p">:</span> 	<span class="n">INT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;type-specifier&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">FLOAT</span> <span class="p">{</span> <span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;type-specifier&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">VOID</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;type-specifier&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fun</span><span class="o">-</span><span class="nl">declaration</span> <span class="p">:</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">LPARENTHESE</span> <span class="n">params</span> <span class="n">RPARENTHESE</span> <span class="n">compound</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;fun-declaration&#34;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">6</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">params</span> 	<span class="p">:</span> 	<span class="n">param</span><span class="o">-</span><span class="n">list</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;params&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">VOID</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;params&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">param</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">param</span><span class="o">-</span><span class="n">list</span> <span class="n">COMMA</span> <span class="n">param</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param-list&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">param</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param-list&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">param</span> 	<span class="p">:</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">LBRACKET</span> <span class="n">RBRACKET</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">compound</span><span class="o">-</span><span class="nl">stmt</span> 	<span class="p">:</span> 	<span class="n">LBRACE</span> <span class="n">local</span><span class="o">-</span><span class="n">declarations</span> <span class="n">statement</span><span class="o">-</span><span class="n">list</span> <span class="n">RBRACE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;compound-stmt&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">local</span><span class="o">-</span><span class="nl">declarations</span> 	<span class="p">:</span> 	<span class="n">local</span><span class="o">-</span><span class="n">declarations</span> <span class="n">var</span><span class="o">-</span><span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;local-declarations&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> 	<span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;local-declarations&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">statement</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">statement</span><span class="o">-</span><span class="n">list</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement-list&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> 	<span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement-list&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">statement</span> 	<span class="p">:</span> 	<span class="n">expression</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> 	<span class="n">compound</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">selection</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">iteration</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="k">return</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">expression</span><span class="o">-</span><span class="nl">stmt</span> <span class="p">:</span> 	<span class="n">expression</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression-stmt&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression-stmt&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">selection</span><span class="o">-</span><span class="nl">stmt</span> 	<span class="p">:</span> 	<span class="n">IF</span> <span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;selection-stmt&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">IF</span> <span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="n">statement</span> <span class="n">ELSE</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;selection-stmt&#34;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">6</span><span class="p">,</span> <span class="err">$</span><span class="mi">7</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">iteration</span><span class="o">-</span><span class="nl">stmt</span> 	<span class="p">:</span> 	<span class="n">WHILE</span> <span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;iteration-stmt&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span><span class="o">-</span><span class="nl">stmt</span> <span class="p">:</span> 	<span class="n">RETURN</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;return-stmt&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">RETURN</span> <span class="n">expression</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;return-stmt&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">expression</span> 	<span class="p">:</span> 	<span class="n">var</span> <span class="n">ASSIN</span> <span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">simple</span><span class="o">-</span><span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">var</span> <span class="p">:</span> 	<span class="n">IDENTIFIER</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> 	<span class="n">IDENTIFIER</span> <span class="n">LBRACKET</span> <span class="n">expression</span> <span class="n">RBRACKET</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">simple</span><span class="o">-</span><span class="nl">expression</span> 	<span class="p">:</span> 	<span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="n">relop</span> <span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;simple-expression&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="o">|</span> 	<span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;simple-expression&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">relop</span> 	<span class="p">:</span> 	<span class="n">LT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">LTE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">GT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">GTE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">EQ</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">NEQ</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">additive</span><span class="o">-</span><span class="nl">expression</span> <span class="p">:</span> 	<span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="n">addop</span> <span class="n">term</span>  <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;additive-expression&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="o">|</span> 	<span class="n">term</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;additive-expression&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">addop</span> 	<span class="p">:</span> 	<span class="n">ADD</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;addop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">SUB</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;addop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">term</span> 	<span class="p">:</span> 	<span class="n">term</span> <span class="n">mulop</span> <span class="n">factor</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;term&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">factor</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;term&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">mulop</span> 	<span class="p">:</span> 	<span class="n">MUL</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;mulop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">DIV</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;mulop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">factor</span> 	<span class="p">:</span> 	<span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">var</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">call</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">integer</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="kt">float</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">integer</span> 	<span class="p">:</span> 	<span class="n">INTEGER</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;integer&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">float</span> 	<span class="o">:</span> 	<span class="n">FLOATPOINT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;float&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">call</span> 	<span class="p">:</span> 	<span class="n">IDENTIFIER</span> <span class="n">LPARENTHESE</span> <span class="n">args</span> <span class="n">RPARENTHESE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;call&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">args</span> 	<span class="p">:</span> 	<span class="n">arg</span><span class="o">-</span><span class="n">list</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;args&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> 	<span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;args&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">arg</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">arg</span><span class="o">-</span><span class="n">list</span> <span class="n">COMMA</span> <span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;arg-list&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;arg-list&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// The error reporting function.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">yyerror</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TO STUDENTS: This is just an example.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// You can customize it as you like.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;error at line %d column %d: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">pos_start</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// Parse input from file `input_path`, and prints the parsing results
</span></span></span><span class="line"><span class="cl"><span class="c1">/// to stdout.  If input_path is NULL, read from stdin.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This function initializes essential states before running yyparse().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree</span> <span class="o">*</span><span class="nf">parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">input_path</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">yyin</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;[ERR] Open input file %s failed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">input_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">yyin</span> <span class="o">=</span> <span class="n">stdin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gt</span> <span class="o">=</span> <span class="nf">new_syntax_tree</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">yyrestart</span><span class="p">(</span><span class="n">yyin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">yyparse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">gt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// A helper function to quickly construct a tree node.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// e.g. $$ = node(&#34;program&#34;, 1, $1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree_node</span> <span class="o">*</span><span class="nf">node</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">children_num</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">syntax_tree_node</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nf">new_syntax_tree_node</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">syntax_tree_node</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è¿™é‡Œè¡¨ç¤º epsilonç»“ç‚¹æ˜¯é€šè¿‡ children_num == 0 æ¥åˆ¤æ–­çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">children_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">child</span> <span class="o">=</span> <span class="nf">new_syntax_tree_node</span><span class="p">(</span><span class="s">&#34;epsilon&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">syntax_tree_add_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">va_list</span> <span class="n">ap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">children_num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">children_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="nf">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">syntax_tree_node</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">syntax_tree_add_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="è¯­æ³•æ ‘-ä¸­é—´ä»£ç ">è¯­æ³•æ ‘-&gt;ä¸­é—´ä»£ç 
</h1><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;cminusf_builder.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;BasicBlock.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Constant.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;GlobalVariable.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Type.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Value.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ast.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;logging.hpp&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CONST_FP(num) ConstantFP::get((float)num, module.get())
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CONST_INT(num) ConstantInt::get(num, module.get())
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// types
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Type</span> <span class="o">*</span><span class="n">VOID_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">INT1_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">INT32_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">INT32PTR_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">FLOAT_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">FLOATPTR_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * use CMinusfBuilder::Scope to construct scopes
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.enter: enter a new scope
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.exit: exit current scope
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.push: add a new binding to current scope
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.find: find and return the value bound to the name123456
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTProgram</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">VOID_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_void_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">INT1_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_int1_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">INT32_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_int32_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">INT32PTR_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_int32_ptr_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLOAT_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_float_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLOATPTR_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_float_ptr_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Value</span> <span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">decl</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">declarations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_val</span> <span class="o">=</span> <span class="n">decl</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//è°ƒç”¨å¯¹åº”çš„visitå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTNum</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å¦‚æœæ˜¯numï¼Œç›´æ¥å°†å€¼å­˜å…¥context.var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span>  <span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">i_val</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span>  <span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">f_val</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTVarDeclaration</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//vardeclaration-&gt;type_specifier var;|vardeclaration-&gt;type_specifier var[num];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å…ˆå¤„ç†type_specifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è¿™ä¸ªnodeåŒ…æ‹¬Id,numå’Œtypeï¼Œidæ˜¯å˜é‡åï¼Œnumæ˜¯æ•°ç»„å¤§å°ï¼Œtypeæ˜¯å˜é‡ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Type</span> <span class="o">*</span><span class="n">var_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_type</span> <span class="o">=</span> <span class="n">INT32_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_type</span> <span class="o">=</span> <span class="n">FLOAT_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_type</span> <span class="o">=</span> <span class="n">VOID_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¿™é‡Œè·å–node.typeå¾—åˆ°ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">scope</span><span class="p">.</span><span class="n">in_global</span><span class="p">())</span><span class="c1">//å…¨å±€å˜é‡,ç”¨GlobalVariable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span><span class="c1">//ä¸æ˜¯æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">global_var</span> <span class="o">=</span> <span class="n">GlobalVariable</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="n">var_type</span><span class="p">,</span><span class="nb">false</span><span class="p">,</span><span class="n">ConstantZero</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">global_var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="o">*</span><span class="n">arrayType</span> <span class="o">=</span> <span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">i_val</span><span class="p">);</span><span class="c1">//node.num-&gt;i_valæ˜¯æ•°ç»„å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">global_var_array</span> <span class="o">=</span> <span class="n">GlobalVariable</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="n">arrayType</span><span class="p">,</span><span class="nb">false</span><span class="p">,</span><span class="n">ConstantZero</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">global_var_array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="c1">//ä¸æ˜¯å…¨å±€å˜é‡å°±ç”¨builderåˆ†é…å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">alloca</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_alloca</span><span class="p">(</span><span class="n">var_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">alloca</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="o">*</span><span class="n">arrayType</span> <span class="o">=</span> <span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">i_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">alloca_array</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_alloca</span><span class="p">(</span><span class="n">arrayType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">alloca_array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTFunDeclaration</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//FunDeclaration-&gt;type_specifier id(Params) CompoundStmt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//nodeåŒ…æ‹¬type,id,params,compound_stmt,åˆ†åˆ«æ˜¯è¿”å›å€¼ç±»å‹ï¼Œå‡½æ•°åï¼Œå‚æ•°ï¼Œå‡½æ•°ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FunctionType</span> <span class="o">*</span><span class="n">fun_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Type</span> <span class="o">*</span><span class="n">ret_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Type</span> <span class="o">*&gt;</span> <span class="n">param_types</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_type</span> <span class="o">=</span> <span class="n">INT32_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_type</span> <span class="o">=</span> <span class="n">FLOAT_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_type</span> <span class="o">=</span> <span class="n">VOID_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸Šé¢å¤„ç†è¿”å›å€¼ç±»å‹ï¼Œä¸‹é¢å¤„ç†å‚æ•°ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">param</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è¿™é‡Œè·å¾—æ¯ä¸ªå‚æ•°ï¼Œè¿›è¡Œå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//param-&gt;type,param-&gt;idï¼Œç±»å‹å’Œåç§°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: Please accomplish param_types.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">isarray</span><span class="p">)</span><span class="c1">//æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">INT32PTR_T</span><span class="p">);</span><span class="c1">//è¿™é‡Œç”¨ptrçš„ç±»å‹å­˜å…¥å‘é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FLOATPTR_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸Šé¢å·²ç»æŠŠå‚æ•°ç±»å‹å­˜å…¥äº†param_typesä¸­ï¼Œä¸‹é¢åˆ›å»ºå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fun_type</span> <span class="o">=</span> <span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">ret_type</span><span class="p">,</span> <span class="n">param_types</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="n">Function</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">fun_type</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span><span class="c1">//å°†å‡½æ•°åå’Œå‡½æ•°ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span><span class="c1">//å­˜å…¥context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">funBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;entry&#34;</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">funBB</span><span class="p">);</span><span class="c1">//è®¾ç½®æ’å…¥ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">scope</span><span class="p">.</span><span class="n">enter</span><span class="p">();</span><span class="c1">//è¿›å…¥å‡½æ•°ä½œç”¨åŸŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">get_args</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span><span class="c1">//å°†å‚æ•°å­˜å…¥args
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span><span class="c1">//å¤„ç†å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: You need to deal with params and store them in the scope.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//ç”±äºparam_typesä¸­å­˜å…¥äº†å‚æ•°ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦ç”¨å¯¹åº”å‚æ•°åå³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//è¿™é‡Œå¤„ç†å‚æ•°ï¼Œå°†å‚æ•°å­˜å…¥allocaä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">alloca</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_alloca</span><span class="p">(</span><span class="n">param_types</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_store</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alloca</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">alloca</span><span class="p">);</span><span class="c1">//å°†å˜é‡å­˜å…¥ä½œç”¨åŸŸï¼Œç¡®ä¿åœ¨å‡½æ•°å†…éƒ¨å¯ä»¥è®¿é—®ï¼ŒåŒæ—¶åœ¨å‡½æ•°å¤–éƒ¨ä¸å¯è®¿é—®ï¼ŒåŠæ—¶æ¸…ç†é¿å…å˜é‡å†²çªå’Œå†…å­˜æ³„æ¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">compound_stmt</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//è®¿é—®è€…æ¨¡å¼ï¼Œå¤„ç†å‡½æ•°ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">()))</span> <span class="c1">//å¦‚æœæ²¡æœ‰è¿”å›å€¼,åˆ™è¿”å›0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_void_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_void_ret</span><span class="p">();</span><span class="c1">//voidç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">CONST_FP</span><span class="p">(</span><span class="mf">0.</span><span class="p">));</span><span class="c1">//floatç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="c1">//intç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span><span class="p">.</span><span class="n">exit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTParam</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ä¸Šé¢å·²ç»å¤„ç†äº†å‚æ•°    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTCompoundStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is not complete.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// You may need to add some code here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to deal with complex statements. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//compoundstmt-&gt;{local_declarations statement_list}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">scope</span><span class="p">.</span><span class="n">enter</span><span class="p">();</span>  <span class="c1">//è¿›å…¥ä½œç”¨åŸŸï¼Œç¡®ä¿å±€éƒ¨å˜é‡ä¸ä¼šå’Œå…¨å±€å˜é‡å†²çª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">decl</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">local_declarations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">decl</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//å¤„ç†å±€éƒ¨å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">stmt</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">statement_list</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stmt</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//å¤„ç†è¯­å¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span><span class="c1">//å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œç›´æ¥é€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span><span class="p">.</span><span class="n">exit</span><span class="p">();</span><span class="c1">//å¤„ç†å®Œå‡½æ•°ä½“ï¼Œé€€å‡ºä½œç”¨åŸŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTExpressionStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//expressionstmt-&gt;expressionstmt;|;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">expression</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTSelectionStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">trueBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">falseBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">contBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Value</span> <span class="o">*</span> <span class="n">cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_FP</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸Šé¢åˆ›å»ºäº†å’Œ0æ¯”è¾ƒçš„æŒ‡ä»¤ï¼Œä¸‹é¢åˆ›å»ºæ¡ä»¶è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">else_statement</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">trueBB</span><span class="p">,</span> <span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">trueBB</span><span class="p">,</span> <span class="n">falseBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœæœ‰elseè¯­å¥ï¼Œåˆ›å»ºæ¡ä»¶è·³è½¬ï¼Œæ²¡æœ‰å°±è·³è½¬æ¥ä¸‹æ¥çš„è¯­å¥ï¼ˆcontBBï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">trueBB</span><span class="p">);</span><span class="c1">//è®¾ç½®æ’å…¥ç‚¹ï¼ŒæŒ‡å®šä¸‹é¢çš„è¯­å¥åœ¨trueBBä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">if_statement</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span><span class="c1">//å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œåˆ›å»ºä¸€ä¸ªè·³è½¬ï¼Œé¿å…å‡ºç°å¤šä¸ªè¿”å›å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">else_statement</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">falseBB</span><span class="o">-&gt;</span><span class="n">erase_from_parent</span><span class="p">();</span><span class="c1">//ä¸å­˜åœ¨elseåˆ é™¤falseBB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">falseBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">else_statement</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTIterationStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//iterationstmt-&gt;while(expression)statement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">condBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">bodyBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">afterBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸Šé¢ä¸‰ä¸ªåŸºæœ¬å—ï¼Œåˆ†åˆ«æ˜¯æ¡ä»¶åˆ¤æ–­ï¼Œå¾ªç¯ä½“ï¼Œå¾ªç¯ç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Value</span> <span class="o">*</span> <span class="n">cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span><span class="c1">//å¦‚æœæ²¡ç»ˆç»“ï¼Œåˆ›å»ºä¸€ä¸ªè·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">condBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">condBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//è¿™é‡Œå¤„ç†æ¡ä»¶ï¼Œcontext.varå­˜å‚¨äº†è¡¨è¾¾å¼çš„å€¼ï¼Œä¸‹é¢å’Œ0æ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_FP</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">bodyBB</span><span class="p">,</span> <span class="n">afterBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">bodyBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">statement</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//å¤„ç†å¾ªç¯ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">condBB</span><span class="p">);</span><span class="c1">//å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œåˆ›å»ºä¸€ä¸ªè·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">afterBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTReturnStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//returnstmt-&gt;return;|return expression;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">expression</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span><span class="c1">//æ²¡æœ‰è¿”å›å€¼ï¼Œç½®ä¸ºvoid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_void_ret</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: The given code is incomplete.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// You need to solve other return cases (e.g. return an integer).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è¿™å¥å¤„ç†å®Œï¼Œcontext.varå­˜å‚¨äº†è¿”å›å€¼ï¼Œcontext.funcå­˜å‚¨äº†ä¹‹å‰å‡½æ•°çš„ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// auto fun = builder-&gt;get_insert_block()-&gt;get_parent();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">ret_type</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ä¸‹é¢å¤„ç†ä¸ä¸€è‡´çš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">ret_type</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">ret_type</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">ret_type</span><span class="o">-&gt;</span><span class="n">is_void_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_void_ret</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTVar</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">expression</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span><span class="c1">//ä¸æ˜¯æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">var</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">);</span><span class="c1">//åœ¨å½“å‰ä½œç”¨åŸŸä¸­æŸ¥æ‰¾å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">var</span><span class="o">!=</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_array_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(DEBUG)&lt;&lt;&#34;var type is&#34;&lt;&lt;var-&gt;get_type()-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// var = builder-&gt;create_load(var);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//å¦‚æœæ˜¯æŒ‡é’ˆï¼Œåˆ™è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ åœ°å€ï¼Œæ•°ç»„å°±æ˜¯[0][0],æ™®é€šå˜é‡å°±æ˜¯[0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var_location</span> <span class="o">=</span> <span class="n">var</span><span class="p">;</span><span class="c1">//æŠŠåœ°å€å­˜å…¥context.var_location
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var_location</span><span class="p">);</span><span class="c1">//åŠ è½½å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//å¤„ç†æ•°ç»„ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// auto fun = builder-&gt;get_insert_block()-&gt;get_parent();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Value</span><span class="o">*</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span><span class="c1">//å¦‚æœæ˜¯æµ®ç‚¹æ•°ï¼Œè½¬æ¢ä¸ºæ•´æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ä¸‹é¢å¤„ç†è´Ÿæ•°ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">index_check</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_lt</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//index_checkæ˜¯ä¸€ä¸ªæ¯”è¾ƒæŒ‡ä»¤ï¼Œåˆ¤æ–­indexæ˜¯å¦å°äº0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">excpetBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//åˆ›å»ºå¼‚å¸¸åŸºæœ¬å—ï¼Œè°ƒç”¨neg_idx_except
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">normalBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">index_check</span><span class="p">,</span> <span class="n">excpetBB</span><span class="p">,</span> <span class="n">normalBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">excpetBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">except</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;neg_idx_except&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_call</span><span class="p">(</span><span class="n">except</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">normalBB</span><span class="p">);</span><span class="c1">//å¼‚å¸¸å¤„ç†å®Œï¼Œè·³è½¬åˆ°normalBB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">normalBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">var_array</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">var_array_gep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">var_array</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_array_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">var_array_gep</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var_array</span><span class="p">,</span> <span class="p">{</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(DEBUG)&lt;&lt;&#34;var_array type is&#34;&lt;&lt;var_array-&gt;get_type()-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">var_load</span><span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var_array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">var_array_gep</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var_load</span><span class="p">,</span> <span class="p">{</span><span class="n">index</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var_location</span> <span class="o">=</span> <span class="n">var_array_gep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var_array_gep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTAssignExpression</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//assignexpression-&gt;var=expression
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Value</span><span class="o">*</span> <span class="n">var</span><span class="p">;</span><span class="c1">//å­˜å‚¨å˜é‡åœ°å€ï¼Œç”¨äºåŠ è½½å‡ºcontext.var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Value</span><span class="o">*</span> <span class="n">num</span><span class="p">;</span><span class="c1">//å­˜å‚¨varçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">var</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var_location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">num</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¿™æ­¥å¤„ç†å®Œåcontext.varå­˜å‚¨äº†è¡¨è¾¾å¼çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè½¬æ¢ä¸ºvarçš„ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_store</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTSimpleExpression</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//simpleexpression-&gt;additive_expression relop additive_expression
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">additive_expression_l</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">additive_expression_r</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="c1">//å‰é¢å¤„ç†è¿‡å·¦è¾¹çš„è¡¨è¾¾å¼ï¼Œcontext.varå­˜å‚¨äº†å·¦è¾¹çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">node</span><span class="p">.</span><span class="n">additive_expression_r</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">((</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å¦‚æœéƒ½æ˜¯æ•´å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_EQ</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_eq</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_ge</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_gt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_le</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_lt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_NEQ</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_ne</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span><span class="c1">//å¦‚æœæœ‰ä¸€ä¸ªæ˜¯æ•´å‹ï¼Œè½¬æ¢ä¸ºæµ®ç‚¹å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_EQ</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_eq</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_ge</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_gt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_le</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_lt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_NEQ</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_ne</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>          
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_zext</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span><span class="c1">//è½¬æ¢ä¸ºæ•´å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTAdditiveExpression</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//additiveexpression-&gt;additive_expression addop term|term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">additive_expression</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">additive_expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="c1">//lhså­˜å‚¨å·¦è¾¹additive_expressionçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">node</span><span class="p">.</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="c1">//rhså­˜å‚¨termçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">((</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_PLUS</span> <span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_iadd</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MINUS</span><span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_isub</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_PLUS</span> <span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fadd</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MINUS</span><span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fsub</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTTerm</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//term-&gt;term mulop factor|factor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">term</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">factor</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="c1">//å’Œå‰é¢ç±»ä¼¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">factor</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">((</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MUL</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_imul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_DIV</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_isdiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MUL</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fmul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_DIV</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fdiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTCall</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//call-&gt;id(args)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">*&gt;</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">param_type</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">get_function_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">param_begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">param_type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">param_type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">((</span><span class="o">*</span><span class="n">param_type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">param_type</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_function_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_num_of_args</span><span class="p">()</span> <span class="o">!=</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error: Wrong number of arguments for function &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="ä¸­é—´ä»£ç -é¾™èŠ¯æ±‡ç¼–">ä¸­é—´ä»£ç -&gt;é¾™èŠ¯æ±‡ç¼–
</h1><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CodeGen.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ASMInstruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CodeGenUtil.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Instruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Register.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;logging.hpp&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">allocate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤‡ä»½ $ra $fp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">PROLOGUE_OFFSET_BASE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸ºæ¯ä¸ªå‚æ•°åˆ†é…æ ˆç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_args</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">[</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸ºæŒ‡ä»¤ç»“æœåˆ†é…æ ˆç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">instr</span> <span class="p">:</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ¯ä¸ªé void çš„å®šå€¼éƒ½åˆ†é…æ ˆç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">instr</span><span class="p">.</span><span class="n">is_void</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">instr</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">[</span><span class="o">&amp;</span><span class="n">instr</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// alloca çš„å‰¯ä½œç”¨ï¼šåˆ†é…é¢å¤–ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">is_alloca</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="o">*</span><span class="n">alloca_inst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">AllocaInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">alloc_size</span> <span class="o">=</span> <span class="n">alloca_inst</span><span class="o">-&gt;</span><span class="n">get_alloca_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">offset</span> <span class="o">+=</span> <span class="n">alloc_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é…æ ˆç©ºé—´ï¼Œéœ€è¦æ˜¯ 16 çš„æ•´æ•°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="p">.</span><span class="n">frame_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">PROLOGUE_ALIGN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">copy_stmt</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">succ</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_succ_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">succ</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">is_phi</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// éå†åç»§å—ä¸­ phi çš„å®šå€¼ bb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inst</span><span class="p">.</span><span class="n">get_operands</span><span class="p">().</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// phi çš„å®šå€¼ bb æ˜¯å½“å‰ç¿»è¯‘å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="o">*</span><span class="n">lvalue</span> <span class="o">=</span> <span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">lvalue</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">lvalue</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                            <span class="n">store_from_freg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">lvalue</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                            <span class="n">store_from_greg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰ç¿»è¯‘å—ï¼Œè¯´æ˜æ˜¯ undefï¼Œæ— äº‹å¯åš
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_to_greg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="o">*</span><span class="n">constant</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int32_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">constant</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">ADDI</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">val</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_large_int32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="k">auto</span> <span class="o">*</span><span class="n">global</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD_ADDR</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">global</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_from_stack_to_greg</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_large_int32</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">high_20</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// si20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">low_12</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">LOW_12_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">LU12I_W</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">high_20</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">ORI</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">low_12</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_large_int64</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">low_32</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">LOW_32_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_large_int32</span><span class="p">(</span><span class="n">low_32</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">high_32</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">high_32_low_20</span> <span class="o">=</span> <span class="p">(</span><span class="n">high_32</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// si20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int32_t</span> <span class="n">high_32_high_12</span> <span class="o">=</span> <span class="n">high_32</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>        <span class="c1">// si12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">append_inst</span><span class="p">(</span><span class="n">LU32I_D</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">high_32_low_20</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">LU52I_D</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">high_32_high_12</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_from_stack_to_greg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">store_from_greg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_to_freg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">FReg</span> <span class="o">&amp;</span><span class="n">freg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="o">*</span><span class="n">constant</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ConstantFP</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">val</span> <span class="o">=</span> <span class="n">constant</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_float_imm</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">freg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">FLOAD</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">freg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">FLOAD</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">freg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_float_imm</span><span class="p">(</span><span class="kt">float</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">FReg</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_large_int32</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">GR2FR</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">r</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">store_from_freg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">FReg</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">FSTORE</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">r</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">FSTORE</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">r</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_prologue</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¯¥å‡½æ•°ç”¨æ¥æ’å…¥å‡½æ•°çš„åºè¨€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸Šé¢è¿™ä¸ªç”¨æ¥åˆ¤æ–­å½“å‰æ ˆå¸§å¤§å°æ˜¯å¦åœ¨12ä½ç«‹å³æ•°èŒƒå›´å†…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $fp, $sp, 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $sp, $sp, &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;sub.d $sp, $sp, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;add.d $fp, $sp, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">garg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">farg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆå§‹åŒ–ä¸¤ä¸ªè®¡æ•°å™¨ï¼Œåˆ†åˆ«ç”¨äºæ•´æ•°/æŒ‡é’ˆç±»å‹å‚æ•°å’Œæµ®ç‚¹ç±»å‹å‚æ•°çš„å¯„å­˜å™¨ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_args</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//éå†å½“å‰å‡½æ•°æ‰€æœ‰å‚æ•°ï¼Œå¦‚æœæ˜¯mainä¼ çš„ä¸ºvoidå°±æ²¡æœ‰å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">store_from_freg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="n">farg_cnt</span><span class="o">++</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// int or pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">store_from_greg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="n">garg_cnt</span><span class="o">++</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å…ˆå°†å‚æ•°ä¼ å…¥æ ˆå¸§ä¸­ï¼Œä»¥ä¾¿åœ¨å‡½æ•°ä½“å†…éƒ¨å¯ä»¥æ­£ç¡®è®¿é—®è¿™äº›å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_epilogue</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO æ ¹æ®ä½ çš„ç†è§£è®¾å®šå‡½æ•°çš„ epilogue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">append_inst</span><span class="p">(</span><span class="n">func_exit_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">),</span><span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $sp, $sp, &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;jr $ra&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $sp, $sp, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;jr $ra&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_ret</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO å‡½æ•°è¿”å›ï¼Œæ€è€ƒå¦‚ä½•å¤„ç†è¿”å›å€¼ã€å¯„å­˜å™¨å¤‡ä»½ï¼Œå¦‚ä½•è¿”å›è°ƒç”¨è€…åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ReturnInst(Value *val, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">retInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ReturnInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">retInst</span><span class="o">-&gt;</span><span class="n">is_void_ret</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// gen_epilogue();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.w&#34;</span><span class="p">,{</span><span class="s">&#34;$a0&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">func_exit_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">retValue</span> <span class="o">=</span> <span class="n">retInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">retValue</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">retValue</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">retValue</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">retValue</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">func_exit_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// gen_epilogue();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_br</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//BranchInst(Value *cond, BasicBlock *if_true, BasicBlock *if_false,BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">branchInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">is_cond_br</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO è¡¥å…¨æ¡ä»¶è·³è½¬çš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="o">*</span><span class="n">truebb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">falsebb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">cond</span> <span class="o">=</span> <span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_condition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_float_imm</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;fcmp.seq.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//è¿™å¥æ¯”è¾ƒå¦‚æœcond == 0,åˆ™fcc0 = 1,cond == 1,åˆ™fcc0 = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;bceqz $fcc0, &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">truebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//åˆ¤æ–­fcc0æ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™è·³è½¬åˆ°truebb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">falsebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;beq $t1, $zero, &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">falsebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">truebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">branchbb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">branchbb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_binary</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Instruction(Type *ty, OpID id, BasicBlock *parent = nullptr);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//IBinaryInst(OpID id, Value *v1, Value *v2, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">add</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;add.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;sub.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">mul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;mul.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sdiv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;div.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_float_binary</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO æµ®ç‚¹ç±»å‹çš„äºŒå…ƒæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fadd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fadd.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fsub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fsub.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fmul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fmul.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fdiv</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fdiv.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_alloca</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* æˆ‘ä»¬å·²ç»ä¸º alloca çš„å†…å®¹åˆ†é…ç©ºé—´ï¼Œåœ¨æ­¤æˆ‘ä»¬è¿˜éœ€ä¿å­˜ alloca
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æŒ‡ä»¤è‡ªèº«äº§ç”Ÿçš„å®šå€¼ï¼Œå³æŒ‡å‘ alloca ç©ºé—´èµ·å§‹åœ°å€çš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO å°† alloca å‡ºç©ºé—´çš„èµ·å§‹åœ°å€ä¿å­˜åœ¨æ ˆå¸§ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//AllocaInst(Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">allocaInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">AllocaInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">allocaType</span> <span class="o">=</span> <span class="n">allocaInst</span><span class="o">-&gt;</span><span class="n">get_alloca_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">allocaInst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;alloca offset: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">allocaType</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">new_offset_sub</span> <span class="o">=</span>  <span class="kt">int</span><span class="p">(</span><span class="n">allocaType</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">new_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">new_offset_sub</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">new_offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">new_offset</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ç”¨t0å­˜å‚¨allocaåçš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">new_offset</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;add.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†allocaåçš„åœ°å€å­˜å‚¨åˆ°æ ˆå¸§ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_load</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* %op2 = load i32, i32* %op1 */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//get_operandå‡½æ•°åªæœ‰0ï¼Œè¿”å›valueç±»å‹çš„*%op1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *ptr = context.inst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ptræ˜¯è¦åŠ è½½çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸Šé¢çš„ä¾‹å­ä¸­æ˜¯i32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†ptrçš„å€¼åŠ è½½åˆ°t0ä¸­ï¼Œä¹Ÿå°±æ˜¯t0å­˜å‚¨äº†è¦åŠ è½½çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;fld.s $ft0, $t0, 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ä»t0æŒ‡å‘çš„åœ°å€ä¸­å–å€¼åŠ è½½åˆ°ft0ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†ft0çš„å€¼å­˜å‚¨åˆ°context.instä¸­ï¼Œå…¶å®ä¹Ÿå°±æ˜¯èµ‹ç»™äº†å·¦å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO load æ•´æ•°ç±»å‹çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.b&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.w&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_store</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO ç¿»è¯‘ store æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* store float 0x40091eb860000000, float* %op0 */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *ptr = context.inst-&gt;get_operand(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//StoreInst(Value *val, Value *ptr, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å’Œloadæ˜¯åçš„ï¼Œ0æ˜¯è¦å­˜å‚¨çš„å€¼ï¼Œ1æ˜¯åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_to_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æŠŠè¦å­˜å‚¨çš„å€¼åŠ è½½åˆ°ft0ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;fst.s $ft0, $t0, 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†ft0ä¸­çš„å€¼å†™å…¥å†…å­˜t0æŒ‡å‘çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.b&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.w&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_icmp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO å¤„ç†å„ç§æ•´æ•°æ¯”è¾ƒçš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op0 = icmp sgt i32 5, 1 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">icmpInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ICmpInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ICmpInst(OpID id, Value *lhs, Value *rhs, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *op1 = icmpInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è·å¾—ç¬¬ä¸€ä¸ªvalueç±»å‹çš„lhs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *op2 = icmpInst-&gt;get_operand(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è·å¾—ç¬¬äºŒä¸ªvalueç±»å‹çš„rhs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">icmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">icmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">icmpInst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">lt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//åˆ¤æ–­t0æ˜¯å¦å°äºt1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;slt $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">eq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//åˆ¤æ–­t0å’Œt1æ˜¯å¦ç›¸ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xor&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t0&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;sltu&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xori&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å…ˆå¼‚æˆ–ï¼Œå¦‚æœ t0 å’Œ t1 ç›¸ç­‰ï¼Œç»“æœä¸º 0ï¼Œå¦åˆ™ä¸ºéé›¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç„¶åä½¿ç”¨ sltu åˆ¤æ–­ç»“æœæ˜¯å¦ä¸ºé›¶ï¼Œæœ€åå–å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">ne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xor&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t0&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;sltu&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//åˆ¤æ–­t0å’Œt1æ˜¯å¦ä¸ç›¸ç­‰ï¼Œå…ˆå¼‚æˆ–ï¼Œå†åˆ¤æ–­æ˜¯å¦å¤§äº0ï¼Œç”¨æ— ç¬¦å·æ•°æ¯”è¾ƒï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//å¦‚æœt0å’Œt1ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆt2ä¼šæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œæ­¤æ—¶ä¸€å®šæ¯”0å¤§ï¼Œæ‰€ä»¥sltåä¸º1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">le</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;slt&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">,</span> <span class="s">&#34;$t0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xori&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//åˆ¤æ–­t0æ˜¯å¦å°äºç­‰äºt1ï¼Œå…ˆåˆ¤æ–­t1æ˜¯å¦å°äºt0ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆt2ä¸º1ï¼Œå¦åˆ™ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//ç„¶åå°†t2å–åï¼Œå¦‚æœt0å°äºç­‰äºt1ï¼Œé‚£ä¹ˆt2ä¸º1ï¼Œå¦åˆ™ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">gt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;slt $t2, $t1, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">ge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;slt $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;xori $t2, $t2, 1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†æ¯”è¾ƒçš„ç»“æœå­˜å‚¨åˆ°context.instä¸­ï¼Œå³èµ‹ç»™å·¦å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_fcmp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO å¤„ç†å„ç§æµ®ç‚¹æ•°æ¯”è¾ƒçš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//FCmpInst(OpID id, Value *lhs, Value *rhs, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">fcmpInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">FCmpInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *op1 = fcmpInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *op2 = fcmpInst-&gt;get_operand(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">fcmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">fcmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">fcmpInst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">feq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.seq.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sne.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">flt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.slt.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sle.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fgt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sgt.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sge.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>           
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;bcnez&#34;</span><span class="p">,{</span><span class="s">&#34;$fcc0&#34;</span><span class="p">,</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœfcc0ä¸º0ï¼Œè·³è½¬å­˜0,å¦åˆ™ä¸è·³è½¬å­˜1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_float_imm</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span><span class="p">),</span><span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_float_imm</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_zext</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO å°†çª„ä½å®½çš„æ•´æ•°æ•°æ®è¿›è¡Œé›¶æ‰©å±•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ZextInst(Value *val, Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op1 = zext i1 %op0 to i32 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">zextInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ZextInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">zextInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†valçš„å€¼åŠ è½½åˆ°t0ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_call</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO å‡½æ•°è°ƒç”¨ï¼Œæ³¨æ„æˆ‘ä»¬åªéœ€è¦é€šè¿‡å¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼Œå³ä¸éœ€è€ƒè™‘æ ˆä¸Šä¼ å‚çš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//CallInst(Function *func, std::vector&lt;Value *&gt; args, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op0 = call i32 @callee(i32 110) */</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">callInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">CallInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">garg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">farg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">callInst</span><span class="o">-&gt;</span><span class="n">get_operands</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="s">&#34;arg type is &#34;</span><span class="o">&lt;&lt;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="n">farg_cnt</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">farg_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="s">&#34;here is integer type&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="n">garg_cnt</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">garg_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="n">garg_cnt</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">garg_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_void_type</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// else {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     assert(false);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†å‚æ•°ä¼ å…¥å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;context.func is null&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">current_func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">callInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// context.func = current_func;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;bl&#34;</span><span class="p">,{</span><span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è°ƒç”¨å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// std::cout&lt;&lt;&#34;call function_type &#34;&lt;&lt;callInst-&gt;get_function_type()&lt;&lt;std::endl;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">()</span> <span class="o">||</span> <span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if(!current_func-&gt;get_return_type()-&gt;is_void_type())
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// gen_epilogue();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†å‡½æ•°è¿”å›å€¼å­˜å‚¨åˆ°context.instä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// append_inst(&#34;b &#34; + func_exit_label_name(context.func));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è·³è½¬åˆ°å‡½æ•°é€€å‡ºçš„åœ°æ–¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * %op = getelementptr [10 x i32], [10 x i32]* %op, i32 0, i32 %op
</span></span></span><span class="line"><span class="cl"><span class="cm"> * %op = getelementptr        i32,        i32* %op, i32 %op
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Memory layout
</span></span></span><span class="line"><span class="cl"><span class="cm"> *       -            ^
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      | Smaller address
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |  arg ptr  |---+  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+   /  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |&lt;--   |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   \  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |   Array   |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |  Pointer  |---+  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      | Larger address
</span></span></span><span class="line"><span class="cl"><span class="cm"> *       +
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_gep</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO è®¡ç®—å†…å­˜åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//GetElementPtrInst(Value *ptr, std::vector&lt;Value *&gt; idxs, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op1 = getelementptr [10 x i32], [10 x i32]* %op0, i32 0, i32 0 */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//* %op = getelementptr        i32,        i32* %op, i32 %op
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">gepInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">gepInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">idx</span> <span class="p">:</span> <span class="n">gepInst</span><span class="o">-&gt;</span><span class="n">get_operands</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="o">||</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_to_greg</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.w&#34;</span><span class="p">,{</span><span class="s">&#34;$t4&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;4&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;mul.w&#34;</span><span class="p">,{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">,</span> <span class="s">&#34;$t4&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†idxçš„å€¼ä¹˜ä»¥4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;add.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t3&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t3&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†ptrçš„å€¼åŠ ä¸Šidxçš„å€¼ï¼Œæ­¤æ—¶t3ä¸­å­˜å‚¨çš„æ˜¯ptr+idxçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_sitofp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO æ•´æ•°è½¬å‘æµ®ç‚¹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//SiToFpInst(Value *val, Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">sitofpInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">SiToFpInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *val = sitofpInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">sitofpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;movgr2fr.w&#34;</span><span class="p">,{</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ffint.s.w&#34;</span><span class="p">,{</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_fptosi</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO æµ®ç‚¹æ•°è½¬å‘æ•´æ•°ï¼Œæ³¨æ„å‘ä¸‹å–æ•´(round to zero)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//%op2 = fptosi float %op1 to i32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//FpToSiInst(Value *val, Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">fptosiInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">FpToSiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *val = fptosiInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">fptosiInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ftintrz.w.s&#34;</span><span class="p">,{</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;movfr2gr.s&#34;</span><span class="p">,{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¡®ä¿æ¯ä¸ªå‡½æ•°ä¸­åŸºæœ¬å—çš„åå­—éƒ½è¢«è®¾ç½®å¥½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ä½¿ç”¨ GNU ä¼ªæŒ‡ä»¤ä¸ºå…¨å±€å˜é‡åˆ†é…ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ä½ å¯ä»¥ä½¿ç”¨ `la.local` æŒ‡ä»¤å°†æ ‡ç­¾ (å…¨å±€å˜é‡) çš„åœ°å€è½½å…¥å¯„å­˜å™¨ä¸­, æ¯”å¦‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è¦å°† `a` çš„åœ°å€è½½å…¥ $t0, åªéœ€è¦ `la.local $t0, a`
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">get_global_variable</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;Global variables&#34;</span><span class="p">,</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Comment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* è™½ç„¶ä¸‹é¢ä¸¤æ¡ä¼ªæŒ‡ä»¤å¯ä»¥ç®€åŒ–ä¸ºä¸€æ¡ `.bss` ä¼ªæŒ‡ä»¤, ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯é€‰æ‹©ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="cm">         * `.section` å°†å…¨å±€å˜é‡æ”¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„ BSS æ®µ, åŸå› å¦‚ä¸‹:
</span></span></span><span class="line"><span class="cl"><span class="cm">         * - å°½å¯èƒ½å¯¹é½äº¤å‰ç¼–è¯‘å™¨ loongarch64-unknown-linux-gnu-gcc çš„è¡Œä¸º
</span></span></span><span class="line"><span class="cl"><span class="cm">         * - æ”¯æŒæ›´æ—§ç‰ˆæœ¬çš„ GNU æ±‡ç¼–å™¨, å› ä¸º `.bss` ä¼ªæŒ‡ä»¤æ˜¯åº”è¯¥ç›¸å¯¹è¾ƒæ–°çš„æŒ‡ä»¤,
</span></span></span><span class="line"><span class="cl"><span class="cm">         *   GNU æ±‡ç¼–å™¨åœ¨ 2023 å¹´ 2 æœˆçš„ 2.37 ç‰ˆæœ¬æ‰å°†å…¶å¼•å…¥
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.text&#34;</span><span class="p">,</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.section&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;.bss&#34;</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">aw</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;@nobits&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">global</span> <span class="p">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_global_variable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">global</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.globl&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">()},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.type&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s">&#34;@object&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.size&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">size</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.space&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">size</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å‡½æ•°ä»£ç æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;.text&#34;</span><span class="p">,</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">func</span> <span class="p">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">func</span><span class="p">.</span><span class="n">is_declaration</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ›´æ–° context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">context</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// å‡½æ•°ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.globl&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">func</span><span class="p">.</span><span class="n">get_name</span><span class="p">()},</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.type&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">func</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s">&#34;@function&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// åˆ†é…å‡½æ•°æ ˆå¸§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">allocate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ç”Ÿæˆ prologue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">gen_prologue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">func</span><span class="p">.</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">append_inst</span><span class="p">(</span><span class="n">label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">instr</span> <span class="p">:</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// For debug
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">append_inst</span><span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Comment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">context</span><span class="p">.</span><span class="n">inst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">;</span> <span class="c1">// æ›´æ–° context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">switch</span> <span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">ret</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_ret</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">br</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">copy_stmt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_br</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">add</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">mul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sdiv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_binary</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fadd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fsub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fmul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fdiv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_float_binary</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">alloca</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* å¯¹äº alloca æŒ‡ä»¤ï¼Œæˆ‘ä»¬å·²ç»ä¸º alloca
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * çš„å†…å®¹åˆ†é…ç©ºé—´ï¼Œåœ¨æ­¤æˆ‘ä»¬è¿˜éœ€ä¿å­˜ alloca
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * æŒ‡ä»¤è‡ªèº«äº§ç”Ÿçš„å®šå€¼ï¼Œå³æŒ‡å‘ alloca ç©ºé—´èµ·å§‹åœ°å€çš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">                         */</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_alloca</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">load</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_load</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">store</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_store</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">ge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">gt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">le</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">lt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">eq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">ne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_icmp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fgt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">flt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">feq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_fcmp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">phi</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* for phi, just convert to a series of
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * copy-stmts */</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* we can collect all phi and deal them at
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * the end */</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">call</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_call</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">getelementptr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_gep</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">zext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_zext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fptosi</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_fptosi</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sitofp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_sitofp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ç”Ÿæˆ epilogue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">gen_epilogue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">print</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">output</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">+=</span> <span class="n">inst</span><span class="p">.</span><span class="n">format</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="ä¼˜åŒ–å¤„ç†">ä¼˜åŒ–å¤„ç†
</h1><h2 id="mem2reg">MEM2REG
</h2><p>åˆ›å»ºæ”¯é…æ ‘ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Dominators.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Function.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;BasicBlock.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;logging.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief æ”¯é…å™¨åˆ†æçš„å…¥å£å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * éå†æ¨¡å—ä¸­çš„æ‰€æœ‰å‡½æ•°ï¼Œå¯¹æ¯ä¸ªéå£°æ˜çš„å‡½æ•°æ‰§è¡Œæ”¯é…å…³ç³»åˆ†æã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">f1</span> <span class="p">:</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_on_func</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å¯¹å•ä¸ªå‡½æ•°æ‰§è¡Œæ”¯é…å…³ç³»åˆ†æ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦åˆ†æçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°æ‰§è¡Œå®Œæ•´çš„æ”¯é…å…³ç³»åˆ†ææµç¨‹ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. åˆå§‹åŒ–æ•°æ®ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. åˆ›å»ºåå‘ååºéå†åºåˆ—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. è®¡ç®—ç›´æ¥æ”¯é…è€…(idom)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 4. è®¡ç®—æ”¯é…è¾¹ç•Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 5. æ„å»ºæ”¯é…æ ‘çš„åç»§å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 6. åˆ›å»ºæ”¯é…æ ‘çš„DFSåº
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">run_on_func</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dom_post_order_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">idom_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_frontier_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="p">{}});</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_tree_succ_blocks_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="p">{}});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_reverse_post_order</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_idom</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_dominance_frontier</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_dom_tree_succ</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_dom_dfs_order</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LOG(INFO)&lt;&lt;m_-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dump_dominator_tree(f);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dump_cfg(f);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief è®¡ç®—ä¸¤ä¸ªåŸºæœ¬å—çš„æ”¯é…å…³ç³»äº¤é›†
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param b1 ç¬¬ä¸€ä¸ªåŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param b2 ç¬¬äºŒä¸ªåŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return è¿”å›åœ¨æ”¯é…æ ‘ä¸Šæœ€æ·±çš„åŒæ—¶æ”¯é…b1å’Œb2çš„èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°ä½¿ç”¨ååºå·æ¥æŸ¥æ‰¾ä¸¤ä¸ªèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±æ”¯é…è€…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * é€šè¿‡åœ¨æ”¯é…æ ‘ä¸Šå‘ä¸Šéå†ç›´åˆ°æ‰¾åˆ°äº¤ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">Dominators</span><span class="o">::</span><span class="n">intersect</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">b1</span><span class="p">,</span> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">b1</span> <span class="o">!=</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">get_post_order</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">get_post_order</span><span class="p">(</span><span class="n">b2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">b1</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="n">b1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">get_post_order</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">get_post_order</span><span class="p">(</span><span class="n">b1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">b2</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="n">b2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">b1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief åˆ›å»ºå‡½æ•°çš„åå‘ååºéå†åºåˆ—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦å¤„ç†çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * é€šè¿‡DFSéå†CFGæ¥æ„å»ºåŸºæœ¬å—çš„ååºéå†åºåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¿™ä¸ªåºåˆ—ç”¨äºåç»­çš„æ”¯é…å…³ç³»åˆ†æã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_reverse_post_order</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BBSet</span> <span class="n">visited</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dfs</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">(),</span> <span class="n">visited</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief æ·±åº¦ä¼˜å…ˆæœç´¢è¾…åŠ©å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param bb å½“å‰éå†çš„åŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param visited å·²è®¿é—®çš„åŸºæœ¬å—é›†åˆ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ‰§è¡ŒDFSéå†ï¼Œç»´æŠ¤ååºéå†åºåˆ—å’Œæ¯ä¸ªåŸºæœ¬å—çš„ååºå·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">dfs</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">visited</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">visited</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">succ</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_succ_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">visited</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">succ</span><span class="p">)</span> <span class="o">==</span> <span class="n">visited</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dfs</span><span class="p">(</span><span class="n">succ</span><span class="p">,</span> <span class="n">visited</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_order_vec_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_order_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="n">post_order_</span><span class="p">.</span><span class="n">size</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief è®¡ç®—æ‰€æœ‰åŸºæœ¬å—çš„ç›´æ¥æ”¯é…è€…(immediate dominator)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦åˆ†æçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä½¿ç”¨è¿­ä»£ç®—æ³•è®¡ç®—æ¯ä¸ªåŸºæœ¬å—çš„ç›´æ¥æ”¯é…è€…ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. å°†å…¥å£å—çš„ç›´æ¥æ”¯é…è€…è®¾ç½®ä¸ºè‡ªèº«
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. é‡å¤éå†æ‰€æœ‰åŸºæœ¬å—ï¼Œæ›´æ–°å®ƒä»¬çš„ç›´æ¥æ”¯é…è€…
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. å½“æ²¡æœ‰å˜åŒ–æ—¶ç®—æ³•ç»ˆæ­¢
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_idom</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">idom_</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LOG(INFO)&lt;&lt;&#34;idom_[entry]:&#34;&lt;&lt;idom_[entry]-&gt;get_name();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">rev_it</span> <span class="o">=</span> <span class="n">post_order_vec_</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span> <span class="n">rev_it</span> <span class="o">!=</span> <span class="n">post_order_vec_</span><span class="p">.</span><span class="n">rend</span><span class="p">();</span> <span class="o">++</span><span class="n">rev_it</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">*</span><span class="n">rev_it</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">bb</span> <span class="o">==</span> <span class="n">entry</span> <span class="o">||</span> <span class="n">bb</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">pre_blocks</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">pre_blocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">new_idom</span> <span class="o">=</span> <span class="o">*</span><span class="n">pre_blocks</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">idom_</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">idom_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_idom</span> <span class="o">=</span> <span class="n">intersect</span><span class="p">(</span><span class="n">new_idom</span><span class="p">,</span> <span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">idom_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_idom</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">idom_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_idom</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief è®¡ç®—æ‰€æœ‰åŸºæœ¬å—çš„æ”¯é…è¾¹ç•Œ(dominance frontier)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦åˆ†æçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¯¹äºæ¯ä¸ªæœ‰å¤šä¸ªå‰é©±çš„åŸºæœ¬å—Bï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä»æ¯ä¸ªå‰é©±På¼€å§‹ï¼Œæ²¿ç€æ”¯é…æ ‘å‘ä¸Šéå†ç›´åˆ°é‡åˆ°Bçš„ç›´æ¥æ”¯é…è€…ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å°†BåŠ å…¥è·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹çš„æ”¯é…è¾¹ç•Œä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_dominance_frontier</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">block</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">get_pre_basic_blocks</span><span class="p">().</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">block</span><span class="p">.</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">runner</span> <span class="o">=</span> <span class="n">pred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span><span class="p">(</span><span class="n">runner</span> <span class="o">!=</span> <span class="n">get_idom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">runner</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dom_frontier_</span><span class="p">[</span><span class="n">runner</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">runner</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="n">runner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief æ„å»ºæ”¯é…æ ‘çš„åç»§å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦å¤„ç†çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åŸºäºå·²è®¡ç®—çš„ç›´æ¥æ”¯é…è€…å…³ç³»ï¼Œæ„å»ºæ”¯é…æ ‘çš„å­èŠ‚ç‚¹å…³ç³»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœAæ˜¯Bçš„ç›´æ¥æ”¯é…è€…ï¼Œåˆ™Bæ˜¯Aåœ¨æ”¯é…æ ‘ä¸Šçš„åç»§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_dom_tree_succ</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†æ‰€æœ‰åŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">block</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">idom</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">idom</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">idom</span><span class="p">)</span> <span class="o">!=</span> <span class="n">idom_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ£€æŸ¥ç›´æ¥æ”¯é…è€…æ˜¯å¦å·²ç»åœ¨ dom_tree_succ_blocks_ ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">dom_tree_succ_blocks_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">idom</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dom_tree_succ_blocks_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">dom_tree_succ_blocks_</span><span class="p">[</span><span class="n">idom</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">dom_tree_succ_blocks_</span><span class="p">[</span><span class="n">idom</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">&amp;</span><span class="n">block</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief ä¸ºæ”¯é…æ ‘åˆ›å»ºæ·±åº¦ä¼˜å…ˆæœç´¢åº
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦å¤„ç†çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°é€šè¿‡æ·±åº¦ä¼˜å…ˆæœç´¢éå†æ”¯é…æ ‘ï¼Œä¸ºæ¯ä¸ªåŸºæœ¬å—åˆ†é…ä¸¤ä¸ªåºå·ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. dom_tree_L_ï¼šè®°å½•DFSé¦–æ¬¡è®¿é—®è¯¥èŠ‚ç‚¹çš„æ—¶é—´æˆ³
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. dom_tree_R_ï¼šè®°å½•DFSå®Œæˆè®¿é—®è¯¥èŠ‚ç‚¹å­æ ‘çš„æ—¶é—´æˆ³
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åŒæ—¶ç»´æŠ¤ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - dom_dfs_order_ï¼šæŒ‰DFSè®¿é—®é¡ºåºè®°å½•åŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - dom_post_order_ï¼šdom_dfs_order_çš„é€†åº
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¿™äº›åºå·å’Œé¡ºåºå¯ç”¨äºå¿«é€Ÿåˆ¤æ–­æ”¯é…å…³ç³»ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœèŠ‚ç‚¹Aæ”¯é…èŠ‚ç‚¹Bï¼Œåˆ™Açš„Lå€¼å°äºBçš„Lå€¼ï¼Œä¸”Açš„Rå€¼å¤§äºBçš„Rå€¼
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_dom_dfs_order</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†æå¾—åˆ° f ä¸­å„ä¸ªåŸºæœ¬å—çš„æ”¯é…æ ‘ä¸Šçš„dfsåºL,R
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_tree_L_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">succ</span> <span class="p">:</span> <span class="n">dom_tree_succ_blocks_</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dfs</span><span class="p">(</span><span class="n">succ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_tree_R_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">dfs</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">dom_post_order_</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">(</span><span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">rbegin</span><span class="p">(),</span> <span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">rend</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief æ‰“å°å‡½æ•°çš„ç›´æ¥æ”¯é…å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦æ‰“å°çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°ä»¥å¯è¯»æ ¼å¼æ‰“å°å‡½æ•°ä¸­æ‰€æœ‰åŸºæœ¬å—çš„ç›´æ¥æ”¯é…è€…(immediate dominator)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¾“å‡ºæ ¼å¼ä¸ºï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åŸºæœ¬å—å: å…¶ç›´æ¥æ”¯é…è€…å
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœåŸºæœ¬å—æ²¡æœ‰ç›´æ¥æ”¯é…è€…(å¦‚å…¥å£å—)ï¼Œåˆ™æ˜¾ç¤º&#34;null&#34;ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">print_idom</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">bb_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;bb&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Immediate dominance of function %s:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">get_idom</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">get_idom</span><span class="p">(</span><span class="n">bb</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="s">&#34;null&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief æ‰“å°å‡½æ•°çš„æ”¯é…è¾¹ç•Œä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦æ‰“å°çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°ä»¥å¯è¯»æ ¼å¼æ‰“å°å‡½æ•°ä¸­æ‰€æœ‰åŸºæœ¬å—çš„æ”¯é…è¾¹ç•Œ(dominance frontier)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¾“å‡ºæ ¼å¼ä¸ºï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åŸºæœ¬å—å: æ”¯é…è¾¹ç•Œä¸­çš„åŸºæœ¬å—åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœåŸºæœ¬å—æ²¡æœ‰æ”¯é…è¾¹ç•Œï¼Œåˆ™æ˜¾ç¤º&#34;null&#34;ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">print_dominance_frontier</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">bb_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;bb&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Dominance Frontier of function %s:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">get_dominance_frontier</span><span class="p">(</span><span class="n">bb</span><span class="p">).</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="s">&#34;null&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">df</span> <span class="p">:</span> <span class="n">get_dominance_frontier</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">output</span> <span class="o">+=</span> <span class="s">&#34;, &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">output</span> <span class="o">+=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">df</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å°†å‡½æ•°çš„æ§åˆ¶æµå›¾(CFG)å¯¼å‡ºä¸ºå›¾å½¢æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦å¯¼å‡ºçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°ç”Ÿæˆå‡½æ•°çš„æ§åˆ¶æµå›¾çš„DOTæ ¼å¼æè¿°ï¼Œå¹¶ä½¿ç”¨graphvizå°†å…¶è½¬æ¢ä¸ºPNGå›¾åƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {å‡½æ•°å}_cfg.dotï¼šDOTæ ¼å¼çš„å›¾å½¢æè¿°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {å‡½æ•°å}_cfg.pngï¼šå¯è§†åŒ–çš„æ§åˆ¶æµå›¾
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">dump_cfg</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">edge_set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">succ_blocks</span> <span class="o">=</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_succ_basic_blocks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">succ_blocks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">succ</span> <span class="p">:</span> <span class="n">succ_blocks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_set</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;-&gt;&#34;</span> <span class="o">+</span> <span class="n">succ</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">digraph</span> <span class="o">=</span> <span class="s">&#34;digraph G {</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_edges</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæ²¡æœ‰è¾¹ä¸”è‡³å°‘æœ‰ä¸€ä¸ªåŸºæœ¬å—ï¼Œæ·»åŠ ä¸€ä¸ªè‡ªç¯ä»¥æ˜¾ç¤ºå”¯ä¸€çš„åŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="o">&amp;</span><span class="n">bb</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">digraph</span> <span class="o">+=</span> <span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">edge</span> <span class="p">:</span> <span class="n">edge_set</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">digraph</span> <span class="o">+=</span> <span class="n">edge</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">digraph</span> <span class="o">+=</span> <span class="s">&#34;}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">file_output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_cfg.dot&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span> <span class="o">&lt;&lt;</span> <span class="n">digraph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dot_cmd</span> <span class="o">=</span> <span class="s">&#34;dot -Tpng &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_cfg.dot&#34;</span> <span class="o">+</span> <span class="s">&#34; -o &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_cfg.png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">system</span><span class="p">(</span><span class="n">dot_cmd</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å°†å‡½æ•°çš„æ”¯é…æ ‘å¯¼å‡ºä¸ºå›¾å½¢æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦å¯¼å‡ºçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°ç”Ÿæˆå‡½æ•°çš„æ”¯é…æ ‘çš„DOTæ ¼å¼æè¿°ï¼Œå¹¶ä½¿ç”¨graphvizå°†å…¶è½¬æ¢ä¸ºPNGå›¾åƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {å‡½æ•°å}_dom_tree.dotï¼šDOTæ ¼å¼çš„å›¾å½¢æè¿°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {å‡½æ•°å}_dom_tree.pngï¼šå¯è§†åŒ–çš„æ”¯é…æ ‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">dump_dominator_tree</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">edge_set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// ç”¨äºæ£€æŸ¥æ˜¯å¦æœ‰è¾¹å­˜åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">b</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">idom_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">idom_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">]</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_set</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">idom_</span><span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;-&gt;&#34;</span> <span class="o">+</span> <span class="n">b</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// å¦‚æœå­˜åœ¨æ”¯é…è¾¹ï¼Œæ ‡è®°ä¸º true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">digraph</span> <span class="o">=</span> <span class="s">&#34;digraph G {</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_edges</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæ²¡æœ‰è¾¹ä¸”è‡³å°‘æœ‰ä¸€ä¸ªåŸºæœ¬å—ï¼Œç›´æ¥æ·»åŠ è¯¥å—ä»¥æ˜¾ç¤ºå®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="o">&amp;</span><span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">digraph</span> <span class="o">+=</span> <span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">edge</span> <span class="p">:</span> <span class="n">edge_set</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">digraph</span> <span class="o">+=</span> <span class="n">edge</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">digraph</span> <span class="o">+=</span> <span class="s">&#34;}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">file_output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_dom_tree.dot&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span> <span class="o">&lt;&lt;</span> <span class="n">digraph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dot_cmd</span> <span class="o">=</span> <span class="s">&#34;dot -Tpng &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_dom_tree.dot&#34;</span> <span class="o">+</span> <span class="s">&#34; -o &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_dom_tree.png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">system</span><span class="p">(</span><span class="n">dot_cmd</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MEM2REGï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Mem2Reg.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;IRBuilder.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Instruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Value.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief Mem2Reg Passçš„ä¸»å…¥å£å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°æ‰§è¡Œå†…å­˜åˆ°å¯„å­˜å™¨çš„æå‡è¿‡ç¨‹ï¼Œå°†æ ˆä¸Šçš„å±€éƒ¨å˜é‡æå‡åˆ°SSAæ ¼å¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä¸»è¦æ­¥éª¤ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. åˆ›å»ºå¹¶è¿è¡Œæ”¯é…æ ‘åˆ†æ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. å¯¹æ¯ä¸ªéå£°æ˜å‡½æ•°ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - æ¸…ç©ºç›¸å…³æ•°æ®ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - æ’å…¥å¿…è¦çš„phiæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - æ‰§è¡Œå˜é‡é‡å‘½å
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ³¨æ„ï¼šå‡½æ•°æ‰§è¡Œåï¼Œå†—ä½™çš„å±€éƒ¨å˜é‡åˆ†é…æŒ‡ä»¤å°†ç”±åç»­çš„æ­»ä»£ç åˆ é™¤Passå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Mem2Reg</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºæ”¯é…æ ‘åˆ†æ Pass çš„å®ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dominators_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Dominators</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å»ºç«‹æ”¯é…æ ‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»¥å‡½æ•°ä¸ºå•å…ƒéå†å®ç° Mem2Reg ç®—æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">f</span> <span class="p">:</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">func_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_val_stack</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">phi_lval</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">func_</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¯¹åº”ä¼ªä»£ç ä¸­ phi æŒ‡ä»¤æ’å…¥çš„é˜¶æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">generate_phi</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¯¹åº”ä¼ªä»£ç ä¸­é‡å‘½åé˜¶æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">rename</span><span class="p">(</span><span class="n">func_</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åç»­ DeadCode å°†ç§»é™¤å†—ä½™çš„å±€éƒ¨å˜é‡çš„åˆ†é…ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief åœ¨å¿…è¦çš„ä½ç½®æ’å…¥phiæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°å®ç°äº†ç»å…¸çš„phièŠ‚ç‚¹æ’å…¥ç®—æ³•ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. æ”¶é›†å…¨å±€æ´»è·ƒå˜é‡ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - æ‰«ææ‰€æœ‰storeæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - è¯†åˆ«åœ¨å¤šä¸ªåŸºæœ¬å—ä¸­è¢«èµ‹å€¼çš„å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. æ’å…¥phiæŒ‡ä»¤ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - å¯¹æ¯ä¸ªå…¨å±€æ´»è·ƒå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - åœ¨å…¶å®šå€¼ç‚¹çš„æ”¯é…è¾¹ç•Œå¤„æ’å…¥phiæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - ä½¿ç”¨å·¥ä½œè¡¨æ³•å¤„ç†è¿­ä»£å¼çš„phiæ’å…¥
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * phiæŒ‡ä»¤çš„æ’å…¥éµå¾ªæœ€å°åŒ–åŸåˆ™ï¼Œåªåœ¨å¿…è¦çš„ä½ç½®æ’å…¥phièŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Mem2Reg</span><span class="o">::</span><span class="n">generate_phi</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// global_live_var_name æ˜¯å…¨å±€åå­—é›†åˆï¼Œä»¥ alloca å‡ºçš„å±€éƒ¨å˜é‡æ¥ç»Ÿè®¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ­¥éª¤ä¸€ï¼šæ‰¾åˆ°æ´»è·ƒåœ¨å¤šä¸ª block çš„å…¨å±€åå­—é›†åˆï¼Œä»¥åŠå®ƒä»¬æ‰€å±çš„ bb å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">global_live_var_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;&gt;</span> <span class="n">live_var_2blocks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">func_</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">var_is_killed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">instr</span> <span class="p">:</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">is_store</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// store i32 a, i32 *b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// a is r_val, b is l_val
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">auto</span> <span class="n">l_val</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">l_val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">global_live_var_name</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">l_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">live_var_2blocks</span><span class="p">[</span><span class="n">l_val</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¥éª¤äºŒï¼šä»æ”¯é…æ ‘è·å–æ”¯é…è¾¹ç•Œä¿¡æ¯ï¼Œå¹¶åœ¨å¯¹åº”ä½ç½®æ’å…¥ phi æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">,</span> <span class="n">Value</span> <span class="o">*&gt;</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb_has_var_phi</span><span class="p">;</span> <span class="c1">// bb has phi for var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">var</span> <span class="p">:</span> <span class="n">global_live_var_name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="n">work_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">work_list</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">live_var_2blocks</span><span class="p">[</span><span class="n">var</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                         <span class="n">live_var_2blocks</span><span class="p">[</span><span class="n">var</span><span class="p">].</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">work_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">work_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bb_dominance_frontier_bb</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">                 <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">get_dominance_frontier</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">bb_has_var_phi</span><span class="p">.</span><span class="n">find</span><span class="p">({</span><span class="n">bb_dominance_frontier_bb</span><span class="p">,</span> <span class="n">var</span><span class="p">})</span> <span class="o">==</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bb_has_var_phi</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// generate phi for bb_dominance_frontier_bb &amp; add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// bb_dominance_frontier_bb to work list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">auto</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">PhiInst</span><span class="o">::</span><span class="n">create_phi</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">bb_dominance_frontier_bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_lval</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bb_dominance_frontier_bb</span><span class="o">-&gt;</span><span class="n">add_instr_begin</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">work_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bb_dominance_frontier_bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bb_has_var_phi</span><span class="p">[{</span><span class="n">bb_dominance_frontier_bb</span><span class="p">,</span> <span class="n">var</span><span class="p">}]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Mem2Reg</span><span class="o">::</span><span class="n">rename</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span> <span class="o">*&gt;</span> <span class="n">wait_delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¥éª¤ä¸€ï¼šå°† phi æŒ‡ä»¤ä½œä¸º lval çš„æœ€æ–°å®šå€¼ï¼Œlval å³æ˜¯ä¸ºå±€éƒ¨å˜é‡ alloca å‡ºçš„åœ°å€ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">phi_inst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">phi_inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">load</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">loadinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">loadinst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Value</span><span class="o">*</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">loadinst</span><span class="o">-&gt;</span><span class="n">replace_all_use_with</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait_delete</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">loadinst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">storeinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">storeinst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">storeinst</span><span class="o">-&gt;</span><span class="n">get_rval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait_delete</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">storeinst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¥éª¤äºŒï¼šç”¨ lval æœ€æ–°çš„å®šå€¼æ›¿ä»£å¯¹åº”çš„loadæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ­¥éª¤ä¸‰ï¼šå°† store æŒ‡ä»¤çš„ rvalï¼Œä¹Ÿå³è¢«å­˜å…¥å†…å­˜çš„å€¼ï¼Œä½œä¸º lval çš„æœ€æ–°å®šå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¥éª¤å››ï¼šä¸º lval å¯¹åº”çš„ phi æŒ‡ä»¤å‚æ•°è¡¥å……å®Œæ•´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">succ</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_succ_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">succ</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">phi</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">Value</span> <span class="o">*</span><span class="n">rval</span> <span class="o">=</span> <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="n">phi</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¥éª¤äº”ï¼šå¯¹ bb åœ¨æ”¯é…æ ‘ä¸Šçš„æ‰€æœ‰åç»§èŠ‚ç‚¹ï¼Œé€’å½’æ‰§è¡Œ rename æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">dom_succ_blocks</span> <span class="o">=</span> <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">get_dom_tree_succ_blocks</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom_succ_blocks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">succ</span> <span class="p">:</span> <span class="n">dom_succ_blocks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rename</span><span class="p">(</span><span class="n">succ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¥éª¤å…­ï¼špopå‡º lval çš„æœ€æ–°å®šå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">storeinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">storeinst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">phiinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">phiinst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">instr</span> <span class="p">:</span> <span class="n">wait_delete</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb</span><span class="o">-&gt;</span><span class="n">erase_instr</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å¾ªç¯ä¸å˜é‡å¤–æ">å¾ªç¯ä¸å˜é‡å¤–æ
</h2><p>å¾ªç¯æ£€æµ‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;LoopDetection.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Dominators.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å¾ªç¯æ£€æµ‹Passçš„ä¸»å…¥å£å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. åˆ›å»ºæ”¯é…æ ‘åˆ†æå®ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. éå†æ¨¡å—ä¸­çš„æ‰€æœ‰å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. å¯¹æ¯ä¸ªéå£°æ˜å‡½æ•°æ‰§è¡Œå¾ªç¯æ£€æµ‹
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 4. æœ€åæ‰“å°æ£€æµ‹ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dominators_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Dominators</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">f1</span> <span class="p">:</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">func_</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_on_func</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å‘ç°å¾ªç¯åŠå…¶å­å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param bb å¾ªç¯çš„headerå—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param latches å¾ªç¯çš„å›è¾¹ç»ˆç‚¹(latch)é›†åˆ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loop å½“å‰æ­£åœ¨å¤„ç†çš„å¾ªç¯å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">discover_loop_and_sub_loops</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">BBset</span> <span class="o">&amp;</span><span class="n">latches</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO List:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1. åˆå§‹åŒ–å·¥ä½œè¡¨ï¼Œå°†æ‰€æœ‰latchå—åŠ å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. å®ç°ä¸»å¾ªç¯é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3. å¤„ç†æœªåˆ†é…ç»™ä»»ä½•å¾ªç¯çš„èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 4. å¤„ç†å·²å±äºå…¶ä»–å¾ªç¯çš„èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 5. å»ºç«‹æ­£ç¡®çš„å¾ªç¯åµŒå¥—å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">BBvec</span> <span class="n">work_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">latches</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">latches</span><span class="p">.</span><span class="n">end</span><span class="p">()};</span> <span class="c1">// åˆå§‹åŒ–å·¥ä½œè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">work_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// å½“å·¥ä½œè¡¨éç©ºæ—¶ç»§ç»­å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">work_list</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">work_list</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO-1: å¤„ç†æœªåˆ†é…ç»™ä»»ä½•å¾ªç¯çš„èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">bb_to_loop_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="n">bb_to_loop_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* åœ¨æ­¤æ·»åŠ ä»£ç ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 1. ä½¿ç”¨loop-&gt;add_blockå°†bbåŠ å…¥å½“å‰å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 2. æ›´æ–°bb_to_loop_æ˜ å°„
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 3. å°†bbçš„æ‰€æœ‰å‰é©±åŠ å…¥å·¥ä½œè¡¨
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span>
</span></span><span class="line"><span class="cl">            <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_block</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">work_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// throw std::runtime_error(&#34;Lab4: ä½ æœ‰ä¸€ä¸ªTODOéœ€è¦å®Œæˆï¼&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO-2: å¤„ç†å·²å±äºå…¶ä»–å¾ªç¯çš„èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">!=</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* åœ¨æ­¤æ·»åŠ ä»£ç ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 1. è·å–bbå½“å‰æ‰€å±çš„å¾ªç¯sub_loop
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 2. æ‰¾åˆ°sub_loopçš„æœ€é¡¶å±‚çˆ¶å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 3. æ£€æŸ¥æ˜¯å¦éœ€è¦ç»§ç»­å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 4. å»ºç«‹å¾ªç¯åµŒå¥—å…³ç³»ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">             *    - è®¾ç½®çˆ¶å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm">             *    - æ·»åŠ å­å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 5. å°†å­å¾ªç¯çš„æ‰€æœ‰åŸºæœ¬å¿«åŠ å…¥åˆ°çˆ¶å¾ªç¯ä¸­
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 6. å°†å­å¾ªç¯headerçš„å‰é©±åŠ å…¥å·¥ä½œè¡¨
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">sub_loop</span> <span class="o">=</span> <span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">parent_loop</span> <span class="o">=</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// æ‰¾åˆ°æœ€é¡¶å±‚çš„çˆ¶å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">while</span> <span class="p">(</span><span class="n">parent_loop</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">parent_loop</span> <span class="o">!=</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">sub_loop</span> <span class="o">=</span> <span class="n">parent_loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parent_loop</span> <span class="o">=</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœå½“å‰å¾ªç¯ä¸æ˜¯æœ€é¡¶å±‚çˆ¶å¾ªç¯ï¼Œåˆ™å»ºç«‹åµŒå¥—å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">parent_loop</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">set_parent</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_sub_loop</span><span class="p">(</span><span class="n">sub_loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">block</span> <span class="p">:</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">work_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// throw std::runtime_error(&#34;Lab4: ä½ æœ‰ä¸€ä¸ªTODOéœ€è¦å®Œæˆï¼&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å¯¹å•ä¸ªå‡½æ•°æ‰§è¡Œå¾ªç¯æ£€æµ‹
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f è¦åˆ†æçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ£€æµ‹å¾ªç¯ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. è¿è¡Œæ”¯é…æ ‘åˆ†æ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. æŒ‰æ”¯é…æ ‘ååºéå†æ‰€æœ‰åŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. å¯¹æ¯ä¸ªå—ï¼Œæ£€æŸ¥å…¶å‰é©±æ˜¯å¦å­˜åœ¨å›è¾¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 4. å¦‚æœå­˜åœ¨å›è¾¹ï¼Œåˆ›å»ºæ–°çš„å¾ªç¯å¹¶ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - è®¾ç½®å¾ªç¯header
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - æ·»åŠ latchèŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - å‘ç°å¾ªç¯ä½“å’Œå­å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">run_on_func</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">run_on_func</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">get_dom_post_order</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">BBset</span> <span class="n">latches</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">pred</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">is_dominate</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">pred</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// pred is a back edge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// pred -&gt; bb , pred is the latch node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">latches</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">latches</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// create loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// add latch nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">latch</span> <span class="p">:</span> <span class="n">latches</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_latch</span><span class="p">(</span><span class="n">latch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">loops_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">discover_loop_and_sub_loops</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">latches</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief æ‰“å°å¾ªç¯æ£€æµ‹çš„ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä¸ºæ¯ä¸ªæ£€æµ‹åˆ°çš„å¾ªç¯æ‰“å°ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. å¾ªç¯çš„headerå—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. å¾ªç¯åŒ…å«çš„æ‰€æœ‰åŸºæœ¬å—
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. å¾ªç¯çš„æ‰€æœ‰å­å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">print</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loop Detection Result:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">loop</span> <span class="p">:</span> <span class="n">loops_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loop header: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loop blocks: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Sub loops: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">sub_loop</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_sub_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤–æå¾ªç¯ä¸å˜é‡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;BasicBlock.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Constant.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;FuncInfo.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Function.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;GlobalVariable.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Instruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;LICM.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;PassManager.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;logging.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å¾ªç¯ä¸å˜å¼å¤–æPassçš„ä¸»å…¥å£å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">label_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">loop_detection_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">LoopDetection</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop_detection_</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_info_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">FuncInfo</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_info_</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">loop</span> <span class="p">:</span> <span class="n">loop_detection_</span><span class="o">-&gt;</span><span class="n">get_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">is_loop_done_</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">loop</span> <span class="p">:</span> <span class="n">loop_detection_</span><span class="o">-&gt;</span><span class="n">get_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">traverse_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief éå†å¾ªç¯åŠå…¶å­å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loop å½“å‰è¦å¤„ç†çš„å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">traverse_loop</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_loop_done_</span><span class="p">[</span><span class="n">loop</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_loop_done_</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">sub_loop</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_sub_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">traverse_loop</span><span class="p">(</span><span class="n">sub_loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_on_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// TODO: å®ç°collect_loop_infoå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1">// 1. éå†å½“å‰å¾ªç¯åŠå…¶å­å¾ªç¯çš„æ‰€æœ‰æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. æ”¶é›†æ‰€æœ‰æŒ‡ä»¤åˆ°loop_instructionsä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3. æ£€æŸ¥storeæŒ‡ä»¤æ˜¯å¦ä¿®æ”¹äº†å…¨å±€å˜é‡ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ åˆ°updated_globalä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1">// 4. æ£€æŸ¥æ˜¯å¦åŒ…å«éçº¯å‡½æ•°è°ƒç”¨ï¼Œå¦‚æœæœ‰åˆ™è®¾ç½®contains_impure_callä¸ºtrue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">collect_loop_info</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">loop_instructions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">updated_global</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="o">&amp;</span><span class="n">contains_impure_call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">sub_loops</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_sub_loops</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">loop_instructions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;store_inst: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">inst</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">store_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//å·¦å€¼æ˜¯åœ°å€ï¼Œå³å€¼æ˜¯å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">auto</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">store_inst</span><span class="o">-&gt;</span><span class="n">get_rval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;add gloabl&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">updated_global</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span><span class="p">(</span><span class="n">func_info_</span><span class="o">-&gt;</span><span class="n">is_pure_function</span><span class="p">(</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;contains_pure_call&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;contains_impure_call&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">sub_loop</span> <span class="p">:</span> <span class="n">sub_loops</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">loop_instructions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;store_inst: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">inst</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">store_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//å·¦å€¼æ˜¯åœ°å€ï¼Œå³å€¼æ˜¯å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">auto</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">store_inst</span><span class="o">-&gt;</span><span class="n">get_rval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;add gloabl&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">updated_global</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span><span class="p">(</span><span class="n">func_info_</span><span class="o">-&gt;</span><span class="n">is_pure_function</span><span class="p">(</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief å¯¹å•ä¸ªå¾ªç¯æ‰§è¡Œä¸å˜å¼å¤–æä¼˜åŒ–
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loop è¦ä¼˜åŒ–çš„å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">run_on_loop</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">loop_instructions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">updated_global</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect_loop_info</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">loop_instructions</span><span class="p">,</span> <span class="n">updated_global</span><span class="p">,</span> <span class="n">contains_impure_call</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">global</span> <span class="p">:</span> <span class="n">updated_global</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;updated_global: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">global</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">loop_invariant</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: è¯†åˆ«å¾ªç¯ä¸å˜å¼æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - å¦‚æœæŒ‡ä»¤å·²è¢«æ ‡è®°ä¸ºä¸å˜å¼åˆ™è·³è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - è·³è¿‡ storeã€retã€brã€phi ç­‰æŒ‡ä»¤ä¸éçº¯å‡½æ•°è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - ç‰¹æ®Šå¤„ç†å…¨å±€å˜é‡çš„ load æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - æ£€æŸ¥æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œæ•°æ˜¯å¦éƒ½æ˜¯å¾ªç¯ä¸å˜çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - å¦‚æœæœ‰æ–°çš„ä¸å˜å¼è¢«æ·»åŠ åˆ™æ³¨æ„æ›´æ–° changed æ ‡å¿—ï¼Œç»§ç»­è¿­ä»£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">changed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">inst</span> <span class="p">:</span> <span class="n">loop_instructions</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">loop_invariant</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">instr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Instruction</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">ret</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">br</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">contains_impure_call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ç‰¹æ®Šå¤„ç†å…¨å±€å˜é‡çš„loadæŒ‡ä»¤ï¼Œå¦‚æœæ˜¯å…¨å±€å˜é‡çš„loadæŒ‡ä»¤ï¼Œä¸”æ²¡æœ‰è¢«æ›´æ–°è¿‡ï¼Œåˆ™åŠ å…¥å¾ªç¯ä¸å˜å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">load</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">load_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">load_inst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;global_lval: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">lval</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">updated_global</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">==</span> <span class="n">updated_global</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;insert global inval &#34;</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">loop_invariant</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ä¸‹é¢å¯¹å…¶ä»–çš„æŒ‡ä»¤è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸åœ¨å¾ªç¯ä¸­åˆ™åŠ å…¥å¾ªç¯ä¸å˜å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//è·å¾—æ“ä½œæ•°ï¼Œé€ä¸ªæ£€æŸ¥æ˜¯ä¸æ˜¯å¸¸æ•°ï¼Œæ˜¯ä¸æ˜¯å¾ªç¯ä¸å˜å¼ï¼Œåœ¨å½“å‰å¾ªç¯ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå½“å‰å¾ªç¯æ‰¾ä¸åˆ°çš„è¯å°±æ˜¯å¾ªç¯ä¸å˜å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">bool</span> <span class="n">operands_are_invariant</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">operand</span> <span class="p">:</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_operands</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">loop_instructions</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">!=</span> <span class="n">loop_instructions</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">loop_invariant</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">operand</span><span class="p">)</span> <span class="o">==</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//å¦‚æœæ“ä½œæ•°éƒ½æ˜¯å¾ªç¯ä¸å˜å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">//å¦‚æœæœ‰ä¸€ä¸ªä¸æ˜¯å¾ªç¯ä¸å˜å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">operands_are_invariant</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">operands_are_invariant</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">loop_invariant</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ç”±äºæ˜¯é€’å½’åˆ†æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//ä¸èƒ½ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´å¾ªç¯ä¸å˜å¼çš„å¢åŠ ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªå¾ªç¯ä¸å˜å¼å¹¶ä¸æ˜¯å¾ªç¯ä¸å˜å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// bool is_invariant = true;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// for (auto operand : instr-&gt;get_operands()) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     auto it = std::find(loop_invariant.begin(), loop_invariant.end(), operand);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     if (it == loop_invariant.end()) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//         is_invariant = false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//         break;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// if (is_invariant) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     loop_invariant.push_back(inst);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     changed = true;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// throw std::runtime_error(&#34;Lab4: ä½ æœ‰ä¸€ä¸ªTODOéœ€è¦å®Œæˆï¼&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;Loop invariant not done&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">changed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;Loop invariant done&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_preheader</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å¦‚æœæ²¡æœ‰å‰ç½®å—ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;preheader&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">label_num</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">-&gt;</span><span class="n">set_preheader</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">m_</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">loop_invariant</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// insert preheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">preheader</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_preheader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">phi_inst_</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//éå†å¾ªç¯å¤´éƒ¨çš„phiæŒ‡ä»¤,å¦‚æœé‡åˆ°äº†éphiæŒ‡ä»¤åˆ™é€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">phi_inst_</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;phi_inst_:&#34; &lt;&lt; phi_inst_.print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//æ£€æŸ¥phiæŒ‡ä»¤ä¸­æ‰€æœ‰élatchçš„å‰é©±ï¼Œæ”¹ä¸ºpreheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">phi_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phi_inst_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">phi_inst</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// auto num = static_cast&lt;int&gt;(phi_inst-&gt;get_num_operand());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preheader</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//å¦‚æœæœ‰bræŒ‡ä»¤ï¼Œéœ€è¦åˆ é™¤,å› ä¸ºåé¢ä¼šé‡æ–°æ’å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">preheader</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="o">&amp;</span><span class="n">inst</span> <span class="o">=</span> <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">().</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">br</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">remove_instr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//å¦‚æœåŸæœ¬ä¸å­˜åœ¨preheaderï¼Œå³æ˜¯åˆ›å»ºçš„ç©ºçš„preheader,æ­¤æ—¶éœ€è¦åœ¨preheaderå¤„æ’å…¥ä¸€ä¸ªæ–°çš„phiæŒ‡ä»¤ç”¨äºæ›¿æ¢ï¼ŒåŒæ—¶å°†åŸphiæŒ‡ä»¤çš„å‰é©±æ”¹ä¸ºpreheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// preheader-&gt;add_instruction(phi_inst);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">new_phi</span> <span class="o">=</span> <span class="n">PhiInst</span><span class="o">::</span><span class="n">create_phi</span><span class="p">(</span><span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">(),</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">add_instruction</span><span class="p">(</span><span class="n">new_phi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(INFO) &lt;&lt; &#34;preheader&#34; &lt;&lt; preheader-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">val_bbs</span> <span class="o">=</span> <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">get_phi_pairs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">remove_all_operands</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(INFO) &lt;&lt; &#34;BEFORE phiâ€”â€”new: &#34; &lt;&lt; new_phi-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// LOG(INFO) &lt;&lt; &#34;BEFORE phi: &#34; &lt;&lt; phi_inst-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">val_bb</span> <span class="p">:</span> <span class="n">val_bbs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val_bb</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">val_new</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">val_bb</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(INFO) &lt;&lt; &#34;bb: &#34; &lt;&lt; bb-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">().</span><span class="n">begin</span><span class="p">(),</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">().</span><span class="n">end</span><span class="p">(),</span> <span class="n">bb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">().</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_phi</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val_new</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val_new</span><span class="p">,</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_phi</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: ç”¨è·³è½¬æŒ‡ä»¤é‡æ„æ§åˆ¶æµå›¾ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†æ‰€æœ‰é latch çš„ header å‰é©±å—çš„è·³è½¬æŒ‡å‘ preheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¹¶å°† preheader çš„è·³è½¬æŒ‡å‘ header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„è¿™é‡Œéœ€è¦æ›´æ–°å‰é©±å—çš„åç»§å’Œåç»§çš„å‰é©±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="n">pred_to_remove</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">latches_1</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">header</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">preds</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">preheader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error: pred is nullptr&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latches_1</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">latches_1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">latches_1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">pred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">latches_1</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//åˆ›å»ºè·³è½¬æŒ‡ä»¤é‡æ„æ§åˆ¶æµå›¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pred</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(INFO) &lt;&lt; &#34;chongjian&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="o">&amp;</span><span class="n">br_before</span> <span class="o">=</span> <span class="n">pred</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">().</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">br_before</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">br</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">br_11</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">br_before</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(INFO) &lt;&lt; &#34;br_11&#34; &lt;&lt; br_11-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">pred</span><span class="o">-&gt;</span><span class="n">remove_instr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">br_before</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;remove_instr_2: &#34; &lt;&lt; br_before.print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">br_11</span><span class="o">-&gt;</span><span class="n">is_cond_br</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">auto</span> <span class="n">br_cond</span> <span class="o">=</span> <span class="n">br_11</span><span class="o">-&gt;</span><span class="n">get_condition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">auto</span> <span class="n">false_bb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">br_11</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BranchInst</span><span class="o">::</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">br_cond</span><span class="p">,</span> <span class="n">preheader</span><span class="p">,</span> <span class="n">false_bb</span><span class="p">,</span> <span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BranchInst</span><span class="o">::</span><span class="n">create_br</span><span class="p">(</span><span class="n">preheader</span><span class="p">,</span> <span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred_to_remove</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>     
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">header</span><span class="o">-&gt;</span><span class="n">add_pre_basic_block</span><span class="p">(</span><span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">add_succ_basic_block</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">pred</span> <span class="p">:</span> <span class="n">pred_to_remove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">remove_pre_basic_block</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: å¤–æå¾ªç¯ä¸å˜æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw std::runtime_error(&#34;Lab4: ä½ æœ‰ä¸€ä¸ªTODOéœ€è¦å®Œæˆï¼&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">inst</span> <span class="p">:</span> <span class="n">loop_invariant</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;loop_invariant: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">instr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Instruction</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">instr</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">preheader</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//éå†åŸºæœ¬å—ï¼Œæ‰¾åˆ°instræ‰€åœ¨çš„åŸºæœ¬å—,å¹¶å°†insträ»åŸåŸºæœ¬å—ä¸­åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bb</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span> <span class="o">==</span> <span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bb</span><span class="o">-&gt;</span><span class="n">remove_instr</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;remove_instr_1: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">add_instruction</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// insert preheader br to header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BranchInst</span><span class="o">::</span><span class="n">create_br</span><span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">(),</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// insert preheader to parent loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_block</span><span class="p">(</span><span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/compiler-review/">
        
        
            <div class="article-image">
                
                    <img src="/post/001.png" loading="lazy" data-key="compiler-review" data-hash="/post/001.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ç¼–è¯‘åŸç†çŸ¥è¯†å¤ä¹ </h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <link
rel="stylesheet"
href="https://unpkg.com/@waline/client@v3/dist/waline.css"
/>

<div id="waline" class="waline-container"></div>

<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
       color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

    init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili","https://npm.elemecdn.com/@waline/emojis@1.1.0/bmoji","https://npm.elemecdn.com/@waline/emojis@1.1.0/weibo"],"lang":"zh-CN","locale":{"admin":"ç«™é•¿","placeholder":"è¿˜æ²¡æœ‰äººè¯„è®ºå“¦ï¼å¿«æ¥æŠ¢æ²™å‘å§~"},"placeholder":"æ¬¢è¿ç•™ä¸‹å®è´µçš„è¯„è®ºï¼","requiredMeta":["name","email","url"],"serverURL":"https://wilinetest-qw2k7t4q4-zhuyh1139s-projects.vercel.app/","visitor":true});
  </script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 Example Person
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.05855e03984e0c21563e042e67eb3d1dbf10a0e7f128d98ef596b3fcb29bf3fa.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script>
  const cdnPath = 'https://cdn.jsdelivr.net/gh/letere-gzj/live2d-widget-v3@main';
  const config = {
    
    path: {
      modelPath: cdnPath + "/Resources/",
      cssPath: cdnPath + "/waifu.css",
      tipsJsonPath: cdnPath + "/waifu-tips.json",
      tipsJsPath: cdnPath + "/waifu-tips.js",
      live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
      live2dSdkPath: cdnPath + "/live2d-sdk.js"
    },
    
    tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "info", "quit"],
    
    drag: {
      enable: true,
      direction: ["x", "y"]
    },
    
    switchType: "order"
  }

  
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      initWidget({
        waifuPath: config.path.tipsJsonPath,
        cdnPath: config.path.modelPath,
        tools: config.tools,
        dragEnable: config.drag.enable,
        dragDirection: config.drag.direction,
        switchType: config.switchType
      });
    });
  }

  
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      }
      else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => resolve(url);
        tag.onerror = () => reject(url);
        document.head.appendChild(tag);
      }
    });
  }
</script>
<script src=http://localhost:1313/background/sakura.js></script>



<style>
  #TableOfContents > ul, ol {
      ul, ol {
          display: none;
      }
      .open {
          display: block;
      }
  }
</style>

<script>
  function initTocHide() {
      
      let toc = document.querySelector(".widget--toc");
      if (!toc) {
          return;
      }
      
      window.addEventListener('scroll', function() {
          
          let openUl = document.querySelectorAll(".open");
          if (openUl.length > 0) {
            openUl.forEach((ul) => {
              ul.classList.remove("open")
            })
          }
          
          let currentLi = document.querySelector(".active-class");
          if (!currentLi) {
              return
          }
          
          if (currentLi.children.length > 1) {
              currentLi.children[1].classList.add("open")
          }
          
          let ul = currentLi.parentElement;
          do {
              ul.classList.add("open");
              ul = ul.parentElement.parentElement
          } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
      });
  }
  initTocHide()
</script>


<style>
  #backTopBtn {
      display: none;
      position: fixed;
      bottom: 30px;
      z-index: 99;
      cursor: pointer;
      width: 30px;
      height: 30px;
      background-image: url(http://localhost:1313/icons/backTop.svg);
  }
</style>

<script>
  

  function initScrollTop() {
      let rightSideBar = document.querySelector(".right-sidebar");
      if (!rightSideBar) {
          return;
      }
      
      let btn = document.createElement("div");
      btn.id = "backTopBtn";
      btn.onclick = backToTop
      rightSideBar.appendChild(btn)
      
      window.onscroll = function() {
          
          if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
              btn.style.display = "block";
          } else {
              btn.style.display = "none";
          }
      };
  }

  

  function backToTop(){
      window.scrollTo({ top: 0, behavior: "smooth" })
  }

  initScrollTop();
</script>

<style>
  .highlight {
       
      max-height: 400px;
      overflow: hidden;
  }

  .code-show {
      max-height: none !important;
  }

  .code-more-box {
      width: 100%;
      padding-top: 78px;
      background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(#fff));
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
  }

  .code-more-btn {
      display: block;
      margin: auto;
      width: 44px;
      height: 22px;
      background: #f0f0f5;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      padding-top: 6px;
      cursor: pointer;
  }

  .code-more-img {
      cursor: pointer !important;
      display: block;
      margin: auto;
      width: 22px;
      height: 16px;
  }
</style>

<script>
function initCodeMoreBox() {
  let codeBlocks = document.querySelectorAll(".highlight");
  if (!codeBlocks) {
    return;
  }
  codeBlocks.forEach(codeBlock => {
    
    if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
      return;
    }
    
    
    let codeMoreBox = document.createElement('div');
    codeMoreBox.classList.add('code-more-box');
    
    let codeMoreBtn = document.createElement('span');
    codeMoreBtn.classList.add('code-more-btn');
    codeMoreBtn.addEventListener('click', () => {
      codeBlock.classList.add('code-show');
      codeMoreBox.style.display = 'none';
    })
    
    let img = document.createElement('img');
    img.classList.add('code-more-img');
    img.src = "http://localhost:1313/icons/codeMore.png"
    
    codeMoreBtn.appendChild(img);
    codeMoreBox.appendChild(codeMoreBtn);
    codeBlock.appendChild(codeMoreBox)
  })
}

initCodeMoreBox();
</script>

    </body>
</html>
