<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="此为笔者编译原理实验所做，仅供学习交流使用。\n环境：ubuntu 22.04\n相关配置: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB\n上述环境与软件配置这里不做过多介绍\n完整项目：Zhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.\n代码解释都在注释中，就不费篇幅了。\n">
<title>手动搭建编译器  基于龙芯汇编与LIGHTIR中间代码</title>

<link rel='canonical' href='http://localhost:1313/p/compiler/'>

<link rel="stylesheet" href="/scss/style.min.79778804a771dc130d7089f1049b111129b334d4d5d3505894a60cd3735cf7b6.css"><meta property='og:title' content="手动搭建编译器  基于龙芯汇编与LIGHTIR中间代码">
<meta property='og:description' content="此为笔者编译原理实验所做，仅供学习交流使用。\n环境：ubuntu 22.04\n相关配置: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB\n上述环境与软件配置这里不做过多介绍\n完整项目：Zhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.\n代码解释都在注释中，就不费篇幅了。\n">
<meta property='og:url' content='http://localhost:1313/p/compiler/'>
<meta property='og:site_name' content='陌辞咖啡馆'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-01-24T17:50:13&#43;08:00'/><meta property='article:modified_time' content='2025-01-24T17:50:13&#43;08:00'/><meta property='og:image' content='http://localhost:1313/post/005.png' />
<meta name="twitter:title" content="手动搭建编译器  基于龙芯汇编与LIGHTIR中间代码">
<meta name="twitter:description" content="此为笔者编译原理实验所做，仅供学习交流使用。\n环境：ubuntu 22.04\n相关配置: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB\n上述环境与软件配置这里不做过多介绍\n完整项目：Zhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.\n代码解释都在注释中，就不费篇幅了。\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/post/005.png' /><link rel="alternate" type="application/json" href="http://localhost:1313/p/compiler/index.json">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/222_hu15625150182145111778.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">陌辞咖啡馆</a></h1>
            <h2 class="site-description">观我旧往，同我仰春</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/Zhuyh1139'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://space.bilibili.com/527591205'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1735383931276" class="icon" viewBox="0 0 1638 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5443" stroke="currentColor" xmlns:xlink="http://www.w3.org/1999/xlink" width="319.921875" height="200"><path d="M1226.1376 379.392c4.1472 0.768 36.7104-6.656 38.0928-4.1472 2.048 3.1232 16.5888 109.1584 12.8 109.824a2040.32 2040.32 0 0 0-30.8224 7.0656c-2.048-14.4384-19.712-103.5776-20.0704-112.6912z m51.9168-10.1376l14.1824 114.0736c7.2704-0.3584 36.7104-2.4576 39.4752-2.816a13869.568 13869.568 0 0 0-11.4176-111.2576 106.9056 106.9056 0 0 0-42.24 0z m-28.0064 158.3104s64-16.4864 87.1936-8.448c11.776 43.2128 33.28 285.3888 35.328 295.2192-14.5408 1.7408-62.3104 5.9392-66.0992 7.0144-3.1232-18.2784-56.4224-282.2144-56.4224-293.7856z m237.1072-145.3056c3.7888 1.024 37.7344-3.5328 38.0928-1.024 0.6656 8.3968 4.096 110.1824 0.3584 110.5408l-30.8224 2.7648c-0.7168-14.0288-8.3456-102.8096-7.6288-112.2816z m52.2752-2.816l2.7648 112.64c7.2704 0 36.352 1.792 39.424 1.4336-0.6656-43.1616 0-111.2576 0-111.2576a188.672 188.672 0 0 0-42.1888-2.816z m-44.6464 151.296s65.4336-8.8064 87.552 1.7408c4.864 50.5344 4.1472 286.0544 4.864 295.8848-14.848 0-62.3104 0.7168-66.0992 1.3824-0.7168-18.2272-27.392-287.4368-26.3168-299.008zM1342.8224 241.152c37.7344 195.1232 66.4576 528.5888 67.4816 549.9904 0 0 29.7472 0.7168 63.3344 2.816-19.712-210.2272-43.9296-546.1504-43.6224-557.056-8.2944-9.4208-87.1936 4.2496-87.1936 4.2496z m-83.0976 461.568c-7.2704-54.784-200.448-116.8896-309.1456-96.8704 0 0-13.5168-120.7808-18.688-237.6192a2458.7264 2458.7264 0 0 1 0.3584-214.1184c-7.2704-5.2736-85.504 32.6144-127.744 48.4352 0 0 50.5344 216.8832 87.2448 666.88 0 0 58.4704 6.2976 158.8736-13.312 100.352-19.6608 219.136-81.1008 209.1008-153.3952z m-236.0832 98.6112l-16.9472-123.904c4.096-2.0992 108.3392 37.2224 119.3984 44.2368-1.7408 7.68-102.4512 79.6672-102.4512 79.6672zM421.632 379.4432c4.1472 0.7168 36.7104-6.656 38.0928-4.1984 2.048 3.1232 16.5888 109.1584 12.8 109.824-3.7888 0.7168-30.8224 7.0656-30.8224 7.0656-2.048-14.4384-19.712-103.5776-20.0704-112.6912z m51.9168-10.1888l14.1824 114.0736c7.2704-0.3584 36.7104-2.4576 39.4752-2.816-4.5056-43.1616-11.4176-111.2576-11.4176-111.2576a106.9568 106.9568 0 0 0-42.24 0z m-28.0064 158.3104s64-16.4864 87.2448-8.448c11.776 43.2128 33.2288 285.3888 35.328 295.2192-14.592 1.7408-62.3616 5.9392-66.1504 7.0144-3.1232-18.2784-56.4224-282.2144-56.4224-293.7856z m237.1072-145.3056c3.7888 1.024 37.7344-3.5328 38.0928-1.024 0.6656 8.3968 4.096 110.1824 0.3584 110.5408l-30.8224 2.7648c-0.7168-14.0288-7.9872-102.8096-7.6288-112.2816z m52.2752-2.816l2.7648 112.64c7.2704 0 36.352 1.792 39.424 1.4336-0.6656-43.1616 0-111.2576 0-111.2576a211.9168 211.9168 0 0 0-42.1888-2.816z m-44.6464 151.296s65.4336-8.8064 87.552 1.7408c4.864 50.5344 4.1984 286.0544 4.864 295.8848-14.848 0-62.3104 0.7168-66.0992 1.3824-0.3584-18.2272-27.392-287.4368-26.3168-299.008zM538.3168 241.152c37.7344 195.1232 66.4576 528.5888 67.4816 549.9904 0 0 29.7984 0.7168 63.3344 2.816-19.712-210.2272-43.9296-546.1504-43.6224-557.3632-8.2944-9.1648-87.1936 4.5568-87.1936 4.5568zM455.168 702.72c-7.2704-54.784-200.448-116.8896-309.1456-96.8704 0 0-13.4656-120.7808-18.688-237.6192a2459.7504 2459.7504 0 0 1 0.3584-214.1184c-7.2704-4.9152-85.504 32.6144-127.744 48.4352 0 0 50.5344 216.8832 87.2448 666.88 0 0 58.4704 6.2976 158.8736-13.312 100.352-19.6608 219.136-81.1008 209.1008-153.3952zM219.136 801.28l-16.9472-123.904c4.096-2.0992 108.3392 37.2224 119.3984 44.2368-1.7408 7.68-102.4512 79.6672-102.4512 79.6672z" fill="currentColor" p-id="5444"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://blog.csdn.net/2301_77127818?spm=1010.2135.3001.5421'
                        target="_blank"
                        title="CSDN"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1735810899052" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5554" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M672.299893 374.246613c-30.004361-6.185886-61.073984-9.064446-91.749634-9.685593-41.186028-0.835018-41.774429 0.635473-46.343491 40.450271-5.634324 49.097208-10.223852 98.314143-15.640212 151.144372 31.054273 0.64673 60.628846 2.199085 90.162486 1.626034 32.461319-0.629333 63.944358-6.411013 90.443895-27.424606 29.843702-23.666002 39.58967-55.474452 34.120099-91.764983C728.039381 403.724994 705.951317 381.184629 672.299893 374.246613zM657.900951 500.909407c-23.899316 18.074657-51.306526 20.665669-82.688257 16.613376 3.77907-38.039361 7.468089-75.166957 11.500938-115.768677 18.166755 1.276063 34.453696 1.294482 50.341548 3.818979 20.170388 3.204995 36.021401 13.485129 40.776705 34.985816C683.099866 464.37533 678.124552 485.615073 657.900951 500.909407zM503.672334 369.780905c-1.798972 13.027711-3.473101 25.15082-5.205559 37.702694-25.127284-2.170432-49.036833-5.149277-73.019037-5.934153-12.665461-0.414439-25.856901 1.651616-38.011732 5.276167-5.569856 1.660826-9.213849 9.779737-13.731746 14.969946 4.811586 4.14132 8.978489 10.243295 14.548344 12.07092 20.290115 6.65763 41.37534 10.943236 61.541635 17.912975 21.155832 7.312546 42.117237 17.118889 43.12417 43.801599 1.025353 27.151383-17.099447 42.173518-39.515992 51.339272-49.971112 20.434401-101.250008 18.301831-152.551418 5.27412-2.898003-0.735757-6.615675-6.172583-6.522554-9.320273 0.313132-10.570753 2.179642-21.095457 3.244904-29.927613 30.601972 2.39556 60.002582 5.354961 89.476871 6.611581 9.122775 0.388856 19.11229-2.468215 27.425629-6.486738 5.1503-2.489704 10.989285-10.093892 10.780531-15.165398-0.184195-4.474918-7.630794-10.624988-13.091156-12.520151-13.767562-4.780887-28.474518-6.819313-42.334177-11.387351-13.833053-4.558829-27.958772-9.378601-40.431851-16.687054-29.591969-17.339924-31.312146-47.346331-4.841262-69.316715 20.354584-16.893762 44.992727-22.240537 70.433142-25.527396C426.702312 358.37104 479.267505 361.432773 503.672334 369.780905zM959.473381 445.082938c-2.599198 35.797297-7.000438 71.464635-10.664897 107.833961-19.322068 0-37.140898 0-57.091276 0 3.668553-34.127262 6.729262-67.476811 10.968819-100.67491 4.237511-33.18275-7.367805-47.762817-40.654932-48.962132-40.755216-1.468444-40.883129-1.482771-45.26595 38.807864-3.950985 36.326347-7.580652 72.687486-11.507078 110.530372-19.435655 0-37.172621 0-55.32812 0 5.699816-58.20361 11.107989-115.27749 17.277502-172.269505 0.410346-3.78828 6.15007-9.250688 10.17985-10.045797 38.780235-7.6574 77.796854-12.57848 117.373221-6.016017C941.27081 371.999432 962.885084 398.084531 959.473381 445.082938zM251.989151 359.040283c11.636015 0.905626 23.165606 3.169179 35.938514 4.976338-1.662873 15.230889-3.163039 28.963659-4.333702 39.687908-30.569226 0-58.112536-1.639337-85.379553 0.411369-34.80469 2.616594-56.879452 20.388353-63.36926 46.690392-8.036024 32.567743 5.16258 57.6807 38.144762 63.129806 25.119097 4.149507 51.359738 1.601474 77.102029 1.802042 4.854565 0.037862 9.718339-1.010003 13.933337-1.483794 1.093914 1.38044 1.75804 1.827625 1.74883 2.260483-0.845251 41.947368-0.855484 43.796482-42.837644 43.626613-31.178093-0.125867-63.113433-2.62171-93.28971-9.93221-33.339316-8.077979-58.892295-29.67588-64.336284-66.284659-5.77554-38.832424 10.547217-69.608358 41.553395-91.998297C150.319587 360.548636 200.264093 355.014596 251.989151 359.040283z" p-id="5555"></path><path d="M137.883347 595.666538l-1.199315 1.499144c6.715959 8.794293 15.628956 15.409968 26.742061 19.847024-1.239224 1.759063-2.298346 3.357468-3.177366 4.797259-10.553357-5.196349-19.407002-12.172227-26.561959-20.925588-6.116301 7.91425-15.150048 15.150048-27.101241 21.705348-0.799202-1.358951-1.798972-2.858094-2.998287-4.497431 12.351306-6.196119 21.684882-13.670348 28.000728-22.424732L137.883347 595.667561zM106.34505 646.871757l24.762987 0 0-10.432607-19.426445 0 0-4.376681 19.426445 0 0-9.233292-17.207917 0 0-4.376681 39.45357 0 0 4.376681-17.268292 0 0 9.233292 19.48682 0 0 4.376681-19.48682 0 0 10.432607 24.703635 0 0 4.437056-54.44296 0L106.346073 646.871757zM195.804525 642.434701c2.698458-0.279363 5.536087-0.60989 8.513908-0.989537l0-18.138102-7.374968 0 0-4.317329 7.374968 0 0-14.090926-8.154727 0 0-4.317329 20.506033 0 0 4.317329-7.974625 0 0 14.090926 6.955412 0 0 4.317329-6.955412 0 0 17.568121c2.39863-0.339738 4.876054-0.699941 7.435343-1.079588-0.160659 1.599428-0.25992 3.137457-0.299829 4.617158-7.475252 0.959861-13.950733 1.858324-19.426445 2.698458L195.804525 642.434701zM216.430284 638.536928c5.216815-3.177366 10.673084-6.715959 16.368806-10.612709L232.79909 610.476849l-15.349593 0 0-4.317329 15.349593 0 0-10.673084 4.556783 0 0 10.673084 17.028838 0 0 4.317329-17.028838 0 0 5.336542c0.99977 3.27765 2.168386 6.315846 3.507894 9.113565 3.457752-3.357468 6.345522-6.456039 8.664334-9.293667l3.897773 3.298116c-3.298116 3.258207-6.804986 6.5553-10.522658 9.893324 3.477194 6.016017 7.804756 10.673084 12.981662 13.970176-0.239454 0.360204-0.760317 0.979304-1.558495 1.858324-0.880043 0.918929-1.499144 1.639337-1.858324 2.158153-6.5553-4.736884-11.592013-11.552104-15.110139-20.445658l0 19.367093c0 4.756327-2.478448 7.135514-7.435343 7.135514-1.959631 0-4.057409-0.020466-6.29538-0.060375-0.239454-1.518586-0.559748-3.157923-0.959861-4.916986 2.357697 0.279363 4.497431 0.419556 6.41613 0.419556 2.477424 0 3.717671-1.218758 3.717671-3.657296l0-11.422144c-4.137227 2.87856-8.593725 6.085602-13.370519 9.623171L216.430284 638.536928zM217.749326 616.891955l3.657296-2.218528c2.598174 3.397377 5.175883 7.154957 7.735172 11.272741l-3.837398 2.638083C222.545562 623.907743 220.028229 620.009969 217.749326 616.891955zM240.593614 599.024006l2.638083-2.998287c2.837628 1.87879 5.435803 3.816932 7.794523 5.816472l-2.87856 3.298116C245.789962 602.941222 243.271606 600.902796 240.593614 599.024006zM288.621467 646.152373c1.958608-0.199545 3.917216-0.409322 5.875824-0.629333l0-22.814612-6.595208 0 0-3.597945 59.419298 0 0 3.597945-31.298843 0 0 19.996426c1.918699-0.279363 3.837398-0.569982 5.756097-0.86981-0.040932 0.719384-0.020466 1.998517 0.060375 3.837398-1.87879 0.25992-3.817955 0.530073-5.816472 0.809435l0 7.645121-4.076852 0 0-7.045463c-6.875594 0.979304-14.290471 2.088568-22.24463 3.327792L288.621467 646.152373zM296.955272 597.405135l41.491996 0 0 19.247366-4.197602 0 0-1.379417L301.152874 615.273085l0 1.379417-4.197602 0L296.955272 597.405135zM298.574143 627.504664l13.370519 0 0-4.797259L298.574143 622.707404 298.574143 627.504664zM298.574143 635.779118l13.370519 0 0-4.797259L298.574143 630.981858 298.574143 635.779118zM311.945685 643.304512l0-4.047176L298.574143 639.257336l0 5.785773C303.091016 644.502803 307.548538 643.923612 311.945685 643.304512zM334.25069 600.883353 301.152874 600.883353l0 3.837398 33.097816 0L334.25069 600.883353zM301.152874 611.79589l33.097816 0 0-3.837398L301.152874 607.958492 301.152874 611.79589zM319.020824 630.442576l0-3.477194 23.804149 0 0 3.477194c-2.038426 4.89652-4.717442 9.153474-8.035 12.770861 3.417843 2.49789 7.65433 4.397147 12.71151 5.695722-1.039679 1.518586-1.939165 2.918469-2.698458 4.197602-5.15644-1.698688-9.503445-3.997034-13.041014-6.895037-3.437286 3.078105-7.445576 5.596462-12.021801 7.55507-0.679475-1.199315-1.599428-2.457981-2.75781-3.777023 4.53734-1.738597 8.443299-3.957125 11.721973-6.655584-3.338025-3.577478-5.716188-7.874341-7.135514-12.891611L319.020824 630.442576zM338.267167 630.442576l-12.651135 0c1.258667 3.937682 3.28686 7.305383 6.085602 10.103102C334.479911 637.628232 336.667739 634.260531 338.267167 630.442576zM379.939265 649.149637c16.488533-7.335059 25.382087-18.34788 26.681686-33.037441l-25.603121 0 0-4.676509 25.812899 0c0.100284-5.376451 0.149403-10.79281 0.149403-16.249079l5.216815 0c0 5.376451-0.050142 10.79281-0.149403 16.249079l26.591635 0 0 4.676509-26.681686 0c2.837628 15.968693 12.151761 26.501584 27.941376 31.598672-2.038426 1.958608-3.558036 3.577478-4.556783 4.856611-13.011338-5.236258-21.515013-14.560624-25.51307-27.971052-3.118014 12.131295-11.841699 21.85475-26.172079 29.170366C382.857734 652.688229 381.618511 651.149177 379.939265 649.149637zM476.234425 607.77839l23.084765 0 0-13.07069 5.15644 0 0 13.07069 23.324218 0 0 27.341718-4.916986 0 0-3.237741-18.407232 0 0 22.305005-5.15644 0 0-22.305005-18.167778 0 0 3.237741-4.916986 0L476.234425 607.77839zM481.150388 627.445312l18.167778 0 0-15.229866-18.167778 0L481.150388 627.445312zM522.882861 612.215446l-18.407232 0 0 15.229866 18.407232 0L522.882861 612.215446zM565.153594 605.199659l28.780487 0c-2.018983-3.837398-3.597945-6.635117-4.736884-8.394181l4.617158-2.158153c1.119497 1.719154 2.797719 4.516874 5.036713 8.394181l-4.317329 2.158153 28.180829 0 0 4.437056-11.062963 0c-2.13871 11.411911-6.735401 20.585851-13.791098 27.52182 5.316076 3.877307 13.760398 7.355525 25.332968 10.432607-1.838881 2.078335-3.237741 3.816932-4.197602 5.216815-11.272741-3.897773-19.596314-7.974625-24.972764-12.231579-5.395894 4.197602-14.020318 8.43409-25.872251 12.71151-1.039679-1.39886-2.238994-2.958378-3.597945-4.676509 11.432377-3.437286 20.036335-7.265474 25.812899-11.482519-7.29515-7.794523-11.93175-16.95823-13.910824-27.491121l-11.302417 0L565.152571 605.199659zM606.525863 609.636714l-25.272593 0c1.798972 9.832949 6.095835 17.958 12.891611 24.373107C600.639806 627.974361 604.7668 619.850333 606.525863 609.636714zM671.851685 604.50995l-4.466732 0 0 36.305881 4.466732 0 0 5.066389-14.930037 0 0-5.066389 4.466732 0 0-36.305881-4.466732 0 0-5.066389 14.930037 0L671.851685 604.50995zM738.196719 604.780103l-13.401218 0 0 41.102117-6.02625 0 0-41.102117-13.340843 0 0-5.336542 32.767288 0L738.195695 604.780103zM771.71409 611.496062l0-4.317329 19.48682 0 0 4.437056c-1.939165 3.877307-4.237511 7.544837-6.895037 11.002588l0 30.908964-4.676509 0 0-25.482371c-2.198062 2.318812-4.577249 4.516874-7.135514 6.595208-0.360204-1.438769-0.918929-3.097548-1.679245-4.976338 6.15621-4.956895 11.252275-11.012821 15.289218-18.167778L771.71409 611.496062zM777.649266 597.105307l4.197602-2.098801c1.478677 2.358721 3.038196 5.096065 4.676509 8.214079l-4.437056 2.278903C780.527826 602.261747 779.049149 599.464027 777.649266 597.105307zM785.024234 625.946168l3.118014-2.578732c2.438539 2.717901 4.657067 5.296633 6.655584 7.735172l-3.717671 2.937912C789.161461 631.28271 787.143501 628.584252 785.024234 625.946168zM791.20091 646.991484l16.848737 0 0-29.380144-14.270005 0 0-4.676509 14.270005 0 0-17.568121 4.797259 0 0 17.568121 15.229866 0 0 4.676509-15.229866 0 0 29.380144 17.028838 0 0 4.676509-38.673811 0L791.201933 646.991484zM867.8885 599.143733l51.565423 0 0 4.676509-46.468334 0 0 41.851177 47.428196 0 0 4.556783-52.524261 0L867.889523 599.143733zM877.601722 610.416474l3.357468-3.177366c4.996804 4.116761 10.222829 8.634658 15.679098 13.550621 4.177136-4.516874 8.184403-9.43386 12.021801-14.749936l4.376681 2.937912c-4.197602 5.436826-8.454556 10.472516-12.770861 15.110139 4.976338 4.53734 10.132778 9.393951 15.46932 14.569834l-4.137227 4.197602c-4.837168-5.056156-9.813506-10.05296-14.930037-14.989389-5.776563 5.856381-11.652388 11.012821-17.628496 15.46932-0.959861-1.239224-2.238994-2.537799-3.837398-3.897773 6.275937-4.27742 12.241812-9.263991 17.897625-14.959713C888.084471 619.739816 882.918821 615.053074 877.601722 610.416474z" fill="currentColor" p-id="5556"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#mem2reg">MEM2REG</a></li>
    <li><a href="#循环不变量外提">循环不变量外提</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/compiler/">
                
                    <img src="/post/005.png" loading="lazy" alt="Featured image of post 手动搭建编译器  基于龙芯汇编与LIGHTIR中间代码" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" >
                编译原理
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/compiler/">手动搭建编译器  基于龙芯汇编与LIGHTIR中间代码</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 24, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 41 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>此为笔者编译原理实验所做，仅供学习交流使用。</p>
<blockquote>
<p>环境：ubuntu 22.04</p>
<p>相关配置: LLVM,Clang,Git,build-essential,Cmake,Flex,Bison,GDB</p>
<p>上述环境与软件配置这里不做过多介绍</p>
</blockquote>
<p>完整项目：<a class="link" href="https://github.com/Zhuyh1139/Compiler"  target="_blank" rel="noopener"
    >Zhuyh1139/Compiler: This is ustc 2024 fall compiler course labs.</a></p>
<p>代码解释都在注释中，就不费篇幅了。</p>
<h1 id="词法分析器">词法分析器
</h1><p>即用正则表达式的形式将Cminusf进行分词操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">%</span><span class="n">option</span> <span class="n">noyywrap</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*****************声明和选项设置  begin*****************/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;syntax_tree.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;syntax_analyzer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">lines</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pos_start</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pos_end</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">pass_node</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">     <span class="n">yylval</span><span class="p">.</span><span class="n">node</span> <span class="o">=</span> <span class="nf">new_syntax_tree_node</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*****************声明和选项设置  end*****************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">x</span> <span class="n">COMMENT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span><span class="line"><span class="cl"> <span class="cm">/* to do for students */</span>
</span></span><span class="line"><span class="cl"> <span class="cm">/* two cases for you, pass_node will send flex&#39;s token to bison */</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">+</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">ADD</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="cm">/****请在此补全所有flex的模式与动作  end******/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">-</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">SUB</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">*</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">MUL</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">/</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">DIV</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&lt;</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&lt;=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LTE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&gt;</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">GT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="o">&gt;=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">GTE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">EQ</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">!=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">NEQ</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">ASSIN</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">SEMICOLON</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">,</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">COMMA</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">(</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LPARENTHESE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">)</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RPARENTHESE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">[</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LBRACKET</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">]</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RBRACKET</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">{</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">LBRACE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="p">}</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RBRACE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">ELSE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">IF</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">INT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span>   <span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">FLOAT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">RETURN</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">VOID</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">WHILE</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="o">+</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">IDENTIFIER</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span>	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">INTEGER</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="err">\</span><span class="p">.[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">*|</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="err">\</span><span class="p">.[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span> <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="nf">pass_node</span><span class="p">(</span><span class="n">yytext</span><span class="p">);</span> <span class="k">return</span> <span class="n">FLOATPOINT</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">\</span><span class="n">n</span> 	<span class="p">{</span><span class="n">lines</span><span class="o">++</span><span class="p">;</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="err">\</span><span class="n">t</span><span class="p">]</span> 	<span class="p">{</span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;/*&#34;</span>             <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="n">COMMENT</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">COMMENT</span><span class="o">&gt;</span><span class="s">&#34;*/&#34;</span>    <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="n">INITIAL</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">COMMENT</span><span class="o">&gt;</span><span class="p">.</span>  <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_start</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">COMMENT</span><span class="o">&gt;</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pos_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">lines</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span> <span class="p">{</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span><span class="p">;</span> <span class="n">pos_end</span><span class="o">++</span><span class="p">;</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其作用为：</p>
<p>文本输入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Token</span>         <span class="n">Text</span>      <span class="n">Line</span>    <span class="nf">Column</span> <span class="p">(</span><span class="n">Start</span><span class="p">,</span><span class="n">End</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">282</span>           <span class="kt">void</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">284</span>           <span class="n">main</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">272</span>              <span class="p">(</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">282</span>           <span class="kt">void</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">273</span>              <span class="p">)</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">276</span>              <span class="p">{</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">281</span>         <span class="k">return</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">270</span>              <span class="p">;</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">277</span>              <span class="p">}</span>      <span class="mi">1</span>       <span class="p">(</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="语法分析器">语法分析器
</h1><p>Cminusf的语法和C的语法大致相同：</p>
<ol>
<li>program→declaration-listprogram→declaration-list</li>
<li>declaration-list→declaration-list declaration ∣ declarationdeclaration-list→declaration-list declaration ∣ declaration</li>
<li>declaration→var-declaration ∣ fun-declarationdeclaration→var-declaration ∣ fun-declaration</li>
<li>var-declaration →type-specifier ID‾ ;‾ ∣ type-specifier ID‾ [‾ INTEGER‾ ]‾ ;‾var-declaration →type-specifier <strong>ID</strong> <strong>;</strong> ∣ type-specifier <strong>ID</strong> <strong>[</strong> <strong>INTEGER</strong> <strong>]</strong> <strong>;</strong></li>
<li>type-specifier→int‾ ∣ float‾ ∣ void‾type-specifier→<strong>int</strong> ∣ <strong>float</strong> ∣ <strong>void</strong></li>
<li>fun-declaration→type-specifier ID‾ (‾ params )‾ compound-stmtfun-declaration→type-specifier <strong>ID</strong> <strong>(</strong> params <strong>)</strong> compound-stmt</li>
<li>params→param-list ∣ void‾params→param-list ∣ <strong>void</strong></li>
<li>param-list→param-list ,‾ param ∣ paramparam-list→param-list <strong>,</strong> param ∣ param</li>
<li>param→type-specifier ID‾ ∣ type-specifier ID‾ [‾ ]‾param→type-specifier <strong>ID</strong> ∣ type-specifier <strong>ID</strong> <strong>[</strong> <strong>]</strong></li>
<li>compound-stmt→{‾ local-declarations statement-list }‾compound-stmt→<strong>{</strong> local-declarations statement-list <strong>}</strong></li>
<li>local-declarations→local-declarations var-declaration ∣ emptylocal-declarations→local-declarations var-declaration ∣ empty</li>
<li>statement-list→statement-list statement ∣ emptystatement-list→statement-list statement ∣ empty</li>
<li>statement→ expression-stmt∣ compound-stmt∣ selection-stmt∣ iteration-stmt∣ return-stmtstatement→ expression-stmt∣ compound-stmt∣ selection-stmt∣ iteration-stmt∣ return-stmt</li>
<li>expression-stmt→expression ;‾ ∣ ;‾expression-stmt→expression <strong>;</strong> ∣ <strong>;</strong></li>
<li>selection-stmt→ if‾ (‾ expression )‾ statement∣ if‾ (‾ expression )‾ statement else‾ statementselection-stmt→ <strong>if</strong> <strong>(</strong> expression <strong>)</strong> statement∣ <strong>if</strong> <strong>(</strong> expression <strong>)</strong> statement <strong>else</strong> statement</li>
<li>iteration-stmt→while‾ (‾ expression )‾ statementiteration-stmt→<strong>while</strong> <strong>(</strong> expression <strong>)</strong> statement</li>
<li>return-stmt→return‾ ;‾ ∣ return‾ expression ;‾return-stmt→<strong>return</strong> <strong>;</strong> ∣ <strong>return</strong> expression <strong>;</strong></li>
<li>expression→var =‾ expression ∣ simple-expressionexpression→var <strong>=</strong> expression ∣ simple-expression</li>
<li>var→ID‾ ∣ ID‾ [‾ expression]‾var→<strong>ID</strong> ∣ <strong>ID</strong> <strong>[</strong> expression**]**</li>
<li>simple-expression→additive-expression relop additive-expression ∣ additive-expressionsimple-expression→additive-expression relop additive-expression ∣ additive-expression</li>
<li>relop →&lt;=‾ ∣ &lt;‾ ∣ &gt;‾ ∣ &gt;=‾ ∣ ==‾ ∣ !=‾relop →<strong>&lt;=</strong> ∣ <strong>&lt;</strong> ∣ <strong>&gt;</strong> ∣ <strong>&gt;=</strong> ∣ <strong>==</strong> ∣ <strong>!=</strong></li>
<li>additive-expression→additive-expression addop term ∣ termadditive-expression→additive-expression addop term ∣ term</li>
<li>addop→+‾ ∣ -‾addop→<strong>+</strong> ∣ <strong>-</strong></li>
<li>term→term mulop factor ∣ factorterm→term mulop factor ∣ factor</li>
<li>mulop→*‾ ∣ /‾mulop→***** ∣ <strong>/</strong></li>
<li>factor→(‾ expression )‾ ∣ var ∣ call ∣ integer ∣ floatfactor→<strong>(</strong> expression <strong>)</strong> ∣ var ∣ call ∣ integer ∣ float</li>
<li>integer→INTEGER‾integer→<strong>INTEGER</strong></li>
<li>float→FLOATPOINT‾float→<strong>FLOATPOINT</strong></li>
<li>call→ID‾ (‾ args)‾call→<strong>ID</strong> <strong>(</strong> args**)**</li>
<li>args→arg-list ∣ emptyargs→arg-list ∣ empty</li>
<li>arg-list→arg-list ,‾ expression ∣ expressionarg-list→arg-list <strong>,</strong> expression ∣ expression</li>
</ol>
<p>语法分析器可实现如下功能：</p>
<p>输入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出语法树：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&gt;--+ program
</span></span><span class="line"><span class="cl">|  &gt;--+ declaration-list
</span></span><span class="line"><span class="cl">|  |  &gt;--+ declaration
</span></span><span class="line"><span class="cl">|  |  |  &gt;--+ fun-declaration
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--+ type-specifier
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* int
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--* main
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--* (
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--+ params
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* void
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--* )
</span></span><span class="line"><span class="cl">|  |  |  |  &gt;--+ compound-stmt
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* {
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--+ local-declarations
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  &gt;--* epsilon
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--+ statement-list
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  &gt;--+ statement-list
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  &gt;--* epsilon
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  &gt;--+ statement
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  &gt;--+ return-stmt
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  &gt;--* return
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  &gt;--+ expression
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  &gt;--+ simple-expression
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  &gt;--+ additive-expression
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  &gt;--+ term
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  |  &gt;--+ factor
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  |  |  &gt;--+ integer
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  |  |  |  |  |  |  &gt;--* 0
</span></span><span class="line"><span class="cl">|  |  |  |  |  |  |  |  &gt;--* ;
</span></span><span class="line"><span class="cl">|  |  |  |  |  &gt;--* }
</span></span></code></pre></td></tr></table>
</div>
</div><p>具体代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">%</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;syntax_tree.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// external functions from lex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">int</span> <span class="nf">yylex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">yyparse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">yyrestart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">FILE</span> <span class="o">*</span> <span class="n">yyin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// external variables from lexical_analyzer module
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="n">pos_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="n">pos_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Global syntax tree
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree</span> <span class="o">*</span><span class="n">gt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Error reporting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">yyerror</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Helper functions written for you with love
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree_node</span> <span class="o">*</span><span class="nf">node</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">node_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">children_num</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* TODO: Complete this definition. */</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">struct</span> <span class="n">_syntax_tree_node</span> <span class="o">*</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	 <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* TODO: Your tokens here. */</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ERROR</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ADD</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">SUB</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">MUL</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">DIV</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LTE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">GT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">GTE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">EQ</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">NEQ</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ASSIN</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">SEMICOLON</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">COMMA</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LPARENTHESE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RPARENTHESE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LBRACKET</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RBRACKET</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">LBRACE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RBRACE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">ELSE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">IF</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">INT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">RETURN</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">VOID</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">WHILE</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">IDENTIFIER</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">INTEGER</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">FLOAT</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">FLOATPOINT</span>	<span class="c1">// 这个是 float 类型的 token
</span></span></span><span class="line"><span class="cl"><span class="c1">//%token &lt;node&gt; EOL
</span></span></span><span class="line"><span class="cl"><span class="c1">//%token &lt;node&gt; BLANK
</span></span></span><span class="line"><span class="cl"><span class="c1">//%token &lt;node&gt; COMMENT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">%</span><span class="n">type</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">program</span> <span class="n">declaration</span><span class="o">-</span><span class="n">list</span> <span class="n">declaration</span> <span class="n">var</span><span class="o">-</span><span class="n">declaration</span> <span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">fun</span><span class="o">-</span><span class="n">declaration</span> <span class="n">params</span> <span class="n">param</span><span class="o">-</span><span class="n">list</span> <span class="n">param</span> <span class="n">compound</span><span class="o">-</span><span class="n">stmt</span> <span class="n">local</span><span class="o">-</span><span class="n">declarations</span> <span class="n">statement</span><span class="o">-</span><span class="n">list</span> <span class="n">statement</span> <span class="n">expression</span><span class="o">-</span><span class="n">stmt</span> <span class="n">selection</span><span class="o">-</span><span class="n">stmt</span> <span class="n">iteration</span><span class="o">-</span><span class="n">stmt</span> <span class="k">return</span><span class="o">-</span><span class="n">stmt</span> <span class="n">expression</span> <span class="n">var</span> <span class="n">simple</span><span class="o">-</span><span class="n">expression</span> <span class="n">relop</span> <span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="n">addop</span> <span class="n">term</span> <span class="n">mulop</span> <span class="n">factor</span> <span class="n">integer</span> <span class="kt">float</span> <span class="n">call</span> <span class="n">args</span> <span class="n">arg</span><span class="o">-</span><span class="n">list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* compulsory starting symbol */</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">start</span> <span class="n">program</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* TODO: Your rules here. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">program</span> <span class="p">:</span> 	<span class="n">declaration</span><span class="o">-</span><span class="n">list</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;program&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="err">$$</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">declaration</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">declaration</span><span class="o">-</span><span class="n">list</span> <span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration-list&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="o">|</span>	<span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration-list&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">declaration</span> <span class="p">:</span> 	<span class="n">var</span><span class="o">-</span><span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">fun</span><span class="o">-</span><span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;declaration&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">var</span><span class="o">-</span><span class="nl">declaration</span> <span class="p">:</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var-declaration&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">                <span class="o">|</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">LBRACKET</span> <span class="n">INTEGER</span> <span class="n">RBRACKET</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var-declaration&#34;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">6</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">                <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span><span class="o">-</span><span class="nl">specifier</span> 	<span class="p">:</span> 	<span class="n">INT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;type-specifier&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">FLOAT</span> <span class="p">{</span> <span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;type-specifier&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">VOID</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;type-specifier&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fun</span><span class="o">-</span><span class="nl">declaration</span> <span class="p">:</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">LPARENTHESE</span> <span class="n">params</span> <span class="n">RPARENTHESE</span> <span class="n">compound</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;fun-declaration&#34;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">6</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">params</span> 	<span class="p">:</span> 	<span class="n">param</span><span class="o">-</span><span class="n">list</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;params&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">VOID</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;params&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">param</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">param</span><span class="o">-</span><span class="n">list</span> <span class="n">COMMA</span> <span class="n">param</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param-list&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">param</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param-list&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">param</span> 	<span class="p">:</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">type</span><span class="o">-</span><span class="n">specifier</span> <span class="n">IDENTIFIER</span> <span class="n">LBRACKET</span> <span class="n">RBRACKET</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;param&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">compound</span><span class="o">-</span><span class="nl">stmt</span> 	<span class="p">:</span> 	<span class="n">LBRACE</span> <span class="n">local</span><span class="o">-</span><span class="n">declarations</span> <span class="n">statement</span><span class="o">-</span><span class="n">list</span> <span class="n">RBRACE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;compound-stmt&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">local</span><span class="o">-</span><span class="nl">declarations</span> 	<span class="p">:</span> 	<span class="n">local</span><span class="o">-</span><span class="n">declarations</span> <span class="n">var</span><span class="o">-</span><span class="n">declaration</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;local-declarations&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> 	<span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;local-declarations&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">statement</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">statement</span><span class="o">-</span><span class="n">list</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement-list&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> 	<span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement-list&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">statement</span> 	<span class="p">:</span> 	<span class="n">expression</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> 	<span class="n">compound</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">selection</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">iteration</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="k">return</span><span class="o">-</span><span class="n">stmt</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;statement&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">expression</span><span class="o">-</span><span class="nl">stmt</span> <span class="p">:</span> 	<span class="n">expression</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression-stmt&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression-stmt&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">selection</span><span class="o">-</span><span class="nl">stmt</span> 	<span class="p">:</span> 	<span class="n">IF</span> <span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;selection-stmt&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="o">|</span> 	<span class="n">IF</span> <span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="n">statement</span> <span class="n">ELSE</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;selection-stmt&#34;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">6</span><span class="p">,</span> <span class="err">$</span><span class="mi">7</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">iteration</span><span class="o">-</span><span class="nl">stmt</span> 	<span class="p">:</span> 	<span class="n">WHILE</span> <span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="n">statement</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;iteration-stmt&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span><span class="o">-</span><span class="nl">stmt</span> <span class="p">:</span> 	<span class="n">RETURN</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;return-stmt&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">RETURN</span> <span class="n">expression</span> <span class="n">SEMICOLON</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;return-stmt&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">expression</span> 	<span class="p">:</span> 	<span class="n">var</span> <span class="n">ASSIN</span> <span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">simple</span><span class="o">-</span><span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;expression&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">var</span> <span class="p">:</span> 	<span class="n">IDENTIFIER</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> 	<span class="n">IDENTIFIER</span> <span class="n">LBRACKET</span> <span class="n">expression</span> <span class="n">RBRACKET</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;var&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">simple</span><span class="o">-</span><span class="nl">expression</span> 	<span class="p">:</span> 	<span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="n">relop</span> <span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;simple-expression&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="o">|</span> 	<span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;simple-expression&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">relop</span> 	<span class="p">:</span> 	<span class="n">LT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">LTE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">GT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">GTE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">EQ</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">NEQ</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;relop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">additive</span><span class="o">-</span><span class="nl">expression</span> <span class="p">:</span> 	<span class="n">additive</span><span class="o">-</span><span class="n">expression</span> <span class="n">addop</span> <span class="n">term</span>  <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;additive-expression&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="o">|</span> 	<span class="n">term</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;additive-expression&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">					<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">addop</span> 	<span class="p">:</span> 	<span class="n">ADD</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;addop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">SUB</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;addop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">term</span> 	<span class="p">:</span> 	<span class="n">term</span> <span class="n">mulop</span> <span class="n">factor</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;term&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span> 	<span class="n">factor</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;term&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">mulop</span> 	<span class="p">:</span> 	<span class="n">MUL</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;mulop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">DIV</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;mulop&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">factor</span> 	<span class="p">:</span> 	<span class="n">LPARENTHESE</span> <span class="n">expression</span> <span class="n">RPARENTHESE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">var</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">call</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="n">integer</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="o">|</span>	<span class="kt">float</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;factor&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">integer</span> 	<span class="p">:</span> 	<span class="n">INTEGER</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;integer&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">float</span> 	<span class="o">:</span> 	<span class="n">FLOATPOINT</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;float&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">call</span> 	<span class="p">:</span> 	<span class="n">IDENTIFIER</span> <span class="n">LPARENTHESE</span> <span class="n">args</span> <span class="n">RPARENTHESE</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;call&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">args</span> 	<span class="p">:</span> 	<span class="n">arg</span><span class="o">-</span><span class="n">list</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;args&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> 	<span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;args&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">arg</span><span class="o">-</span><span class="nl">list</span> 	<span class="p">:</span> 	<span class="n">arg</span><span class="o">-</span><span class="n">list</span> <span class="n">COMMA</span> <span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;arg-list&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="o">|</span> 	<span class="n">expression</span> <span class="p">{</span><span class="err">$$</span> <span class="o">=</span> <span class="nf">node</span><span class="p">(</span> <span class="s">&#34;arg-list&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">1</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%%</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// The error reporting function.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">yyerror</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TO STUDENTS: This is just an example.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// You can customize it as you like.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;error at line %d column %d: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">pos_start</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// Parse input from file `input_path`, and prints the parsing results
</span></span></span><span class="line"><span class="cl"><span class="c1">/// to stdout.  If input_path is NULL, read from stdin.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This function initializes essential states before running yyparse().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree</span> <span class="o">*</span><span class="nf">parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">input_path</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">yyin</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;[ERR] Open input file %s failed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">input_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">yyin</span> <span class="o">=</span> <span class="n">stdin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="n">pos_start</span> <span class="o">=</span> <span class="n">pos_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gt</span> <span class="o">=</span> <span class="nf">new_syntax_tree</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">yyrestart</span><span class="p">(</span><span class="n">yyin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">yyparse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">gt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// A helper function to quickly construct a tree node.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// e.g. $$ = node(&#34;program&#34;, 1, $1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">syntax_tree_node</span> <span class="o">*</span><span class="nf">node</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">children_num</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">syntax_tree_node</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nf">new_syntax_tree_node</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">syntax_tree_node</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 这里表示 epsilon结点是通过 children_num == 0 来判断的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">children_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">child</span> <span class="o">=</span> <span class="nf">new_syntax_tree_node</span><span class="p">(</span><span class="s">&#34;epsilon&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">syntax_tree_add_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">va_list</span> <span class="n">ap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">children_num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">children_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="nf">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">syntax_tree_node</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">syntax_tree_add_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="语法树-中间代码">语法树-&gt;中间代码
</h1><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;cminusf_builder.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;BasicBlock.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Constant.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;GlobalVariable.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Type.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Value.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ast.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;logging.hpp&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CONST_FP(num) ConstantFP::get((float)num, module.get())
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CONST_INT(num) ConstantInt::get(num, module.get())
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// types
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Type</span> <span class="o">*</span><span class="n">VOID_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">INT1_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">INT32_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">INT32PTR_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">FLOAT_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="o">*</span><span class="n">FLOATPTR_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * use CMinusfBuilder::Scope to construct scopes
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.enter: enter a new scope
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.exit: exit current scope
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.push: add a new binding to current scope
</span></span></span><span class="line"><span class="cl"><span class="cm"> * scope.find: find and return the value bound to the name123456
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTProgram</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">VOID_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_void_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">INT1_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_int1_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">INT32_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_int32_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">INT32PTR_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_int32_ptr_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLOAT_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_float_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLOATPTR_T</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">get_float_ptr_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Value</span> <span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">decl</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">declarations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_val</span> <span class="o">=</span> <span class="n">decl</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//调用对应的visit函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTNum</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果是num，直接将值存入context.var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span>  <span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">i_val</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span>  <span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">f_val</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTVarDeclaration</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//vardeclaration-&gt;type_specifier var;|vardeclaration-&gt;type_specifier var[num];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//先处理type_specifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//这个node包括Id,num和type，id是变量名，num是数组大小，type是变量类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Type</span> <span class="o">*</span><span class="n">var_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_type</span> <span class="o">=</span> <span class="n">INT32_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_type</span> <span class="o">=</span> <span class="n">FLOAT_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_type</span> <span class="o">=</span> <span class="n">VOID_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里获取node.type得到类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">scope</span><span class="p">.</span><span class="n">in_global</span><span class="p">())</span><span class="c1">//全局变量,用GlobalVariable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span><span class="c1">//不是数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">global_var</span> <span class="o">=</span> <span class="n">GlobalVariable</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="n">var_type</span><span class="p">,</span><span class="nb">false</span><span class="p">,</span><span class="n">ConstantZero</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">global_var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="o">*</span><span class="n">arrayType</span> <span class="o">=</span> <span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">i_val</span><span class="p">);</span><span class="c1">//node.num-&gt;i_val是数组大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">global_var_array</span> <span class="o">=</span> <span class="n">GlobalVariable</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="n">arrayType</span><span class="p">,</span><span class="nb">false</span><span class="p">,</span><span class="n">ConstantZero</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">global_var_array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="c1">//不是全局变量就用builder分配内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">alloca</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_alloca</span><span class="p">(</span><span class="n">var_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">alloca</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="o">*</span><span class="n">arrayType</span> <span class="o">=</span> <span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">i_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">alloca_array</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_alloca</span><span class="p">(</span><span class="n">arrayType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">alloca_array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTFunDeclaration</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//FunDeclaration-&gt;type_specifier id(Params) CompoundStmt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//node包括type,id,params,compound_stmt,分别是返回值类型，函数名，参数，函数体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FunctionType</span> <span class="o">*</span><span class="n">fun_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Type</span> <span class="o">*</span><span class="n">ret_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Type</span> <span class="o">*&gt;</span> <span class="n">param_types</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_type</span> <span class="o">=</span> <span class="n">INT32_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_type</span> <span class="o">=</span> <span class="n">FLOAT_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret_type</span> <span class="o">=</span> <span class="n">VOID_T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//上面处理返回值类型，下面处理参数类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">param</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//这里获得每个参数，进行处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//param-&gt;type,param-&gt;id，类型和名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: Please accomplish param_types.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">isarray</span><span class="p">)</span><span class="c1">//数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">INT32PTR_T</span><span class="p">);</span><span class="c1">//这里用ptr的类型存入向量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FLOATPTR_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_INT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_FLOAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">param_types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//上面已经把参数类型存入了param_types中，下面创建函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fun_type</span> <span class="o">=</span> <span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">ret_type</span><span class="p">,</span> <span class="n">param_types</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="n">Function</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">fun_type</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span><span class="c1">//将函数名和函数绑定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span><span class="c1">//存入context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">funBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;entry&#34;</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">funBB</span><span class="p">);</span><span class="c1">//设置插入点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">scope</span><span class="p">.</span><span class="n">enter</span><span class="p">();</span><span class="c1">//进入函数作用域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">get_args</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span><span class="c1">//将参数存入args
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span><span class="c1">//处理参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: You need to deal with params and store them in the scope.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//由于param_types中存入了参数类型，所以这里只需要用对应参数名即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//这里处理参数，将参数存入alloca中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">alloca</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_alloca</span><span class="p">(</span><span class="n">param_types</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_store</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alloca</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">scope</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">alloca</span><span class="p">);</span><span class="c1">//将变量存入作用域，确保在函数内部可以访问，同时在函数外部不可访问，及时清理避免变量冲突和内存泄漏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">compound_stmt</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//访问者模式，处理函数体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">()))</span> <span class="c1">//如果没有返回值,则返回0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_void_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_void_ret</span><span class="p">();</span><span class="c1">//void类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">CONST_FP</span><span class="p">(</span><span class="mf">0.</span><span class="p">));</span><span class="c1">//float类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="c1">//int类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span><span class="p">.</span><span class="n">exit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTParam</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//上面已经处理了参数    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTCompoundStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is not complete.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// You may need to add some code here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to deal with complex statements. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//compoundstmt-&gt;{local_declarations statement_list}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">scope</span><span class="p">.</span><span class="n">enter</span><span class="p">();</span>  <span class="c1">//进入作用域，确保局部变量不会和全局变量冲突
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">decl</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">local_declarations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">decl</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//处理局部变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">stmt</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">statement_list</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stmt</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//处理语句
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span><span class="c1">//如果没有返回值，直接退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span><span class="p">.</span><span class="n">exit</span><span class="p">();</span><span class="c1">//处理完函数体，退出作用域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTExpressionStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//expressionstmt-&gt;expressionstmt;|;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">expression</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTSelectionStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">trueBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">falseBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">contBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Value</span> <span class="o">*</span> <span class="n">cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_FP</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//上面创建了和0比较的指令，下面创建条件跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">else_statement</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">trueBB</span><span class="p">,</span> <span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">trueBB</span><span class="p">,</span> <span class="n">falseBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果有else语句，创建条件跳转，没有就跳转接下来的语句（contBB）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">trueBB</span><span class="p">);</span><span class="c1">//设置插入点，指定下面的语句在trueBB中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">if_statement</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span><span class="c1">//如果没有返回值，创建一个跳转，避免出现多个返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">else_statement</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">falseBB</span><span class="o">-&gt;</span><span class="n">erase_from_parent</span><span class="p">();</span><span class="c1">//不存在else删除falseBB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">falseBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">else_statement</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">contBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTIterationStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//iterationstmt-&gt;while(expression)statement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">condBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">bodyBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">afterBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//上面三个基本块，分别是条件判断，循环体，循环结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Value</span> <span class="o">*</span> <span class="n">cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span><span class="c1">//如果没终结，创建一个跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">condBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">condBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//这里处理条件，context.var存储了表达式的值，下面和0比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_gt</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">CONST_FP</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">bodyBB</span><span class="p">,</span> <span class="n">afterBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">bodyBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">statement</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//处理循环体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">get_insert_block</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">condBB</span><span class="p">);</span><span class="c1">//如果没有返回值，创建一个跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">afterBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTReturnStmt</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//returnstmt-&gt;return;|return expression;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">expression</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span><span class="c1">//没有返回值，置为void
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_void_ret</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: The given code is incomplete.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// You need to solve other return cases (e.g. return an integer).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//这句处理完，context.var存储了返回值，context.func存储了之前函数的信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// auto fun = builder-&gt;get_insert_block()-&gt;get_parent();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">ret_type</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//下面处理不一致的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">ret_type</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">ret_type</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_ret</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">ret_type</span><span class="o">-&gt;</span><span class="n">is_void_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_void_ret</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTVar</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">expression</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span><span class="c1">//不是数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">var</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">);</span><span class="c1">//在当前作用域中查找变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">var</span><span class="o">!=</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_array_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(DEBUG)&lt;&lt;&#34;var type is&#34;&lt;&lt;var-&gt;get_type()-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// var = builder-&gt;create_load(var);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//如果是指针，则返回第一个元素地址，数组就是[0][0],普通变量就是[0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var_location</span> <span class="o">=</span> <span class="n">var</span><span class="p">;</span><span class="c1">//把地址存入context.var_location
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var_location</span><span class="p">);</span><span class="c1">//加载变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="c1">//处理数组索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// auto fun = builder-&gt;get_insert_block()-&gt;get_parent();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Value</span><span class="o">*</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span><span class="c1">//如果是浮点数，转换为整数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//下面处理负数索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">index_check</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_lt</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//index_check是一个比较指令，判断index是否小于0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">excpetBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建异常基本块，调用neg_idx_except
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">normalBB</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">index_check</span><span class="p">,</span> <span class="n">excpetBB</span><span class="p">,</span> <span class="n">normalBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">excpetBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">except</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;neg_idx_except&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_call</span><span class="p">(</span><span class="n">except</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_br</span><span class="p">(</span><span class="n">normalBB</span><span class="p">);</span><span class="c1">//异常处理完，跳转到normalBB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="o">-&gt;</span><span class="n">set_insert_point</span><span class="p">(</span><span class="n">normalBB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">var_array</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">var_array_gep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">var_array</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_array_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">var_array_gep</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var_array</span><span class="p">,</span> <span class="p">{</span><span class="n">CONST_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(DEBUG)&lt;&lt;&#34;var_array type is&#34;&lt;&lt;var_array-&gt;get_type()-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">var_load</span><span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var_array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">var_array_gep</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_gep</span><span class="p">(</span><span class="n">var_load</span><span class="p">,</span> <span class="p">{</span><span class="n">index</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var_location</span> <span class="o">=</span> <span class="n">var_array_gep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_load</span><span class="p">(</span><span class="n">var_array_gep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTAssignExpression</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//assignexpression-&gt;var=expression
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Value</span><span class="o">*</span> <span class="n">var</span><span class="p">;</span><span class="c1">//存储变量地址，用于加载出context.var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Value</span><span class="o">*</span> <span class="n">num</span><span class="p">;</span><span class="c1">//存储var的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">var</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var_location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">num</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这步处理完后context.var存储了表达式的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">num</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//强制类型转换，转换为var的类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_store</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTSimpleExpression</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//simpleexpression-&gt;additive_expression relop additive_expression
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">additive_expression_l</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">additive_expression_r</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="c1">//前面处理过左边的表达式，context.var存储了左边的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">node</span><span class="p">.</span><span class="n">additive_expression_r</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">((</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果都是整型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_EQ</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_eq</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_ge</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_gt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_le</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_lt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_NEQ</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_icmp_ne</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span><span class="c1">//如果有一个是整型，转换为浮点型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_EQ</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_eq</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_ge</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_GT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_gt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LE</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_le</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_LT</span>  <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_lt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_NEQ</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fcmp_ne</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>          
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_zext</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span><span class="c1">//转换为整型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTAdditiveExpression</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//additiveexpression-&gt;additive_expression addop term|term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">additive_expression</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">additive_expression</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="c1">//lhs存储左边additive_expression的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">node</span><span class="p">.</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="c1">//rhs存储term的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">((</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_PLUS</span> <span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_iadd</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MINUS</span><span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_isub</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_PLUS</span> <span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fadd</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MINUS</span><span class="p">:</span>  <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fsub</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTTerm</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//term-&gt;term mulop factor|factor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">term</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">factor</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="c1">//和前面类似
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">factor</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span><span class="o">*</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">((</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MUL</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_imul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_DIV</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_isdiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rhs</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_MUL</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fmul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nl">OP_DIV</span> <span class="p">:</span>   <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fdiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Value</span><span class="o">*</span> <span class="n">CminusfBuilder</span><span class="o">::</span><span class="n">visit</span><span class="p">(</span><span class="n">ASTCall</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: This function is empty now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Add some code here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//call-&gt;id(args)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">scope</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">*&gt;</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">param_type</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">get_function_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">param_begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">param_type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">param_type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_fptosi</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">INT32_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">((</span><span class="o">*</span><span class="n">param_type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_sitofp</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">FLOAT_T</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">param_type</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_function_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_num_of_args</span><span class="p">()</span> <span class="o">!=</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error: Wrong number of arguments for function &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">create_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="中间代码-龙芯汇编">中间代码-&gt;龙芯汇编
</h1><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CodeGen.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ASMInstruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CodeGenUtil.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Instruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Register.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;logging.hpp&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">allocate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 备份 $ra $fp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">PROLOGUE_OFFSET_BASE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 为每个参数分配栈空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_args</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">[</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 为指令结果分配栈空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">instr</span> <span class="p">:</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 每个非 void 的定值都分配栈空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">instr</span><span class="p">.</span><span class="n">is_void</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">instr</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">[</span><span class="o">&amp;</span><span class="n">instr</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// alloca 的副作用：分配额外空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">is_alloca</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="o">*</span><span class="n">alloca_inst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">AllocaInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">alloc_size</span> <span class="o">=</span> <span class="n">alloca_inst</span><span class="o">-&gt;</span><span class="n">get_alloca_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">offset</span> <span class="o">+=</span> <span class="n">alloc_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分配栈空间，需要是 16 的整数倍
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="p">.</span><span class="n">frame_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">PROLOGUE_ALIGN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">copy_stmt</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">succ</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_succ_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">succ</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">is_phi</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 遍历后继块中 phi 的定值 bb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inst</span><span class="p">.</span><span class="n">get_operands</span><span class="p">().</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// phi 的定值 bb 是当前翻译块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="o">*</span><span class="n">lvalue</span> <span class="o">=</span> <span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">lvalue</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">lvalue</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                            <span class="n">store_from_freg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">lvalue</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                            <span class="n">store_from_greg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 如果没有找到当前翻译块，说明是 undef，无事可做
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_to_greg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="o">*</span><span class="n">constant</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int32_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">constant</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">ADDI</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">val</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_large_int32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="k">auto</span> <span class="o">*</span><span class="n">global</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD_ADDR</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">global</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_from_stack_to_greg</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_large_int32</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">high_20</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// si20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">low_12</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">LOW_12_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">LU12I_W</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">high_20</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">ORI</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">low_12</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_large_int64</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">low_32</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">LOW_32_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_large_int32</span><span class="p">(</span><span class="n">low_32</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">high_32</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">high_32_low_20</span> <span class="o">=</span> <span class="p">(</span><span class="n">high_32</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// si20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int32_t</span> <span class="n">high_32_high_12</span> <span class="o">=</span> <span class="n">high_32</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>        <span class="c1">// si12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">append_inst</span><span class="p">(</span><span class="n">LU32I_D</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">high_32_low_20</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">LU52I_D</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">high_32_high_12</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_from_stack_to_greg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">LOAD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">store_from_greg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reg</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">BYTE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="n">STORE</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">reg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_to_freg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">FReg</span> <span class="o">&amp;</span><span class="n">freg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="o">*</span><span class="n">constant</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ConstantFP</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">val</span> <span class="o">=</span> <span class="n">constant</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_float_imm</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">freg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">FLOAD</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">freg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">FLOAD</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">freg</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">load_float_imm</span><span class="p">(</span><span class="kt">float</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">FReg</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_large_int32</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">GR2FR</span> <span class="n">WORD</span><span class="p">,</span> <span class="p">{</span><span class="n">r</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">store_from_freg</span><span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">FReg</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">offset_str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">FSTORE</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">r</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">offset_str</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">ADD</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="p">{</span><span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="n">FSTORE</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="p">{</span><span class="n">r</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">addr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_prologue</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//该函数用来插入函数的序言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//上面这个用来判断当前栈帧大小是否在12位立即数范围内
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $fp, $sp, 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $sp, $sp, &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="o">-</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;sub.d $sp, $sp, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;add.d $fp, $sp, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">garg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">farg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//初始化两个计数器，分别用于整数/指针类型参数和浮点类型参数的寄存器索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_args</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历当前函数所有参数，如果是main传的为void就没有参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">store_from_freg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="n">farg_cnt</span><span class="o">++</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// int or pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">store_from_greg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="n">garg_cnt</span><span class="o">++</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//先将参数传入栈帧中，以便在函数体内部可以正确访问这些参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_epilogue</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 根据你的理解设定函数的 epilogue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">append_inst</span><span class="p">(</span><span class="n">func_exit_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">),</span><span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $sp, $sp, &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;jr $ra&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">frame_size</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d $sp, $sp, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $ra, $sp, -8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d $fp, $sp, -16&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;jr $ra&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_ret</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 函数返回，思考如何处理返回值、寄存器备份，如何返回调用者地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ReturnInst(Value *val, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">retInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ReturnInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">retInst</span><span class="o">-&gt;</span><span class="n">is_void_ret</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// gen_epilogue();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.w&#34;</span><span class="p">,{</span><span class="s">&#34;$a0&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">func_exit_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">retValue</span> <span class="o">=</span> <span class="n">retInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">retValue</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">retValue</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">retValue</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">retValue</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">func_exit_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// gen_epilogue();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_br</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//BranchInst(Value *cond, BasicBlock *if_true, BasicBlock *if_false,BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">branchInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">is_cond_br</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO 补全条件跳转的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="o">*</span><span class="n">truebb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">falsebb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">cond</span> <span class="o">=</span> <span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_condition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_float_imm</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;fcmp.seq.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//这句比较如果cond == 0,则fcc0 = 1,cond == 1,则fcc0 = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;bceqz $fcc0, &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">truebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断fcc0是否为0，为0则跳转到truebb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">falsebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;beq $t1, $zero, &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">falsebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">truebb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="o">*</span><span class="n">branchbb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">branchInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b &#34;</span> <span class="o">+</span> <span class="n">label_name</span><span class="p">(</span><span class="n">branchbb</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_binary</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Instruction(Type *ty, OpID id, BasicBlock *parent = nullptr);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//IBinaryInst(OpID id, Value *v1, Value *v2, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">add</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;add.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;sub.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">mul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;mul.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sdiv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;div.w $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_float_binary</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 浮点类型的二元指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fadd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fadd.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fsub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fsub.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fmul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fmul.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fdiv</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fdiv.s $ft2, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_alloca</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 我们已经为 alloca 的内容分配空间，在此我们还需保存 alloca
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 指令自身产生的定值，即指向 alloca 空间起始地址的指针
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 将 alloca 出空间的起始地址保存在栈帧上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//AllocaInst(Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">allocaInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">AllocaInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">allocaType</span> <span class="o">=</span> <span class="n">allocaInst</span><span class="o">-&gt;</span><span class="n">get_alloca_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">offset_map</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">allocaInst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;alloca offset: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">allocaType</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">new_offset_sub</span> <span class="o">=</span>  <span class="kt">int</span><span class="p">(</span><span class="n">allocaType</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">new_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">new_offset_sub</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IS_IMM_12</span><span class="p">(</span><span class="n">new_offset</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">new_offset</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//用t0存储alloca后的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_large_int64</span><span class="p">(</span><span class="n">new_offset</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;add.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;$fp&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">offset</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//将alloca后的地址存储到栈帧上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_load</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* %op2 = load i32, i32* %op1 */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//get_operand函数只有0，返回value类型的*%op1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *ptr = context.inst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ptr是要加载的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//上面的例子中是i32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//将ptr的值加载到t0中，也就是t0存储了要加载的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;fld.s $ft0, $t0, 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//从t0指向的地址中取值加载到ft0中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将ft0的值存储到context.inst中，其实也就是赋给了左值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO load 整数类型的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.b&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.w&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ld.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_store</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 翻译 store 指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* store float 0x40091eb860000000, float* %op0 */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *ptr = context.inst-&gt;get_operand(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//StoreInst(Value *val, Value *ptr, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//和load是反的，0是要存储的值，1是地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_to_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//把要存储的值加载到ft0中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;fst.s $ft0, $t0, 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将ft0中的值写入内存t0指向的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_to_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.b&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.w&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;st.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="s">&#34;0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_icmp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 处理各种整数比较的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op0 = icmp sgt i32 5, 1 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">icmpInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ICmpInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ICmpInst(OpID id, Value *lhs, Value *rhs, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *op1 = icmpInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//获得第一个value类型的lhs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *op2 = icmpInst-&gt;get_operand(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//获得第二个value类型的rhs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">icmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">icmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">icmpInst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">lt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断t0是否小于t1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;slt $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">eq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断t0和t1是否相等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xor&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t0&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;sltu&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xori&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 先异或，如果 t0 和 t1 相等，结果为 0，否则为非零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 然后使用 sltu 判断结果是否为零，最后取反
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">ne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xor&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t0&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;sltu&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断t0和t1是否不相等，先异或，再判断是否大于0，用无符号数比较，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//如果t0和t1不相等，那么t2会是一个正数，此时一定比0大，所以slt后为1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">le</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;slt&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">,</span> <span class="s">&#34;$t0&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;xori&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断t0是否小于等于t1，先判断t1是否小于t0，如果是，那么t2为1，否则为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//然后将t2取反，如果t0小于等于t1，那么t2为1，否则为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">gt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;slt $t2, $t1, $t0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="nl">ge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;slt $t2, $t0, $t1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;xori $t2, $t2, 1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//将比较的结果存储到context.inst中，即赋给左值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_fcmp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 处理各种浮点数比较的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//FCmpInst(OpID id, Value *lhs, Value *rhs, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">fcmpInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">FCmpInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *op1 = fcmpInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auto *op2 = fcmpInst-&gt;get_operand(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">fcmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">fcmpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">fcmpInst</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">feq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.seq.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sne.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">flt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.slt.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sle.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fgt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sgt.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="nl">fge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;fcmp.sge.s $fcc0, $ft0, $ft1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>           
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;bcnez&#34;</span><span class="p">,{</span><span class="s">&#34;$fcc0&#34;</span><span class="p">,</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果fcc0为0，跳转存0,否则不跳转存1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_float_imm</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span><span class="p">),</span><span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_float_imm</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="n">fcmp_label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="p">.</span><span class="n">fcmp_cnt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_zext</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 将窄位宽的整数数据进行零扩展
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ZextInst(Value *val, Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op1 = zext i1 %op0 to i32 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">zextInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ZextInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">zextInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//将val的值加载到t0中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_call</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 函数调用，注意我们只需要通过寄存器传递参数，即不需考虑栈上传参的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//CallInst(Function *func, std::vector&lt;Value *&gt; args, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op0 = call i32 @callee(i32 110) */</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">callInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">CallInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">garg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">farg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">callInst</span><span class="o">-&gt;</span><span class="n">get_operands</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="s">&#34;arg type is &#34;</span><span class="o">&lt;&lt;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_freg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="n">farg_cnt</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">farg_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_integer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="s">&#34;here is integer type&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="n">garg_cnt</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">garg_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_pointer_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_to_greg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="n">garg_cnt</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">garg_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_void_type</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// else {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     assert(false);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//将参数传入寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">func</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;context.func is null&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">current_func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">callInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// context.func = current_func;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;bl&#34;</span><span class="p">,{</span><span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// std::cout&lt;&lt;&#34;call function_type &#34;&lt;&lt;callInst-&gt;get_function_type()&lt;&lt;std::endl;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_float_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">fa</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_int32_type</span><span class="p">()</span> <span class="o">||</span> <span class="n">current_func</span><span class="o">-&gt;</span><span class="n">get_return_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_int1_type</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if(!current_func-&gt;get_return_type()-&gt;is_void_type())
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// gen_epilogue();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">//将函数返回值存储到context.inst中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// append_inst(&#34;b &#34; + func_exit_label_name(context.func));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//跳转到函数退出的地方
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * %op = getelementptr [10 x i32], [10 x i32]* %op, i32 0, i32 %op
</span></span></span><span class="line"><span class="cl"><span class="cm"> * %op = getelementptr        i32,        i32* %op, i32 %op
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Memory layout
</span></span></span><span class="line"><span class="cl"><span class="cm"> *       -            ^
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      | Smaller address
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |  arg ptr  |---+  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+   /  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |&lt;--   |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   \  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |   Array   |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+   |  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |  Pointer  |---+  |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * |           |      |
</span></span></span><span class="line"><span class="cl"><span class="cm"> * +-----------+      | Larger address
</span></span></span><span class="line"><span class="cl"><span class="cm"> *       +
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_gep</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 计算内存地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//GetElementPtrInst(Value *ptr, std::vector&lt;Value *&gt; idxs, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* %op1 = getelementptr [10 x i32], [10 x i32]* %op0, i32 0, i32 0 */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//* %op = getelementptr        i32,        i32* %op, i32 %op
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">gepInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">gepInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">idx</span> <span class="p">:</span> <span class="n">gepInst</span><span class="o">-&gt;</span><span class="n">get_operands</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="o">||</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_to_greg</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;addi.w&#34;</span><span class="p">,{</span><span class="s">&#34;$t4&#34;</span><span class="p">,</span> <span class="s">&#34;$zero&#34;</span><span class="p">,</span> <span class="s">&#34;4&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;mul.w&#34;</span><span class="p">,{</span><span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t1&#34;</span><span class="p">,</span> <span class="s">&#34;$t4&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将idx的值乘以4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;add.d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;$t3&#34;</span><span class="p">,</span> <span class="s">&#34;$t2&#34;</span><span class="p">,</span> <span class="s">&#34;$t3&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将ptr的值加上idx的值，此时t3中存储的是ptr+idx的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_sitofp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 整数转向浮点数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//SiToFpInst(Value *val, Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">sitofpInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">SiToFpInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *val = sitofpInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_greg</span><span class="p">(</span><span class="n">sitofpInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;movgr2fr.w&#34;</span><span class="p">,{</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ffint.s.w&#34;</span><span class="p">,{</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_freg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">gen_fptosi</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO 浮点数转向整数，注意向下取整(round to zero)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw not_implemented_error{__FUNCTION__};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//%op2 = fptosi float %op1 to i32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//FpToSiInst(Value *val, Type *ty, BasicBlock *bb);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">fptosiInst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">FpToSiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// auto *val = fptosiInst-&gt;get_operand(0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_to_freg</span><span class="p">(</span><span class="n">fptosiInst</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;ftintrz.w.s&#34;</span><span class="p">,{</span><span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;movfr2gr.s&#34;</span><span class="p">,{</span><span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">print</span><span class="p">(),</span> <span class="n">FReg</span><span class="o">::</span><span class="n">ft</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">print</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl">    <span class="n">store_from_greg</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">Reg</span><span class="o">::</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 确保每个函数中基本块的名字都被设置好
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 使用 GNU 伪指令为全局变量分配空间
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 你可以使用 `la.local` 指令将标签 (全局变量) 的地址载入寄存器中, 比如
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 要将 `a` 的地址载入 $t0, 只需要 `la.local $t0, a`
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">get_global_variable</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;Global variables&#34;</span><span class="p">,</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Comment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 虽然下面两条伪指令可以简化为一条 `.bss` 伪指令, 但是我们还是选择使用
</span></span></span><span class="line"><span class="cl"><span class="cm">         * `.section` 将全局变量放到可执行文件的 BSS 段, 原因如下:
</span></span></span><span class="line"><span class="cl"><span class="cm">         * - 尽可能对齐交叉编译器 loongarch64-unknown-linux-gnu-gcc 的行为
</span></span></span><span class="line"><span class="cl"><span class="cm">         * - 支持更旧版本的 GNU 汇编器, 因为 `.bss` 伪指令是应该相对较新的指令,
</span></span></span><span class="line"><span class="cl"><span class="cm">         *   GNU 汇编器在 2023 年 2 月的 2.37 版本才将其引入
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.text&#34;</span><span class="p">,</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.section&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;.bss&#34;</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">aw</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;@nobits&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">global</span> <span class="p">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_global_variable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">global</span><span class="p">.</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.globl&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">()},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.type&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s">&#34;@object&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.size&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">size</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">global</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.space&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">size</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 函数代码段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">output</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;.text&#34;</span><span class="p">,</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">func</span> <span class="p">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">func</span><span class="p">.</span><span class="n">is_declaration</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 更新 context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">context</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 函数信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.globl&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">func</span><span class="p">.</span><span class="n">get_name</span><span class="p">()},</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="s">&#34;.type&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">func</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s">&#34;@function&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Atrribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">append_inst</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 分配函数栈帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">allocate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 生成 prologue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">gen_prologue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">func</span><span class="p">.</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="p">.</span><span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">append_inst</span><span class="p">(</span><span class="n">label_name</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">bb</span><span class="p">),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Label</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">instr</span> <span class="p">:</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// For debug
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">append_inst</span><span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">print</span><span class="p">(),</span> <span class="n">ASMInstruction</span><span class="o">::</span><span class="n">Comment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">context</span><span class="p">.</span><span class="n">inst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">;</span> <span class="c1">// 更新 context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">switch</span> <span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">ret</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_ret</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">br</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">copy_stmt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_br</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">add</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">mul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sdiv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_binary</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fadd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fsub</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fmul</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fdiv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_float_binary</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">alloca</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* 对于 alloca 指令，我们已经为 alloca
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * 的内容分配空间，在此我们还需保存 alloca
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * 指令自身产生的定值，即指向 alloca 空间起始地址的指针
</span></span></span><span class="line"><span class="cl"><span class="cm">                         */</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_alloca</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">load</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_load</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">store</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_store</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">ge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">gt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">le</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">lt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">eq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">ne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_icmp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fgt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">flt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">feq</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fne</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_fcmp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">phi</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* for phi, just convert to a series of
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * copy-stmts */</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* we can collect all phi and deal them at
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * the end */</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">call</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_call</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">getelementptr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_gep</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">zext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_zext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">fptosi</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_fptosi</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="n">Instruction</span><span class="o">::</span><span class="nl">sitofp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gen_sitofp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 生成 epilogue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">gen_epilogue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CodeGen</span><span class="o">::</span><span class="n">print</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">output</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">+=</span> <span class="n">inst</span><span class="p">.</span><span class="n">format</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="优化处理">优化处理
</h1><h2 id="mem2reg">MEM2REG
</h2><p>创建支配树：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Dominators.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Function.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;BasicBlock.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;logging.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 支配器分析的入口函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 遍历模块中的所有函数，对每个非声明的函数执行支配关系分析。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">f1</span> <span class="p">:</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_on_func</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 对单个函数执行支配关系分析
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要分析的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数执行完整的支配关系分析流程：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 初始化数据结构
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 创建反向后序遍历序列
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. 计算直接支配者(idom)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 4. 计算支配边界
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 5. 构建支配树的后继关系
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 6. 创建支配树的DFS序
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">run_on_func</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dom_post_order_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">idom_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_frontier_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="p">{}});</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_tree_succ_blocks_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="p">{}});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_reverse_post_order</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_idom</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_dominance_frontier</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_dom_tree_succ</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_dom_dfs_order</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LOG(INFO)&lt;&lt;m_-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dump_dominator_tree(f);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dump_cfg(f);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 计算两个基本块的支配关系交集
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param b1 第一个基本块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param b2 第二个基本块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return 返回在支配树上最深的同时支配b1和b2的节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数使用后序号来查找两个节点的最近公共支配者。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 通过在支配树上向上遍历直到找到交点。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">Dominators</span><span class="o">::</span><span class="n">intersect</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">b1</span><span class="p">,</span> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">b1</span> <span class="o">!=</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">get_post_order</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">get_post_order</span><span class="p">(</span><span class="n">b2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">b1</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="n">b1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">get_post_order</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">get_post_order</span><span class="p">(</span><span class="n">b1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">b2</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="n">b2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">b1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 创建函数的反向后序遍历序列
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要处理的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 通过DFS遍历CFG来构建基本块的后序遍历序列。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 这个序列用于后续的支配关系分析。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_reverse_post_order</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BBSet</span> <span class="n">visited</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dfs</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">(),</span> <span class="n">visited</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 深度优先搜索辅助函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param bb 当前遍历的基本块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param visited 已访问的基本块集合
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 执行DFS遍历，维护后序遍历序列和每个基本块的后序号。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">dfs</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">visited</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">visited</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">succ</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_succ_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">visited</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">succ</span><span class="p">)</span> <span class="o">==</span> <span class="n">visited</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dfs</span><span class="p">(</span><span class="n">succ</span><span class="p">,</span> <span class="n">visited</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_order_vec_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_order_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">bb</span><span class="p">,</span> <span class="n">post_order_</span><span class="p">.</span><span class="n">size</span><span class="p">()});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 计算所有基本块的直接支配者(immediate dominator)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要分析的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 使用迭代算法计算每个基本块的直接支配者：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 将入口块的直接支配者设置为自身
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 重复遍历所有基本块，更新它们的直接支配者
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. 当没有变化时算法终止
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_idom</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">idom_</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LOG(INFO)&lt;&lt;&#34;idom_[entry]:&#34;&lt;&lt;idom_[entry]-&gt;get_name();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">rev_it</span> <span class="o">=</span> <span class="n">post_order_vec_</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span> <span class="n">rev_it</span> <span class="o">!=</span> <span class="n">post_order_vec_</span><span class="p">.</span><span class="n">rend</span><span class="p">();</span> <span class="o">++</span><span class="n">rev_it</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">*</span><span class="n">rev_it</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">bb</span> <span class="o">==</span> <span class="n">entry</span> <span class="o">||</span> <span class="n">bb</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">pre_blocks</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">pre_blocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">new_idom</span> <span class="o">=</span> <span class="o">*</span><span class="n">pre_blocks</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">idom_</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">idom_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_idom</span> <span class="o">=</span> <span class="n">intersect</span><span class="p">(</span><span class="n">new_idom</span><span class="p">,</span> <span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">idom_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_idom</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">idom_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_idom</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 计算所有基本块的支配边界(dominance frontier)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要分析的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 对于每个有多个前驱的基本块B：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 从每个前驱P开始，沿着支配树向上遍历直到遇到B的直接支配者，
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 将B加入路径上所有节点的支配边界中。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_dominance_frontier</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">block</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">get_pre_basic_blocks</span><span class="p">().</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">block</span><span class="p">.</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">runner</span> <span class="o">=</span> <span class="n">pred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span><span class="p">(</span><span class="n">runner</span> <span class="o">!=</span> <span class="n">get_idom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">runner</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dom_frontier_</span><span class="p">[</span><span class="n">runner</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">runner</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="n">runner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 构建支配树的后继关系
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要处理的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 基于已计算的直接支配者关系，构建支配树的子节点关系。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 如果A是B的直接支配者，则B是A在支配树上的后继。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_dom_tree_succ</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 遍历所有基本块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">block</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">idom</span> <span class="o">=</span> <span class="n">get_idom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">idom</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">idom</span><span class="p">)</span> <span class="o">!=</span> <span class="n">idom_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 检查直接支配者是否已经在 dom_tree_succ_blocks_ 中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">dom_tree_succ_blocks_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">idom</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dom_tree_succ_blocks_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">dom_tree_succ_blocks_</span><span class="p">[</span><span class="n">idom</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">dom_tree_succ_blocks_</span><span class="p">[</span><span class="n">idom</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">&amp;</span><span class="n">block</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 为支配树创建深度优先搜索序
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要处理的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数通过深度优先搜索遍历支配树，为每个基本块分配两个序号：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. dom_tree_L_：记录DFS首次访问该节点的时间戳
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. dom_tree_R_：记录DFS完成访问该节点子树的时间戳
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 同时维护：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - dom_dfs_order_：按DFS访问顺序记录基本块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - dom_post_order_：dom_dfs_order_的逆序
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 这些序号和顺序可用于快速判断支配关系：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 如果节点A支配节点B，则A的L值小于B的L值，且A的R值大于B的R值
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">create_dom_dfs_order</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析得到 f 中各个基本块的支配树上的dfs序L,R
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_tree_L_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">succ</span> <span class="p">:</span> <span class="n">dom_tree_succ_blocks_</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dfs</span><span class="p">(</span><span class="n">succ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">dom_tree_R_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">dfs</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">dom_post_order_</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">(</span><span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">rbegin</span><span class="p">(),</span> <span class="n">dom_dfs_order_</span><span class="p">.</span><span class="n">rend</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 打印函数的直接支配关系
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要打印的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数以可读格式打印函数中所有基本块的直接支配者(immediate dominator)。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 输出格式为：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 基本块名: 其直接支配者名
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 如果基本块没有直接支配者(如入口块)，则显示&#34;null&#34;。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">print_idom</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">bb_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;bb&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Immediate dominance of function %s:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">get_idom</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">get_idom</span><span class="p">(</span><span class="n">bb</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="s">&#34;null&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 打印函数的支配边界信息
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要打印的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数以可读格式打印函数中所有基本块的支配边界(dominance frontier)。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 输出格式为：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 基本块名: 支配边界中的基本块列表
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 如果基本块没有支配边界，则显示&#34;null&#34;。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">print_dominance_frontier</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">bb_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;bb&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Dominance Frontier of function %s:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">get_dominance_frontier</span><span class="p">(</span><span class="n">bb</span><span class="p">).</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="s">&#34;null&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">df</span> <span class="p">:</span> <span class="n">get_dominance_frontier</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">output</span> <span class="o">+=</span> <span class="s">&#34;, &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">output</span> <span class="o">+=</span> <span class="n">bb_id</span><span class="p">[</span><span class="n">df</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 将函数的控制流图(CFG)导出为图形文件
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要导出的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数生成函数的控制流图的DOT格式描述，并使用graphviz将其转换为PNG图像。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 生成两个文件：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {函数名}_cfg.dot：DOT格式的图形描述
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {函数名}_cfg.png：可视化的控制流图
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">dump_cfg</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">edge_set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">succ_blocks</span> <span class="o">=</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_succ_basic_blocks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">succ_blocks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">succ</span> <span class="p">:</span> <span class="n">succ_blocks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_set</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;-&gt;&#34;</span> <span class="o">+</span> <span class="n">succ</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">digraph</span> <span class="o">=</span> <span class="s">&#34;digraph G {</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_edges</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果没有边且至少有一个基本块，添加一个自环以显示唯一的基本块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="o">&amp;</span><span class="n">bb</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">digraph</span> <span class="o">+=</span> <span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">edge</span> <span class="p">:</span> <span class="n">edge_set</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">digraph</span> <span class="o">+=</span> <span class="n">edge</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">digraph</span> <span class="o">+=</span> <span class="s">&#34;}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">file_output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_cfg.dot&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span> <span class="o">&lt;&lt;</span> <span class="n">digraph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dot_cmd</span> <span class="o">=</span> <span class="s">&#34;dot -Tpng &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_cfg.dot&#34;</span> <span class="o">+</span> <span class="s">&#34; -o &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_cfg.png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">system</span><span class="p">(</span><span class="n">dot_cmd</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 将函数的支配树导出为图形文件
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要导出的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数生成函数的支配树的DOT格式描述，并使用graphviz将其转换为PNG图像。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 生成两个文件：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {函数名}_dom_tree.dot：DOT格式的图形描述
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - {函数名}_dom_tree.png：可视化的支配树
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Dominators</span><span class="o">::</span><span class="n">dump_dominator_tree</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">edge_set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 用于检查是否有边存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">b</span> <span class="p">:</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">idom_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">idom_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">idom_</span><span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">]</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_set</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">idom_</span><span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;-&gt;&#34;</span> <span class="o">+</span> <span class="n">b</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_edges</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// 如果存在支配边，标记为 true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">digraph</span> <span class="o">=</span> <span class="s">&#34;digraph G {</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_edges</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果没有边且至少有一个基本块，直接添加该块以显示它
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="o">&amp;</span><span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">digraph</span> <span class="o">+=</span> <span class="sc">&#39;\t&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">edge</span> <span class="p">:</span> <span class="n">edge_set</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">digraph</span> <span class="o">+=</span> <span class="n">edge</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">digraph</span> <span class="o">+=</span> <span class="s">&#34;}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">file_output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_dom_tree.dot&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span> <span class="o">&lt;&lt;</span> <span class="n">digraph</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_output</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dot_cmd</span> <span class="o">=</span> <span class="s">&#34;dot -Tpng &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_dom_tree.dot&#34;</span> <span class="o">+</span> <span class="s">&#34; -o &#34;</span> <span class="o">+</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;_dom_tree.png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">system</span><span class="p">(</span><span class="n">dot_cmd</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MEM2REG：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Mem2Reg.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;IRBuilder.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Instruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Value.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief Mem2Reg Pass的主入口函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数执行内存到寄存器的提升过程，将栈上的局部变量提升到SSA格式。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 主要步骤：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 创建并运行支配树分析
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 对每个非声明函数：
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 清空相关数据结构
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 插入必要的phi指令
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 执行变量重命名
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 注意：函数执行后，冗余的局部变量分配指令将由后续的死代码删除Pass处理
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Mem2Reg</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建支配树分析 Pass 的实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dominators_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Dominators</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 建立支配树
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 以函数为单元遍历实现 Mem2Reg 算法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">f</span> <span class="p">:</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">func_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_val_stack</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">phi_lval</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">func_</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">().</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 对应伪代码中 phi 指令插入的阶段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">generate_phi</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 对应伪代码中重命名阶段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">rename</span><span class="p">(</span><span class="n">func_</span><span class="o">-&gt;</span><span class="n">get_entry_block</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 后续 DeadCode 将移除冗余的局部变量的分配空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 在必要的位置插入phi指令
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数实现了经典的phi节点插入算法：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 收集全局活跃变量：
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 扫描所有store指令
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 识别在多个基本块中被赋值的变量
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 插入phi指令：
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 对每个全局活跃变量
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 在其定值点的支配边界处插入phi指令
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 使用工作表法处理迭代式的phi插入
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * phi指令的插入遵循最小化原则，只在必要的位置插入phi节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Mem2Reg</span><span class="o">::</span><span class="n">generate_phi</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// global_live_var_name 是全局名字集合，以 alloca 出的局部变量来统计。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 步骤一：找到活跃在多个 block 的全局名字集合，以及它们所属的 bb 块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">global_live_var_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;&gt;</span> <span class="n">live_var_2blocks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">func_</span><span class="o">-&gt;</span><span class="n">get_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">var_is_killed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">instr</span> <span class="p">:</span> <span class="n">bb</span><span class="p">.</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">is_store</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// store i32 a, i32 *b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// a is r_val, b is l_val
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">auto</span> <span class="n">l_val</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">l_val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">global_live_var_name</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">l_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">live_var_2blocks</span><span class="p">[</span><span class="n">l_val</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 步骤二：从支配树获取支配边界信息，并在对应位置插入 phi 指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="p">,</span> <span class="n">Value</span> <span class="o">*&gt;</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb_has_var_phi</span><span class="p">;</span> <span class="c1">// bb has phi for var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">var</span> <span class="p">:</span> <span class="n">global_live_var_name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="n">work_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">work_list</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">live_var_2blocks</span><span class="p">[</span><span class="n">var</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                         <span class="n">live_var_2blocks</span><span class="p">[</span><span class="n">var</span><span class="p">].</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">work_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">work_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bb_dominance_frontier_bb</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">                 <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">get_dominance_frontier</span><span class="p">(</span><span class="n">bb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">bb_has_var_phi</span><span class="p">.</span><span class="n">find</span><span class="p">({</span><span class="n">bb_dominance_frontier_bb</span><span class="p">,</span> <span class="n">var</span><span class="p">})</span> <span class="o">==</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bb_has_var_phi</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// generate phi for bb_dominance_frontier_bb &amp; add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// bb_dominance_frontier_bb to work list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">auto</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">PhiInst</span><span class="o">::</span><span class="n">create_phi</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">var</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_pointer_element_type</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">bb_dominance_frontier_bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_lval</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bb_dominance_frontier_bb</span><span class="o">-&gt;</span><span class="n">add_instr_begin</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">work_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bb_dominance_frontier_bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bb_has_var_phi</span><span class="p">[{</span><span class="n">bb_dominance_frontier_bb</span><span class="p">,</span> <span class="n">var</span><span class="p">}]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Mem2Reg</span><span class="o">::</span><span class="n">rename</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span> <span class="o">*&gt;</span> <span class="n">wait_delete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 步骤一：将 phi 指令作为 lval 的最新定值，lval 即是为局部变量 alloca 出的地址空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">phi_inst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">phi_inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">load</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">loadinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">loadinst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Value</span><span class="o">*</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">loadinst</span><span class="o">-&gt;</span><span class="n">replace_all_use_with</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait_delete</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">loadinst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">storeinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">storeinst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">storeinst</span><span class="o">-&gt;</span><span class="n">get_rval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait_delete</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">storeinst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 步骤二：用 lval 最新的定值替代对应的load指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 步骤三：将 store 指令的 rval，也即被存入内存的值，作为 lval 的最新定值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 步骤四：为 lval 对应的 phi 指令参数补充完整
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">succ</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_succ_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">succ</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">phi</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">Value</span> <span class="o">*</span><span class="n">rval</span> <span class="o">=</span> <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="n">phi</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 步骤五：对 bb 在支配树上的所有后继节点，递归执行 rename 操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">dom_succ_blocks</span> <span class="o">=</span> <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">get_dom_tree_succ_blocks</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom_succ_blocks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">succ</span> <span class="p">:</span> <span class="n">dom_succ_blocks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rename</span><span class="p">(</span><span class="n">succ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 步骤六：pop出 lval 的最新定值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">storeinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">storeinst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">phiinst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">phiinst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">phi_lval</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ptr</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="n">var_val_stack</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">var_val_stack</span><span class="p">[</span><span class="n">lval</span><span class="p">].</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">instr</span> <span class="p">:</span> <span class="n">wait_delete</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb</span><span class="o">-&gt;</span><span class="n">erase_instr</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="循环不变量外提">循环不变量外提
</h2><p>循环检测：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;LoopDetection.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Dominators.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 循环检测Pass的主入口函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数执行以下步骤：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 创建支配树分析实例
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 遍历模块中的所有函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. 对每个非声明函数执行循环检测
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 4. 最后打印检测结果
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dominators_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Dominators</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">f1</span> <span class="p">:</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">get_functions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_declaration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">func_</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_on_func</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 发现循环及其子循环
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param bb 循环的header块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param latches 循环的回边终点(latch)集合
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loop 当前正在处理的循环对象
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">discover_loop_and_sub_loops</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">BBset</span> <span class="o">&amp;</span><span class="n">latches</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO List:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1. 初始化工作表，将所有latch块加入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. 实现主循环逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3. 处理未分配给任何循环的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 4. 处理已属于其他循环的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 5. 建立正确的循环嵌套关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">BBvec</span> <span class="n">work_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">latches</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">latches</span><span class="p">.</span><span class="n">end</span><span class="p">()};</span> <span class="c1">// 初始化工作表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">work_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// 当工作表非空时继续处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">work_list</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">work_list</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO-1: 处理未分配给任何循环的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">bb_to_loop_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="n">bb_to_loop_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* 在此添加代码：
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 1. 使用loop-&gt;add_block将bb加入当前循环
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 2. 更新bb_to_loop_映射
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 3. 将bb的所有前驱加入工作表
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span>
</span></span><span class="line"><span class="cl">            <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_block</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">work_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// throw std::runtime_error(&#34;Lab4: 你有一个TODO需要完成！&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO-2: 处理已属于其他循环的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">!=</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* 在此添加代码：
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 1. 获取bb当前所属的循环sub_loop
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 2. 找到sub_loop的最顶层父循环
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 3. 检查是否需要继续处理
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 4. 建立循环嵌套关系：
</span></span></span><span class="line"><span class="cl"><span class="cm">             *    - 设置父循环
</span></span></span><span class="line"><span class="cl"><span class="cm">             *    - 添加子循环
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 5. 将子循环的所有基本快加入到父循环中
</span></span></span><span class="line"><span class="cl"><span class="cm">             * 6. 将子循环header的前驱加入工作表
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">sub_loop</span> <span class="o">=</span> <span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">parent_loop</span> <span class="o">=</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 找到最顶层的父循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">while</span> <span class="p">(</span><span class="n">parent_loop</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">parent_loop</span> <span class="o">!=</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">sub_loop</span> <span class="o">=</span> <span class="n">parent_loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parent_loop</span> <span class="o">=</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果当前循环不是最顶层父循环，则建立嵌套关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">parent_loop</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">set_parent</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_sub_loop</span><span class="p">(</span><span class="n">sub_loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">block</span> <span class="p">:</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">work_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// throw std::runtime_error(&#34;Lab4: 你有一个TODO需要完成！&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 对单个函数执行循环检测
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param f 要分析的函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 该函数通过以下步骤检测循环：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 运行支配树分析
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 按支配树后序遍历所有基本块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. 对每个块，检查其前驱是否存在回边
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 4. 如果存在回边，创建新的循环并：
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 设置循环header
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 添加latch节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    - 发现循环体和子循环
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">run_on_func</span><span class="p">(</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">run_on_func</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb1</span> <span class="p">:</span> <span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">get_dom_post_order</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">bb1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">BBset</span> <span class="n">latches</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">pred</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">dominators_</span><span class="o">-&gt;</span><span class="n">is_dominate</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">pred</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// pred is a back edge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// pred -&gt; bb , pred is the latch node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">latches</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">latches</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// create loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb_to_loop_</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// add latch nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">latch</span> <span class="p">:</span> <span class="n">latches</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">loop</span><span class="o">-&gt;</span><span class="n">add_latch</span><span class="p">(</span><span class="n">latch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">loops_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">discover_loop_and_sub_loops</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">latches</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 打印循环检测的结果
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 为每个检测到的循环打印：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 循环的header块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 循环包含的所有基本块
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. 循环的所有子循环
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopDetection</span><span class="o">::</span><span class="n">print</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_</span><span class="o">-&gt;</span><span class="n">set_print_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loop Detection Result:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">loop</span> <span class="p">:</span> <span class="n">loops_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loop header: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loop blocks: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Sub loops: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">sub_loop</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_sub_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>外提循环不变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;BasicBlock.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Constant.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;FuncInfo.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Function.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;GlobalVariable.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Instruction.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;LICM.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;PassManager.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;logging.hpp&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 循环不变式外提Pass的主入口函数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">label_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">loop_detection_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">LoopDetection</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop_detection_</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_info_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">FuncInfo</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_info_</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">loop</span> <span class="p">:</span> <span class="n">loop_detection_</span><span class="o">-&gt;</span><span class="n">get_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">is_loop_done_</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">loop</span> <span class="p">:</span> <span class="n">loop_detection_</span><span class="o">-&gt;</span><span class="n">get_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">traverse_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 遍历循环及其子循环
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loop 当前要处理的循环
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">traverse_loop</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_loop_done_</span><span class="p">[</span><span class="n">loop</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_loop_done_</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">sub_loop</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_sub_loops</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">traverse_loop</span><span class="p">(</span><span class="n">sub_loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_on_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// TODO: 实现collect_loop_info函数
</span></span></span><span class="line"><span class="cl"><span class="c1">// 1. 遍历当前循环及其子循环的所有指令
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. 收集所有指令到loop_instructions中
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3. 检查store指令是否修改了全局变量，如果是则添加到updated_global中
</span></span></span><span class="line"><span class="cl"><span class="c1">// 4. 检查是否包含非纯函数调用，如果有则设置contains_impure_call为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">collect_loop_info</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">loop_instructions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">updated_global</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="o">&amp;</span><span class="n">contains_impure_call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">sub_loops</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_sub_loops</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">loop_instructions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;store_inst: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">inst</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">store_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//左值是地址，右值是值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">auto</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">store_inst</span><span class="o">-&gt;</span><span class="n">get_rval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;add gloabl&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">updated_global</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span><span class="p">(</span><span class="n">func_info_</span><span class="o">-&gt;</span><span class="n">is_pure_function</span><span class="p">(</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;contains_pure_call&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;contains_impure_call&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">sub_loop</span> <span class="p">:</span> <span class="n">sub_loops</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">sub_loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">inst</span> <span class="p">:</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">loop_instructions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;store_inst: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">inst</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">store_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//左值是地址，右值是值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">auto</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">store_inst</span><span class="o">-&gt;</span><span class="n">get_rval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;add gloabl&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">updated_global</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span><span class="p">(</span><span class="n">func_info_</span><span class="o">-&gt;</span><span class="n">is_pure_function</span><span class="p">(</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 对单个循环执行不变式外提优化
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loop 要优化的循环
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LoopInvariantCodeMotion</span><span class="o">::</span><span class="n">run_on_loop</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Loop</span><span class="o">&gt;</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">loop_instructions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">updated_global</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">contains_impure_call</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect_loop_info</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">loop_instructions</span><span class="p">,</span> <span class="n">updated_global</span><span class="p">,</span> <span class="n">contains_impure_call</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">global</span> <span class="p">:</span> <span class="n">updated_global</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;updated_global: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">global</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span> <span class="o">*&gt;</span> <span class="n">loop_invariant</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: 识别循环不变式指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - 如果指令已被标记为不变式则跳过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - 跳过 store、ret、br、phi 等指令与非纯函数调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - 特殊处理全局变量的 load 指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - 检查指令的所有操作数是否都是循环不变的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - 如果有新的不变式被添加则注意更新 changed 标志，继续迭代
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">changed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">inst</span> <span class="p">:</span> <span class="n">loop_instructions</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">loop_invariant</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">instr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Instruction</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">store</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">ret</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">br</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">contains_impure_call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//特殊处理全局变量的load指令，如果是全局变量的load指令，且没有被更新过，则加入循环不变式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">load</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">load_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">lval</span> <span class="o">=</span> <span class="n">load_inst</span><span class="o">-&gt;</span><span class="n">get_lval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;global_lval: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">lval</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">updated_global</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">==</span> <span class="n">updated_global</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;insert global inval &#34;</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">loop_invariant</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//下面对其他的指令进行判断，如果不在循环中则加入循环不变式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//获得操作数，逐个检查是不是常数，是不是循环不变式，在当前循环中是否存在，当前循环找不到的话就是循环不变式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">bool</span> <span class="n">operands_are_invariant</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">operand</span> <span class="p">:</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_operands</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">loop_instructions</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">!=</span> <span class="n">loop_instructions</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">loop_invariant</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">operand</span><span class="p">)</span> <span class="o">==</span> <span class="n">loop_invariant</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//如果操作数都是循环不变式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">//如果有一个不是循环不变式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">operands_are_invariant</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">operands_are_invariant</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">loop_invariant</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//由于是递归分析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//不能用下面的方法，因为这样会导致循环不变式的增加，但是实际上这个循环不变式并不是循环不变式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// bool is_invariant = true;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// for (auto operand : instr-&gt;get_operands()) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     auto it = std::find(loop_invariant.begin(), loop_invariant.end(), operand);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     if (it == loop_invariant.end()) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//         is_invariant = false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//         break;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// if (is_invariant) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     loop_invariant.push_back(inst);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     changed = true;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// throw std::runtime_error(&#34;Lab4: 你有一个TODO需要完成！&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;Loop invariant not done&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">changed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;Loop invariant done&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_preheader</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果没有前置块，则创建一个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;preheader&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">label_num</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">-&gt;</span><span class="n">set_preheader</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">BasicBlock</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">m_</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">loop_invariant</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// insert preheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">preheader</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_preheader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">phi_inst_</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历循环头部的phi指令,如果遇到了非phi指令则退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">phi_inst_</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">phi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;phi_inst_:&#34; &lt;&lt; phi_inst_.print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//检查phi指令中所有非latch的前驱，改为preheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">phi_inst</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">PhiInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phi_inst_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">phi_inst</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// auto num = static_cast&lt;int&gt;(phi_inst-&gt;get_num_operand());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preheader</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//如果有br指令，需要删除,因为后面会重新插入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">preheader</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="o">&amp;</span><span class="n">inst</span> <span class="o">=</span> <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">().</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">br</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">remove_instr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//如果原本不存在preheader，即是创建的空的preheader,此时需要在preheader处插入一个新的phi指令用于替换，同时将原phi指令的前驱改为preheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// preheader-&gt;add_instruction(phi_inst);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">new_phi</span> <span class="o">=</span> <span class="n">PhiInst</span><span class="o">::</span><span class="n">create_phi</span><span class="p">(</span><span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">(),</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">add_instruction</span><span class="p">(</span><span class="n">new_phi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(INFO) &lt;&lt; &#34;preheader&#34; &lt;&lt; preheader-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">val_bbs</span> <span class="o">=</span> <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">get_phi_pairs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">remove_all_operands</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(INFO) &lt;&lt; &#34;BEFORE phi——new: &#34; &lt;&lt; new_phi-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// LOG(INFO) &lt;&lt; &#34;BEFORE phi: &#34; &lt;&lt; phi_inst-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">val_bb</span> <span class="p">:</span> <span class="n">val_bbs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val_bb</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">val_new</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">val_bb</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(INFO) &lt;&lt; &#34;bb: &#34; &lt;&lt; bb-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">().</span><span class="n">begin</span><span class="p">(),</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">().</span><span class="n">end</span><span class="p">(),</span> <span class="n">bb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">().</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_phi</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val_new</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val_new</span><span class="p">,</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_phi</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">phi_inst</span><span class="o">-&gt;</span><span class="n">add_phi_pair_operand</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: 用跳转指令重构控制流图 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 将所有非 latch 的 header 前驱块的跳转指向 preheader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 并将 preheader 的跳转指向 header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 注意这里需要更新前驱块的后继和后继的前驱
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="n">pred_to_remove</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">latches_1</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_latches</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">header</span> <span class="o">=</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">get_pre_basic_blocks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">pred</span> <span class="p">:</span> <span class="n">preds</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">preheader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error: pred is nullptr&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latches_1</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">latches_1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">latches_1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">pred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">latches_1</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建跳转指令重构控制流图
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pred</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// LOG(INFO) &lt;&lt; &#34;chongjian&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="o">&amp;</span><span class="n">br_before</span> <span class="o">=</span> <span class="n">pred</span><span class="o">-&gt;</span><span class="n">get_instructions</span><span class="p">().</span><span class="n">back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">br_before</span><span class="p">.</span><span class="n">get_instr_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">br</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">br_11</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">br_before</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(INFO) &lt;&lt; &#34;br_11&#34; &lt;&lt; br_11-&gt;print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">pred</span><span class="o">-&gt;</span><span class="n">remove_instr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">br_before</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// LOG(DEBUG) &lt;&lt; &#34;remove_instr_2: &#34; &lt;&lt; br_before.print();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">br_11</span><span class="o">-&gt;</span><span class="n">is_cond_br</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">auto</span> <span class="n">br_cond</span> <span class="o">=</span> <span class="n">br_11</span><span class="o">-&gt;</span><span class="n">get_condition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">auto</span> <span class="n">false_bb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">br_11</span><span class="o">-&gt;</span><span class="n">get_operand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BranchInst</span><span class="o">::</span><span class="n">create_cond_br</span><span class="p">(</span><span class="n">br_cond</span><span class="p">,</span> <span class="n">preheader</span><span class="p">,</span> <span class="n">false_bb</span><span class="p">,</span> <span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BranchInst</span><span class="o">::</span><span class="n">create_br</span><span class="p">(</span><span class="n">preheader</span><span class="p">,</span> <span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred_to_remove</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>     
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">header</span><span class="o">-&gt;</span><span class="n">add_pre_basic_block</span><span class="p">(</span><span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">add_succ_basic_block</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">pred</span> <span class="p">:</span> <span class="n">pred_to_remove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">remove_pre_basic_block</span><span class="p">(</span><span class="n">pred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: 外提循环不变指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// throw std::runtime_error(&#34;Lab4: 你有一个TODO需要完成！&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">inst</span> <span class="p">:</span> <span class="n">loop_invariant</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;loop_invariant: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">instr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Instruction</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">instr</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">preheader</span><span class="o">-&gt;</span><span class="n">is_terminated</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历基本块，找到instr所在的基本块,并将instr从原基本块中删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bb</span> <span class="p">:</span> <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_blocks</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span> <span class="o">==</span> <span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bb</span><span class="o">-&gt;</span><span class="n">remove_instr</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;remove_instr_1: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">preheader</span><span class="o">-&gt;</span><span class="n">add_instruction</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// insert preheader br to header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BranchInst</span><span class="o">::</span><span class="n">create_br</span><span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">(),</span> <span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// insert preheader to parent loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">-&gt;</span><span class="n">get_parent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_block</span><span class="p">(</span><span class="n">preheader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/compiler-review/">
        
        
            <div class="article-image">
                
                    <img src="/post/001.png" loading="lazy" data-key="compiler-review" data-hash="/post/001.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">编译原理知识复习</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <link
rel="stylesheet"
href="https://unpkg.com/@waline/client@v3/dist/waline.css"
/>

<div id="waline" class="waline-container"></div>

<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
       color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

    init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili","https://npm.elemecdn.com/@waline/emojis@1.1.0/bmoji","https://npm.elemecdn.com/@waline/emojis@1.1.0/weibo"],"lang":"zh-CN","locale":{"admin":"站长","placeholder":"还没有人评论哦！快来抢沙发吧~"},"placeholder":"欢迎留下宝贵的评论！","requiredMeta":["name","email","url"],"serverURL":"https://wilinetest-qw2k7t4q4-zhuyh1139s-projects.vercel.app/","visitor":true});
  </script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 Example Person
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.05855e03984e0c21563e042e67eb3d1dbf10a0e7f128d98ef596b3fcb29bf3fa.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script>
  const cdnPath = 'https://cdn.jsdelivr.net/gh/letere-gzj/live2d-widget-v3@main';
  const config = {
    
    path: {
      modelPath: cdnPath + "/Resources/",
      cssPath: cdnPath + "/waifu.css",
      tipsJsonPath: cdnPath + "/waifu-tips.json",
      tipsJsPath: cdnPath + "/waifu-tips.js",
      live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
      live2dSdkPath: cdnPath + "/live2d-sdk.js"
    },
    
    tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "info", "quit"],
    
    drag: {
      enable: true,
      direction: ["x", "y"]
    },
    
    switchType: "order"
  }

  
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      initWidget({
        waifuPath: config.path.tipsJsonPath,
        cdnPath: config.path.modelPath,
        tools: config.tools,
        dragEnable: config.drag.enable,
        dragDirection: config.drag.direction,
        switchType: config.switchType
      });
    });
  }

  
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      }
      else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => resolve(url);
        tag.onerror = () => reject(url);
        document.head.appendChild(tag);
      }
    });
  }
</script>
<script src=http://localhost:1313/background/sakura.js></script>



<style>
  #TableOfContents > ul, ol {
      ul, ol {
          display: none;
      }
      .open {
          display: block;
      }
  }
</style>

<script>
  function initTocHide() {
      
      let toc = document.querySelector(".widget--toc");
      if (!toc) {
          return;
      }
      
      window.addEventListener('scroll', function() {
          
          let openUl = document.querySelectorAll(".open");
          if (openUl.length > 0) {
            openUl.forEach((ul) => {
              ul.classList.remove("open")
            })
          }
          
          let currentLi = document.querySelector(".active-class");
          if (!currentLi) {
              return
          }
          
          if (currentLi.children.length > 1) {
              currentLi.children[1].classList.add("open")
          }
          
          let ul = currentLi.parentElement;
          do {
              ul.classList.add("open");
              ul = ul.parentElement.parentElement
          } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
      });
  }
  initTocHide()
</script>


<style>
  #backTopBtn {
      display: none;
      position: fixed;
      bottom: 30px;
      z-index: 99;
      cursor: pointer;
      width: 30px;
      height: 30px;
      background-image: url(http://localhost:1313/icons/backTop.svg);
  }
</style>

<script>
  

  function initScrollTop() {
      let rightSideBar = document.querySelector(".right-sidebar");
      if (!rightSideBar) {
          return;
      }
      
      let btn = document.createElement("div");
      btn.id = "backTopBtn";
      btn.onclick = backToTop
      rightSideBar.appendChild(btn)
      
      window.onscroll = function() {
          
          if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
              btn.style.display = "block";
          } else {
              btn.style.display = "none";
          }
      };
  }

  

  function backToTop(){
      window.scrollTo({ top: 0, behavior: "smooth" })
  }

  initScrollTop();
</script>

<style>
  .highlight {
       
      max-height: 400px;
      overflow: hidden;
  }

  .code-show {
      max-height: none !important;
  }

  .code-more-box {
      width: 100%;
      padding-top: 78px;
      background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(#fff));
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
  }

  .code-more-btn {
      display: block;
      margin: auto;
      width: 44px;
      height: 22px;
      background: #f0f0f5;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      padding-top: 6px;
      cursor: pointer;
  }

  .code-more-img {
      cursor: pointer !important;
      display: block;
      margin: auto;
      width: 22px;
      height: 16px;
  }
</style>

<script>
function initCodeMoreBox() {
  let codeBlocks = document.querySelectorAll(".highlight");
  if (!codeBlocks) {
    return;
  }
  codeBlocks.forEach(codeBlock => {
    
    if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
      return;
    }
    
    
    let codeMoreBox = document.createElement('div');
    codeMoreBox.classList.add('code-more-box');
    
    let codeMoreBtn = document.createElement('span');
    codeMoreBtn.classList.add('code-more-btn');
    codeMoreBtn.addEventListener('click', () => {
      codeBlock.classList.add('code-show');
      codeMoreBox.style.display = 'none';
    })
    
    let img = document.createElement('img');
    img.classList.add('code-more-img');
    img.src = "http://localhost:1313/icons/codeMore.png"
    
    codeMoreBtn.appendChild(img);
    codeMoreBox.appendChild(codeMoreBtn);
    codeBlock.appendChild(codeMoreBox)
  })
}

initCodeMoreBox();
</script>

    </body>
</html>
